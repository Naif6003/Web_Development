(function(){define("modules/clean/comments/annotation_utils",["modules/clean/annotations/annotation","modules/core/exception"],function(t,e){var n,o,i,s,r,a,l,c,u,d,p,h,m;return l=t.Annotation,d=e.assert,i=120,r=10,s=75,a=320,o=10,n=28,c=38,u=2,m=function(t,e){var n,o,i,s;return n=t.getBoundingBox(),o=window.getComputedStyle(e),s=o.width,i=o.height,n.top>=i||n.left>=s||n.right<0||n.bottom<0},p=function(t,e){var c,p,h,m,_,f,v,y,g,b,C,w,T,S,A,E,N,I,x,P,k,M;P=e.getBoundingClientRect(),M=P.width,k=P.height,b=function(t,e,n){return null==e&&(e=null),null==n&&(n=null),d(null!==e||null!==n,"doesBubbleFitOnScreen needs a top or bottom value"),n&&(e=-n-i),t>=0&&M-a>t&&e>=0&&k-i>e},C=function(t,e){return"down"===e?k-t-s:-t-r},S=0,T=0,t.isImageAnnotation()&&(S=P.top+document.body.scrollTop,T=P.left+document.body.scrollLeft),c=t.getClampedBoundingBox(M,k,T,S),p=l.getCenterPosition(c),h=c.bottom-c.top,g={up:c.top*u,down:k-c.bottom,left:c.left,right:M-c.right},w=0,A="up";for(y in g)E=g[y],E>w&&(A=y,w=E);return"up"===A&&(_=p.x-a/2,v=-c.bottom+h+o,m="bottom",b(_,null,v))?[m,{x:_,y:v},C(v,"up")]:"down"===A&&(_=p.x-a/2,f=c.bottom+o,m="top",b(_,f))?[m,{x:_,y:f},C(f,"down")]:(g.left>g.right?(m="right",_=c.left-a-o):(m="left",_=c.right+o),x="down",N=k-c.top,I=c.bottom,I>N&&(x="up"),"down"===x&&a>N&&I>N&&(x="up"),"down"===x&&(m+="-top",f=p.y-n,f=Math.max(0,f),b(_,f))?[m,{x:_,y:f},C(f,"down")]:(m+="-bottom",v=-p.y-n,v=Math.max(-k+1,v),b(_,null,v)?[m,{x:_,y:v},C(v,"up")]:(_=p.x-a/2,f=p.y+o,b(_,f)?["top",{x:_,y:f},C(f,"down")]:(f=o,b(_,f)?["top",{x:_,y:f},C(f,"down")]:(_=0,f=o,b(_,f)?["top",{x:_,y:f},C(f,"down")]:[null,{x:null,y:null},null])))))},h=function(t,e,n){var o,s,r;switch(o=0,s=0,r=t,t){case"top":o=(a-c)/2;break;case"left-top":r="left",s=i/8;break;case"right-top":o=a-c,s=i/8,r="right";break;case"left-bottom":r="left",s=i/8;break;case"right-bottom":o=a-c,s=i/8,r="right";break;case"bottom":o=(a-c)/2}return[r,{x:e+o,y:n+s}]},{isAnnotationOffscreen:m,getBubblePosition:p,getExpandBubblePosition:h}})}).call(this),function(){define("modules/clean/comments/collection_utils",["modules/clean/annotations/annotation","modules/clean/datetime","modules/core/i18n"],function(t,e,n){var o,i,s,r,a,l,c,u,d;return o=t.Annotation,i=n._,l=function(t){var n,o,s,r,a,l,c,u,d;for(r={},u=[],c=Date.now(),a=0,l=t.length;l>a;a++)n=t[a],o=new Date(n.comment.when_mses),s=c-n.comment.when_mses,d=12e4>s?i("Just now"):864e5>s?i("Today"):1728e5>s?i("Yesterday"):e.format_date(o,"MMM d, yyyy"),r[d]?r[d].push(n):(u.push(d),r[d]=[n]);return[u,r]},a=function(t){var e,n,i,s,r,a,l,c;for(i={},l=[],r=0,a=t.length;a>r;r++)n=t[r],s=n.comment.hasMetadata()&&n.comment.comment_metadata.hasAnnotationData(),s&&(e=o.createAnnotationFromDict(n.comment.comment_metadata.annotation),c=e.isImageAnnotation()?1:e.getFirstPdfPage(),i[c]?i[c].push(n):(l.push(c),i[c]=[n]));return l.sort(function(t,e){return t-e}),[l,i]},s=function(t,e){var n,o,i,s,r,a,l,c,u,d;for(null==e&&(e={}),r=null!=e.includeAnnotations?e.includeAnnotations:!0,a=null!=e.includeDocLevel?e.includeDocLevel:!0,l=null!=e.includeNotResolved?e.includeNotResolved:!0,c=null!=e.includeResolved?e.includeResolved:!1,d=null!=e.sortBy?e.sortBy:null,o=[],s=0,u=t.length;u>s;s++)n=t[s],i=n.comment.hasMetadata()&&n.comment.comment_metadata.hasAnnotationData(),!e.includeAnnotations&&i||(a||i)&&(c&&n.comment.resolved&&o.push(n),l&&!n.comment.resolved&&o.push(n));return d&&o.sort(function(t,e){return d(t,e)}),o},r=function(t){var e,n,o,i;for(i=0,n=0,o=t.length;o>n;n++)e=t[n],e.comment.resolved&&i++;return i},d=function(t,e){return t.comment.when_mses-e.comment.when_mses},u=function(t,e){var n,o;return n=t.comment.when_mses,t.comment_activities.length>0&&(n=t.comment_activities[t.comment_activities.length-1].when_mses),o=e.comment.when_mses,e.comment_activities.length>0&&(o=e.comment_activities[e.comment_activities.length-1].when_mses),o-n},c=function(t,e){var n,i,s,r,a,l;return n=o.createAnnotationFromDict(t.comment.comment_metadata.annotation),i=o.createAnnotationFromDict(e.comment.comment_metadata.annotation),s=n.getFirstCoordindates().x,a=n.getFirstCoordindates().y,r=i.getFirstCoordindates().x,l=i.getFirstCoordindates().y,l-a||r-s},{groupCommentActivitiesByTime:l,groupAnnotationActivitiesByPage:a,filterCommentActivities:s,getNumResolved:r,sortByTime:d,sortByReplyTime:u,sortByCoordinates:c}})}.call(this),function(){define("modules/clean/comments/components/file_comments_pane_container",["external/underscore","external/react","external/react-dom","external/reflux","modules/core/exception","modules/clean/comments/action_creators","modules/clean/comments/components/file_preview_annotations","modules/clean/comments/components/file_preview_overlay","modules/clean/comments/components/switch_revision_ui_container","modules/clean/comments/events","modules/clean/comments/flux","modules/clean/comments/more_option_helpers","modules/clean/comments/store","modules/clean/comments/url_handler","modules/clean/comments/utils","modules/clean/event_emitter","modules/clean/file_viewer_interface_controller","modules/clean/react/file_comments/file_comments_pane","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/file_viewer/more_dropdown/more_option_registry"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f,v,y,g){var b,C,w,T,S,A,E;return E=i.assert,A=l.SwitchRevisionUIContainer,C=c.CommentsEventsMixin,w=v.FileCommentsPaneClass,b="annotation-overlay",S="switch-revision-container",T=e.createClass({displayName:"FileCommentsPaneContainer",mixins:[u.sync(p),C],propTypes:{actorId:e.PropTypes.number,context:e.PropTypes.number,contextData:e.PropTypes.string,currentFile:e.PropTypes.object,oref:e.PropTypes.string,previewSelector:e.PropTypes.string.isRequired,shouldInitiallyFocusInput:e.PropTypes.bool,initialCommentsCount:e.PropTypes.number},componentDidMount:function(){return null!=this.props.context&&null!=this.props.contextData&&this.onFileViewerOpen(this.props),this.initAnnotationReadyQueue(),this.initSignUpModalIfNecessary(),s.showOnboardingIfNecessary(),this.updateCommentsMoreOptionGroup(),this.renderSwitchRevisionUI(),this.onCommentsEvent("preview-and-comments-ready",this.onPreviewAndCommentsReady),this.onCommentsEvent("revision-did-change",this.onViewingRevisionDidChange),this.onCommentsEvent("reveal-annotation",this.onRevealAnnotation),this.onCommentsEvent("show-sign-up-modal",this.onShowSignUpModal)},componentWillReceiveProps:function(t){return this.state.viewing.contextData!==t.contextData?this.state.viewing.contextData?this.onFileViewerFlip(t):this.onFileViewerOpen(t):void 0},componentDidUpdate:function(){return this.updateCommentsMoreOptionGroup()},componentWillUnmount:function(){return this.clearAnnotationReadyQueue(),this.removeCommentsMoreOptionGroup(),this.unmountSwitchRevisionUI(),this.onFileViewerClose()},_onViewingFileWillChange:function(t){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),s.startViewingComments({actorId:t.actorId,context:t.context,contextData:t.contextData,oref:t.oref,file:t.currentFile,previewSelector:t.previewSelector,showCommentsOverride:t.shouldInitiallyFocusInput?t.shouldInitiallyFocusInput:null}),this.asyncMountFilePreviewComponents()},onFileViewerOpen:function(t){return this._onViewingFileWillChange(t)},onFileViewerFlip:function(t){return this._onViewingFileWillChange(t),h.onFileViewerFlip()},onFileViewerClose:function(){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),s.stopViewingComments(),h.onFileViewerClose()},onViewingRevisionDidChange:function(){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),this.asyncMountFilePreviewComponents()},onPreviewAndCommentsReady:function(){return E(null!=this.fileViewerInterfaceController,"File viewer interface controller is not initialized"),this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.mountFilePreviewAnnotations(),this.mountFilePreviewOverlay(),this.isAnnotationReady=!0,this.processAnnotationReadyQueue(),h.onPreviewAndCommentsReady()},renderSwitchRevisionUI:function(){return n.render(e.createElement(A),this.getOrCreateSwitchRevisionUIContainerNode())},unmountSwitchRevisionUI:function(){var t;return t=this.getSwitchRevisionUIContainerNode(),null!=t?n.unmountComponentAtNode(t):void 0},getSwitchRevisionUIContainerNode:function(){return document.getElementById(S)},getOrCreateSwitchRevisionUIContainerNode:function(){var t;return t=this.getSwitchRevisionUIContainerNode(),null==t&&(t=document.createElement("div"),t.id=S,document.body.appendChild(t)),t},asyncMountFilePreviewComponents:function(){return this.createFileViewerInterfaceController()},unmountFilePreviewComponents:function(){var t;return this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.destroyFileViewerInterfaceController(),"function"==typeof(t=this.state).unsubscribePreviewAndCommentsReady?t.unsubscribePreviewAndCommentsReady():void 0},mountFilePreviewAnnotations:function(){return this.filePreviewAnnotations=r.create(),this.filePreviewAnnotations.mount(this.fileViewerInterfaceController)},unmountFilePreviewAnnotations:function(){var t;return(null!=(t=this.filePreviewAnnotations)?t.isMounted():void 0)?this.filePreviewAnnotations.unmount():void 0},getOrCreateFilePreviewOverlayContainer:function(t){var e;return e=document.getElementById(b),e||(e=document.createElement("div"),e.id=b,t.appendChild(e)),e},mountFilePreviewOverlay:function(){var t,o;return(o=document.querySelector(this.props.previewSelector))?(this.overlayContainerNode=this.getOrCreateFilePreviewOverlayContainer(o),t=e.createElement(a,{previewContainer:o}),n.render(t,this.overlayContainerNode)):void console.error("Preview container does not exist!")},unmountFilePreviewOverlay:function(){return this.overlayContainerNode?n.unmountComponentAtNode(this.overlayContainerNode):void 0},createFileViewerInterfaceController:function(){var t,e,n;return n=p.state.viewing,t=n.context,e=n.file,this.fileViewerInterfaceController=new f(t,m.getPreviewType(t,e.preview_type),this.props.previewSelector),this.fileViewerInterfaceController.on("page-rendered",function(t){return function(e){var n;return n=null!=(null!=e?e.page:void 0),!n||n&&!t.state.isPreviewReady&&!(null!=e?e.isFullscreen:void 0)?s.notifyPreviewReady():void 0}}(this)),this.fileViewerInterfaceController.dispatchEvent("file-feedback-ui-ready")},destroyFileViewerInterfaceController:function(){var t;return null!=(t=this.fileViewerInterfaceController)?t.destroy():void 0},initAnnotationReadyQueue:function(){return this.annotationReadyQueue=new _},clearAnnotationReadyQueue:function(){return this.annotationReadyQueue.removeAllListeners()},processAnnotationReadyQueue:function(){return this.annotationReadyQueue.emit("reveal-annotation")},onRevealAnnotation:function(e){return this.isAnnotationReady?this.doRevealAnnotation(e):(this.annotationReadyQueue.removeAllListeners("reveal-annotation"),this.annotationReadyQueue.once("reveal-annotation",t.partial(this.doRevealAnnotation,e)))},doRevealAnnotation:function(t){return this.fileViewerInterfaceController.dispatchEvent("scroll-to-annotation",t)},onShowSignUpModal:function(t){var e,n;return e=t.fileActivityKey,n=t.variant,E(null!=this.signUpModal,"Sign-up modal not initialized!"),this.signUpModal.set_activity_key(e),this.signUpModal.show_sign_in_modal(n)},initSignUpModalIfNecessary:function(){return m.getActivityUser(this.state.actorId).is_signed_in?void 0:this.signUpModal=new y},_getRelevantStoreState:function(){return{isFileActivityReady:p.isFileActivityReady(),isCommentingEnabled:p.isCommentingEnabled(),isUserSubscribed:p.isUserSubscribed(this.props.actorId),showResolvedComments:p.state.showResolvedComments,canEnableComments:p.canEnableComments()}},updateCommentsMoreOptionGroup:function(){var t;if(!m.useLegacyCommentsToggle(this.state.isReactViewer))return t=d.generateMoreOptionGroup(this._getRelevantStoreState(),this.props),null==t?this.removeCommentsMoreOptionGroup():null==this._moreOptionGroup?g.addOption(t):g.replaceOption(this._moreOptionGroup,t),this._moreOptionGroup=t},removeCommentsMoreOptionGroup:function(){return null!=this._moreOptionGroup?g.removeOption(this._moreOptionGroup):void 0},getInitialCommentsCount:function(){var t,e;return null!=this.props.initialCommentsCount?this.props.initialCommentsCount:null!=(null!=(t=this.props.currentFile)?t.unresolved_comment_count:void 0)?null!=(e=this.props.currentFile)?e.unresolved_comment_count:void 0:null},render:function(){var t,n;return t=this.getInitialCommentsCount(),n=m.useLegacyCommentsToggle(this.state.isReactViewer),e.createElement(w,{ref:"fileCommentsPane",feedbackId:"file-comments",activity:this.state.activity,showLoadingSpinner:0!==t&&this.state.showLoadingSpinner,context:this.state.viewing.context,contextData:this.state.viewing.contextData,userId:this.state.actorId,file:this.props.currentFile,oref:this.state.oref,isPreviewReady:this.state.isPreviewReady,showResolvedComments:this.state.showResolvedComments,showTutorial:this.state.showTutorial,currentTutorialStep:this.state.currentTutorialStep,isCommentsHidden:n?this.state.isCommentsHidden:p.areCommentsHidden(),canCollapse:!0,enableImport:!1,previewSelector:this.props.previewSelector,shouldAutoLinkify:!0,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldUseSimpleModals:!1,shouldTrackCollapsedState:n,showButtonColor:"white",initialCommentsCount:t,isUserSubscribed:p.isUserSubscribed(this.state.actorId),isRegionCreationEnabled:this.state.regionCreationEnabled})}})})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/comments/components/file_preview_annotations",["external/underscore","modules/constants/comments_panel","modules/constants/legacy","modules/core/exception","modules/clean/annotations/annotation","modules/clean/comments/action_creators","modules/clean/comments/store","modules/clean/comments/revisions","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/clean/react/file_viewer/store","modules/clean/string"],function(e,n,o,i,s,r,a,l,c,u,d,p,h){var m,_,f,v,y,g;return v=i.assert,_=s.Annotation,g=h.lispToPascalCase,m=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","annotation-enter","annotation-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui","mouse-up"],y=n.ALLOW_ANNOTATION_GHOST,f=function(){function n(e){this.prevState=e.prevState,this.state=e.state,this.interfaceController=e.interfaceController,this.onMouseUp=t(this.onMouseUp,this),this.onScroll=t(this.onScroll,this),this.onAnnotationUiLeave=t(this.onAnnotationUiLeave,this),this.onAnnotationUiEnter=t(this.onAnnotationUiEnter,this),this.onAnnotationUiClick=t(this.onAnnotationUiClick,this),this.onAnnotationEndDrag=t(this.onAnnotationEndDrag,this),this.onAnnotationPlaced=t(this.onAnnotationPlaced,this),this.onStateChange=t(this.onStateChange,this)}return n.create=function(){return new n({prevState:{activityKeys:[],hasEphemeral:!1},state:{ephemeralAnnotation:null,commentActivityByKey:{},canAnnotate:!1,regionCreationEnabled:!1,viewingAnnotationConversation:!1},interfaceController:null})},n.prototype.setState=function(t){return e.extend(this.state,t),this.performUpdateIfNecessary()},n.prototype.getStateFromStores=function(){var t,n,o,i,s;return s=a.state.showResolvedComments,n=!1,t=c.shouldShowExistingAnnotations()?a.state.activity.comment_activities.filter(function(t){var e;return t.comment.resolved&&n?!1:null!=(null!=(e=t.comment.comment_metadata)?e.annotation:void 0)}):{},{activityKey:null!=(o=a.state.activity)?o.activity_key:void 0,actorId:a.state.actorId,activityContext:a.state.viewing.context,revision:a.state.viewing.revision,commentActivityByKey:e.indexBy(t,"activity_key"),ephemeralAnnotation:null!=(i=a.state.createAnnotation)?i.annotation:void 0,canAnnotate:c.canAnnotate(),regionCreationEnabled:c.isRegionCreationEnabled(),showResolved:s,viewingAnnotationConversation:null!=a.state.viewAnnotation}},n.prototype.onStateChange=function(){return null!=a.state.activity?this.setState(this.getStateFromStores()):void 0},n.prototype.mount=function(t){return v(null!=t,"Interface controller must not be null"),v(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=t,this.onStateChange(a.state),this.unsubscribeStore=a.listen(this.onStateChange),this.unsubscribeFileViewerStore=p.addListener(this.onStateChange),this.addAnnotationEventListeners(),this.performUpdateIfNecessary()},n.prototype.unmount=function(){return v(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),"function"==typeof this.unsubscribeFileViewerStore&&this.unsubscribeFileViewerStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},n.prototype.isMounted=function(){return null!=this.interfaceController},n.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},n.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},n.prototype.enableRegionCreation=function(){return this.interfaceController.dispatchEvent("enable-region-creation")},n.prototype.disableRegionCreation=function(){return this.interfaceController.dispatchEvent("disable-region-creation")},n.prototype.addAnnotationEventListeners=function(){return m.forEach(function(t){return function(e){var n,o;return o="on"+g(e),n=t[o],null!=n?t.interfaceController.on(e,n):void 0}}(this))},n.prototype.removeAnnotationEventListeners=function(){return m.forEach(function(t){return function(e){var n,o;return o="on"+g(e),n=t[o],null!=n?t.interfaceController.off(e,n):void 0}}(this))},n.prototype.onAnnotationHidden=function(t){return r.stopAnnotationCreation()},n.prototype.onAnnotationPlaced=function(t){var e;return e=_.createAnnotationFromDict(t.annotation),r.startAnnotationCreation({annotation:e}),d.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},n.prototype.onAnnotationStartDrag=function(t){return r.hideAnnotationConversation(),r.hideAnnotationInput()},n.prototype.onAnnotationEndDrag=function(t){var e;return r.hideAnnotationConversation(),e=_.createAnnotationFromDict(t.annotation),r.startAnnotationCreation({annotation:e}),d.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},n.prototype.onAnnotationUiClick=function(t){var e,n;return e=t.commentActivity.activity_key,r.revealAnnotationInPreview(e),r.revealCommentInPane({activityKey:e,expandConversation:!1}),d.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=(n=t.commentActivity)?n.activity_key:void 0,this.state.actorId,this.state.activityContext)},n.prototype.onAnnotationUiEnter=function(t){var e,n;if(null==this.state.ephemeralAnnotation&&(null!=(e=a.state.viewAnnotation)?!e.replyFocused:!0))return r.showAnnotationConversation({activityKey:t.commentActivity.activity_key,annotation:_.createAnnotationFromDict(t.annotation)}),d.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=(n=t.commentActivity)?n.activity_key:void 0,this.state.actorId,this.state.activityContext)},n.prototype.onAnnotationUiLeave=function(t){var e,n;return r.updateAnnotationUiHover(!1),null!=this.state.ephemeralAnnotation||(null!=(n=a.state.viewAnnotation)?n.replyFocused:0)?void 0:(e=function(t){return function(){var e,n;return!t.isMounted()||(null!=(e=a.state.viewAnnotation)?e.conversationHover:void 0)||(null!=(n=a.state.viewAnnotation)?n.annotationHover:void 0)?void 0:r.hideAnnotationConversation()}}(this),window.setTimeout(e,50))},n.prototype.onScaleChange=function(t){return r.stopAnnotationCreation(),r.hideAnnotationConversation()},n.prototype.onScroll=function(t){var n;return r.hideAnnotationInput(),r.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer),n=e.partial(function(t){var e;return null!=(null!=t?t.annotation:void 0)?(e=_.createAnnotationFromDict(t.annotation),r.startAnnotationCreation({annotation:e})):r.showAnnotationInput()},t),this.annotationBubbleTimer=window.setTimeout(n,150)},n.prototype.onOnKeydown=function(t){return c.normalizedKeyCode.apply(t)===u.ESC?r.stopAnnotationCreation():void 0},n.prototype.onMouseUp=function(t){return null!=this.state.viewingAnnotationConversation?r.hideAnnotationConversation():void 0},n.prototype.onResetFileFeedbackUi=function(t){return r.stopAnnotationCreation(),r.hideAnnotationConversation()},n.prototype._savePrevState=function(){var t;return this.prevState={activityKeys:Object.keys(null!=(t=this.state.commentActivityByKey)?t:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate,regionCreationEnabled:this.state.regionCreationEnabled,viewingAnnotationConversation:this.state.viewingAnnotationConversation}},n.prototype._removeAnnotation=function(t){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:t}})},n.prototype._updateAnnotations=function(t){var e,n,o,i,s,r,a,c,u,d;for(o=[],n=0,s=0,c=t.length;c>s;s++)i=t[s],i.comment.hasMetadata()&&i.comment.comment_metadata.hasAnnotationData()&&(n+=1,!this.state.showResolved&&i.comment.resolved||(u=i.comment.comment_metadata,e=u.annotation,d=u.revision,r=l.isRevisionEqual(this.state.revision,d),(y||null!=d&&r)&&(a=y&&null!=d&&!r,o.push({annotation:e,commentActivity:i,options:{isGhostAnnotation:a,isAnnotationNumberingEnabled:!0,annotationNumber:n}}))));return this.interfaceController.dispatchEvent("update-annotations",{annotations:o})},n.prototype.performUpdateIfNecessary=function(){var t,n;if(this.isMounted())return e.isEmpty(this.state.commentActivityByKey)?this.interfaceController.dispatchEvent("remove-all-annotations"):(t=e.difference(null!=(n=this.prevState.activityKeys)?n:[],Object.keys(this.state.commentActivityByKey)),t.forEach(this._removeAnnotation,this),this._updateAnnotations(e.values(this.state.commentActivityByKey))),this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),this.prevState.regionCreationEnabled!==this.state.regionCreationEnabled&&(this.state.regionCreationEnabled?this.enableRegionCreation():this.disableRegionCreation()),this.prevState.viewingAnnotationConversation!==this.state.viewingAnnotationConversation&&(this.state.viewingAnnotationConversation?this.disableRegionCreation():this.state.regionCreationEnabled&&this.enableRegionCreation()),this._savePrevState()},n}()})}.call(this),function(){define("modules/clean/comments/components/file_preview_overlay",["external/underscore","external/react","modules/constants/comments_panel","modules/core/exception","modules/clean/comments/action_creators","modules/clean/comments/annotation_utils","modules/clean/comments/constants","modules/clean/comments/flux","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/react/file_comments/annotation_bubble","modules/clean/react/file_comments/annotation_comments_list_ui_bubble"],function(t,e,n,o,i,s,r,a,l,c,u,d){var p,h,m,_,f,v,y;return p=n.ALLOW_VIEW_ANNOTATE_MODES,_=o.assert,h=r.AnnotationTypes,f=e.DOM,m=e.createClass({displayName:"FilePreviewOverlay",mixins:[e.addons.PureRenderMixin],propTypes:{previewContainer:e.PropTypes.instanceOf(HTMLElement).isRequired,activity:e.PropTypes.object,actorId:e.PropTypes.number,context:e.PropTypes.number.isRequired,useAnnotationCreationExpand:e.PropTypes.bool.isRequired,showCreateBubble:e.PropTypes.bool.isRequired,draftAnnotation:e.PropTypes.object,viewingAnnotation:e.PropTypes.object,viewingAnnotationHover:e.PropTypes.bool.isRequired,viewingCommentActivity:e.PropTypes.object,viewingAnnotationReplyDraft:e.PropTypes.string},getInitialState:function(){return{isExpanded:!1}},onConversationExpand:function(){return this.setState({isExpanded:!0})},onMouseEnterAnnotationConversationBubble:function(){return i.updateAnnotationConversationHover(!0)},onMouseLeaveAnnotationConversationBubble:function(){var t;return i.updateAnnotationConversationHover(!1),null!=this.props.draftAnnotation||this.state.isExpanded?void 0:(t=function(t){return function(){return t.isMounted()&&!t.props.viewingAnnotationHover?i.hideAnnotationConversation():void 0}}(this),window.setTimeout(t,50))},maybeRenderAnnotationInputBubble:function(){var n,o,i,r,a,l,d,p,h,m,_,f,v,y,g,b,C;return _=this.props,n=_.activity,o=_.actorId,r=_.context,m=_.previewContainer,l=_.draftAnnotation,d=_.draftAnnotationText,y=_.showCreateBubble,g=_.useAnnotationCreationExpand,null!=l?(i={context:r,activity:n,user:c.getActivityUser(o),shouldShowExpandBubble:g,commentText:d,position:"top",x:0,y:0,showBubble:!1},y&&(p=!s.isAnnotationOffscreen(l,m),p&&(f=s.getBubblePosition(l,m),a=f[0],v=f[1],b=v.x,C=v.y,h=f[2],null!=a&&null!=b&&null!=C))?(t.extend(i,{showBubble:!0,position:a,x:b,y:C,maxHeight:h}),e.createElement(u,i)):e.createElement(u,i)):void 0},maybeRenderAnnotationConversationBubble:function(){var t,n,o,i,r,a,l,u,p,h,m,_,f,v;return l=this.props,n=l.actorId,o=l.context,t=l.activity,a=l.previewContainer,m=l.viewingAnnotationReplyDraft,_=l.viewingCommentActivity,h=l.viewingAnnotation,_&&h&&!s.isAnnotationOffscreen(h,a)&&(u=s.getBubblePosition(h,a),i=u[0],p=u[1],f=p.x,v=p.y,r=u[2],null!=i&&null!=f&&null!=v&&null!=r)?e.createElement(d,{context:o,activity:t,commentActivity:_,user:c.getActivityUser(n),position:i,replyText:m,x:f,y:v,maxHeight:r,onMouseEnter:this.onMouseEnterAnnotationConversationBubble,onMouseLeave:this.onMouseLeaveAnnotationConversationBubble,onConversationExpand:this.onConversationExpand}):void 0},render:function(){return f.div({},this.maybeRenderAnnotationInputBubble(),this.maybeRenderAnnotationConversationBubble())}}),y=function(t){return p&&(null!=t?t.annotation.type:void 0)===h.HIGHLIGHT},v=function(e){var n,o,i,s,r,a;return n=e.activity,s=e.viewAnnotation,o=e.createAnnotation,s&&(a=t.findWhere(n.comment_activities,{activity_key:s.activityKey}),a&&(r=e.annotationReplyTextByKey[a.activity_key])),o&&(i=o.showBubble),{activity:n,actorId:e.actorId,context:e.viewing.context,useAnnotationCreationExpand:y(o),showCreateBubble:!!i,draftAnnotation:null!=o?o.annotation:void 0,draftAnnotationText:e.annotationText,viewingAnnotation:null!=s?s.annotation:void 0,viewingAnnotationHover:!!(null!=s?s.annotationHover:void 0),viewingCommentActivity:a,viewingAnnotationReplyDraft:r}},a.connect(l,v)(m)})}.call(this),define("modules/clean/comments/components/switch_revision_ui_container",["require","exports","external/react","modules/clean/comments/action_creators","modules/clean/comments/flux","modules/clean/comments/revisions","modules/clean/comments/store","modules/clean/react/file_comments/switch_revision_ui"],function(t,e,n,o,i,s,r,a){"use strict";e.SwitchRevisionUIContainer=n.createClass({displayName:"SwitchRevisionUIContainer",mixins:[i.sync(r)],onSwitchToLatestRevision:function(){var t=this.state.activity.latest_revision;o.switchRevision({revision:t})},render:function(){var t=this.state,e=t.activity,o=t.viewing;if(!e)return n.createElement("div",null);var i=e.latest_revision,r=o.revision;return!r||s.isRevisionEqual(r,i)?n.createElement("div",null):n.createElement(a,{revision:r,onSwitchToLatestRevision:this.onSwitchToLatestRevision})}})}),define("modules/clean/comments/lib/animation",["require","exports"],function(t,e){"use strict";e.ANIMATION_ITERATION_EVENT="webkitAnimationIteration mozAnimationIteration MSAnimationIteration OAnimationIteration animationiteration",e.ANIMATION_END_EVENT="webkitAnimationEnd mozAnimationEnd MSAnimationEnd OAnimationEnd animationend"}),define("modules/clean/comments/lib/click_outside",["require","exports","external/react","external/react-dom","modules/clean/react/bubble_dropdown"],function(t,e,n,o,i){"use strict";var s=i.DROPDOWN_ROOT_ID;e.ClickOutside=n.createClass({displayName:"ClickOutside",propTypes:{onClickOutside:n.PropTypes.func},componentDidMount:function(){document.addEventListener("click",this.handleClickOutside,!0)},componentWillUnmount:function(){document.removeEventListener("click",this.handleClickOutside,!0)},getDropdownRoot:function(){return document.getElementById(s)},handleClickOutside:function(t){var e=o.findDOMNode(this),n=this.getDropdownRoot();!this.props.onClickOutside||n&&n.contains(t.target)||e&&e.contains(t.target)||this.props.onClickOutside(t)},render:function(){return this.props.children}})}),function(){define("modules/clean/comments/more_option_helpers",["modules/clean/comments/action_creators","modules/clean/react/file_action_button","modules/clean/react/file_viewer/more_dropdown/models"],function(t,e,n){var o,i,s,r,a,l,c,u,d,p,h,m;return i=e.FileActionButtonType,s=n.MoreOption,r=n.MoreOptionGroup,c=function(){return t.setCommentsEnabled({enabled:!0})},l=function(){return t.setCommentsEnabled({enabled:!1})},h=function(){return t.setCommentSubscribed({subscribed:!0})},m=function(){return t.setCommentSubscribed({subscribed:!1})},u=function(t){var e,n,o;return n=t.isCommentingEnabled,n?(o=i.DISABLE_COMMENTS,e=l):(o=i.ENABLE_COMMENTS,e=c),new s({fileActionButtonType:o,className:"comments-options-item__disable",handler:e})},d=function(e){var n,o,r;return o=e.showResolvedComments,o?(r=i.HIDE_RESOLVED_COMMENTS,n=t.hideResolvedComments):(r=i.SHOW_RESOLVED_COMMENTS,n=t.showResolvedComments),new s({fileActionButtonType:r,handler:n})},p=function(t){var e,n,o;return n=t.isUserSubscribed,n?(o=i.UNSUBSCRIBE,e=m):(o=i.SUBSCRIBE,e=h),new s({fileActionButtonType:o,handler:e})},a=function(t,e){var n;return n=[],t.isFileActivityReady?(t.canEnableComments&&n.push(u(t)),!e.isCollapsed&&t.isCommentingEnabled&&n.push(d(t)),t.isCommentingEnabled&&n.push(p(t)),n):n},o={generateMoreOptionGroup:function(t,e){var n;return n=a(t,e),n.length?new r({options:n}):null}}})}.call(this),define("modules/clean/comments/url_handler",["require","exports","modules/core/browser","modules/clean/comments/action_creators"],function(t,e,n,o){"use strict";function i(){var t=n.get_uri();return t.getQuery().cak}function s(){var t=n.get_uri();t.removeQuery("cak"),window.history.replaceState(null,"",t.toString())}function r(){var t=i();t&&(s(),o.revealCommentInPane({activityKey:t,expandConversation:!0}),o.revealAnnotationInPreview(t))}function a(){s()}function l(){s()}e.onPreviewAndCommentsReady=r,e.onFileViewerFlip=a,e.onFileViewerClose=l}),define("modules/clean/event_handler",["require","exports","jquery"],function(t,e,n){"use strict";function o(t){var n=t.prototype.componentWillMount,o=t.prototype.componentWillUnmount;t.prototype.componentWillMount=function(){e.EventHandlerMixin.componentWillMount.apply(this),n&&"function"==typeof n&&n.apply(this)},t.prototype.componentWillUnmount=function(){o&&"function"==typeof o&&o.apply(this),e.EventHandlerMixin.componentWillUnmount.apply(this)}}e.eventHandler=o,e.EventHandlerMixin={componentWillMount:function(){this.events=new i},componentWillUnmount:function(){this.events.removeAll()}};var i=function(){function t(){}return t.prototype.on=function(t,e,o,i,s){"string"!=typeof o&&(s=i,i=o,o=void 0),s&&(i=n.proxy(i,s)),this.handlers||(this.handlers=[]),t=n(t),o?t.on(e,o,i):t.on(e,i),this.handlers.push({element:t,event:e,selector:o,callback:i})},t.prototype.removeAll=function(){this.handlers&&(this.handlers.forEach(function(t){t.selector?t.element.off(t.event,t.selector,t.callback):t.element.off(t.event,t.callback);
}),this.handlers=null)},t}();e.EventHandler=i}),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/file_viewer_interface_controller",["jquery","modules/clean/comments/models/preview_types","modules/clean/event_emitter","modules/clean/frame_messenger"],function(e,n,o,i){var s;return s=function(){function s(e,i,s){switch(this._handleMessageFromWindow=t(this._handleMessageFromWindow,this),this._handleMessageFromChild=t(this._handleMessageFromChild,this),this._prepareImageInterface=t(this._prepareImageInterface,this),this._preparePdfJsInterface=t(this._preparePdfJsInterface,this),this.dispatchEvent=t(this.dispatchEvent,this),this._notifyEventsTriggered=t(this._notifyEventsTriggered,this),this.registerEventsCallbacks=t(this.registerEventsCallbacks,this),this._eventsHandler=null,this._eventEmitter=new o,this._previewType=i,this._previewSelector=s,this._previewType){case n.PDFJS:this._preparePdfJsInterface(e);break;case n.IMAGE:this._prepareImageInterface()}}return s.prototype.registerEventsCallbacks=function(t){return this._eventsHandler=t},s.prototype._notifyEventsTriggered=function(t,e){return"function"==typeof this._eventsHandler?this._eventsHandler(t,e):void 0},s.prototype.addListener=function(t,e){return this._eventEmitter.on(t,e)},s.prototype.removeListener=function(t,e){return this._eventEmitter.off(t,e)},s.prototype.once=function(t,e){return this._eventEmitter.once(t,e)},s.prototype.on=s.prototype.addListener,s.prototype.off=s.prototype.removeListener,s.prototype.dispatchEvent=function(t,e){switch(this._previewType){case n.PDFJS:return this._frameMessenger.postMessageToChildren(t,e);case n.IMAGE:return window.postMessage(JSON.stringify({action:t,parameters:e}),"*")}},s.prototype.destroy=function(){var t;switch(this._eventEmitter.removeAllListeners(),this._eventsHandler=null,this._previewType){case n.PDFJS:return null!=(t=this._frameMessenger)?t.stopListening():void 0;case n.IMAGE:return window.removeEventListener("message",this._handleMessageFromWindow)}},s.prototype._preparePdfJsInterface=function(t){return this._frameMessenger=new i,this._frameMessenger.configureChildMessaging(this._getIframeQuery(),e.proxy(this._handleMessageFromChild,this),["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","annotation-ui-enter","annotation-ui-over","annotation-ui-leave","annotation-ui-click","annotation-enter","annotation-leave","page-rendered","scroll","scale-change","on-keydown","mouse-up"]),this._frameMessenger.startListening()},s.prototype._prepareImageInterface=function(){return window.addEventListener("message",this._handleMessageFromWindow)},s.prototype._getIframeQuery=function(){return"#pdf-embed-iframe"},s.prototype._handleMessageFromChild=function(t){return this._eventEmitter.emit(t.action,t.parameters),"function"==typeof this._notifyEventsTriggered?this._notifyEventsTriggered(t.action,t.parameters):void 0},s.prototype._handleMessageFromWindow=function(t){var e,n,o;try{o=JSON.parse(t.data)}catch(t){return void(e=t)}return this._eventEmitter.emit(o.action,o.parameters),"function"==typeof this._notifyEventsTriggered?this._notifyEventsTriggered(o.action,o.parameters):void 0},s}()})}.call(this),function(){define("modules/clean/react/activity/annotation_button",["external/react","external/underscore","jquery","modules/clean/datetime","modules/clean/annotations/annotation","modules/clean/image_preview_util","modules/core/i18n"],function(t,e,n,o,i,s,r){var a,l,c,u,d,p,h,m,_,f,v,y,g,b;return l=i.Annotation,h=i.AnnotationTypes,u=i.AnnotationSubtypes,g=r._,b=t.DOM,_=610,m=790,f=28,y=6,v=3,a=120,p=t.createClass({displayName:"AnnotationThumbnail",propTypes:{annotation:t.PropTypes.object,thumbnailUrl:t.PropTypes.string},getDefaultProps:function(){return{}},getInitialState:function(){return{}},_getThumbnail:function(t,e,n){var o;return this.props.thumbnailUrl?this._getThumbnailImageFromUrl():(o=f*e/n,b.div({className:"annotation-thumbnail-page",style:{width:o,height:f}},this._getAnnotationThumbnail(t,e,n,o,f)))},_getAnnotationThumbnail:function(t,n,o,i,s){var r,a,l,c,u,d,p,m,_,f,g,C,w,T,S,A,E,N;switch(r=this.props.annotation,r.type){case h.MARKER:return l=null!=t&&null!=(T=t[0].coordinates)?T[0]:void 0,b.div({className:"annotation-thumbnail-page__marker",style:{left:this._calculateThumbnailDistance(null!=l?l.x:void 0,n,i,y),top:this._calculateThumbnailDistance(null!=l?l.y:void 0,o,s,y)}});case h.HIGHLIGHT:for(A=[],w=r.getFirstPdfPage(),u=0,p=t.length;p>u;u++)c=t[u],c.page===w&&(a=c.coordinates[1].x-c.coordinates[0].x,A.push(b.div({className:"annotation-thumbnail-page__highlight",style:{left:this._calculateThumbnailDistance(c.coordinates[0].x,n,i),top:this._calculateThumbnailDistance(c.coordinates[0].y,o,s,v),width:this._calculateThumbnailDistance(a,n,i)}})));return A;case h.REGION:for(A=[],w=r.getFirstPdfPage(),d=0,m=t.length;m>d;d++)S=t[d],S.page===w&&(E=e.pluck(S.coordinates,"x"),N=e.pluck(S.coordinates,"y"),g=e.min(E),_=e.max(E),C=e.min(N),f=e.max(N),A.push(b.div({className:"annotation-thumbnail-page__region",style:{left:this._calculateThumbnailDistance(g,n,i),top:this._calculateThumbnailDistance(C,o,s),width:this._calculateThumbnailDistance(_-g,n,i),height:Math.abs(this._calculateThumbnailDistance(f,o,s)-this._calculateThumbnailDistance(C,o,s))}})));return A}},_getThumbnailImageFromUrl:function(){return b.div({className:"annotation-thumbnail-image"},b.img({src:this.props.thumbnailUrl}))},_getAnnotationText:function(){var t;return t=this.props.annotation.text_highlight.text,t.length>a&&(t=t.substring(0,a-3)+"..."),'"'+t+'"'},_calculateThumbnailDistance:function(t,e,n,o){var i;return null==o&&(o=0),n-=o,i=o/2,t/e*n+i},_translateCoordinates:function(t,e,n){var o,i,s,r,a,l,c,u,d,p,h;for(d=[],s=0,a=t.length;a>s;s++){for(o=t[s],i=[],u=o.coordinates,r=0,l=u.length;l>r;r++)c=u[r],p=e(c.x),h=n(c.y),i.push({x:p,y:h});d.push({coordinates:i,page:o.page})}return d},render:function(){var t,e,n,o,i,r;return e=this.props.annotation,e.isImageAnnotation()?(t=s.getPreviewImage(),i=t.width(),o=t.height(),n=this._translateCoordinates(e.image_coordinates,function(t){return t*i},function(t){return t*o})):(i=_,o=m,null!=(null!=(r=e.pdf_coordinates)?r[0].page_size:void 0)&&(i=e.pdf_coordinates[0].page_size.width,o=e.pdf_coordinates[0].page_size.height),n=this._translateCoordinates(e.pdf_coordinates,function(t){return t},function(t){return o-t})),this._getThumbnail(n,i,o)}}),d=t.createFactory(p),c=t.createClass({displayName:"AnnotationButton",propTypes:{annotation:t.PropTypes.object,revision:t.PropTypes.object,isOldRevision:t.PropTypes.bool,onAnnotationButtonMouseUp:t.PropTypes.func,thumbnailUrl:t.PropTypes.string},_getAnnotationText:function(){var t;return t=this.props.annotation.text_highlight.text,t.length>a&&(t=t.substring(0,a-3)+"..."),'"'+t+'"'},_getPageText:function(){return this.props.annotation.isPdfAnnotation()?g("Page %(page_number)s").format({page_number:this.props.annotation.getFirstPdfPage()}):this.props.annotation.isImageAnnotation()?g("Annotation"):void 0},_getLabelSubtext:function(){var t,e,n;return null!=this.props.revision.when&&!isNaN(new Date(null!=this.props.revision.when))&&this.props.isOldRevision?(n=o.ago(new Date(1e3*this.props.revision.when)),e=g("on older revision, updated %(time_ago)s").format({time_ago:n})):e=g("on latest revision"),t=this._getPageText(),g("%(page_text)s %(revision_text)s").format({page_text:t,revision_text:e})},onAnnotationButtonMouseUp:function(t){return this.props.onAnnotationButtonMouseUp(t)},render:function(){return b.a({className:"comment-annotation-button",onMouseUp:this.onAnnotationButtonMouseUp},b.div({className:"annotation-page-label"},d({annotation:this.props.annotation,thumbnailUrl:this.props.thumbnailUrl}),b.div({className:"annotation-thumbnail-label"},b.div({className:"annotation-thumbnail-label__page"},g("Go to comment")),b.div({className:"annotation-thumbnail-label__info"},this._getLabelSubtext()))),this.props.annotation.type===h.HIGHLIGHT?b.div({className:"annotation-thumbnail-text"},this._getAnnotationText()):void 0)}}),{AnnotationButtonClass:c,AnnotationThumbnailClass:p}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/comment_activity_ui",["external/classnames","external/react","external/react-dom","external/underscore","modules/clean/annotations/annotation","modules/clean/react/activity/resolve_button","modules/clean/react/activity/time_counter","modules/clean/react/modal","modules/clean/viewer","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/viewer_avatar","modules/clean/sticker_util","modules/clean/comments/action_creators","modules/clean/comments/constants","modules/clean/comments/comment_dom","modules/clean/comments/lib/animation","modules/clean/comments/logging","modules/clean/comments/revisions","modules/clean/event_handler","modules/clean/file_activity/models/file_activity","modules/clean/react/file_comments/live_sticker","modules/clean/react/file_comments/threaded_comment_header","modules/constants/comments_panel","modules/core/exception","modules/core/i18n"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f,v,y,g,b,C,w,T,S,A,E){var N,I,x,P,k,M,R,O,D,L,U,B,F,H,V,q,W,j;return I=s.Annotation,P=s.AnnotationTypes,x=s.AnnotationSubtypes,B=l.SimpleModal,D=_.FileActivityLogEventType,N=v.ANIMATION_END_EVENT,R=b.EventHandlerMixin,O=C.FileActivity,W=A.assert,q=E._,j=n.DOM,L=n.addons.PureRenderMixin,U=n.createFactory(r),H=n.createFactory(a),k=n.createFactory(u),V=n.createFactory(p),F=n.createFactory(T),M=n.createClass({displayName:"CommentActivityUI",mixins:[L,R],propTypes:{parentActivity:n.PropTypes.object.isRequired,fileActivity:n.PropTypes.instanceOf(O).isRequired,comment_activity:n.PropTypes.object.isRequired,user:n.PropTypes.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:n.PropTypes.bool,shouldAutoLinkify:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,isReply:n.PropTypes.bool,shouldShowReplyButton:n.PropTypes.bool,onReplyButtonMouseUp:n.PropTypes.func,isOffline:n.PropTypes.bool,isExpanded:n.PropTypes.bool,truncateLength:n.PropTypes.number,annotationNumber:n.PropTypes.number,scrollIntoView:n.PropTypes.func,isInAnnotationBubble:n.PropTypes.bool},getInitialState:function(){return{showAnnotationThumbnail:!1}},getDefaultProps:function(){return{shouldAutoLinkify:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldShowReplyButton:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1,isExpanded:!1}},componentDidMount:function(){var t;return t=o.findDOMNode(this),this.events.on(t,N,this.onAnimationEnd,this)},reveal:function(){var t;return"function"==typeof(t=this.props).scrollIntoView&&t.scrollIntoView({node:o.findDOMNode(this),padTop:20}),this.setState({highlighting:!0})},onAnimationEnd:function(){return this.setState({highlighting:!1})},onHeaderClick:function(t){var e;return e=this.props.comment_activity,this.props.shouldAnnotationButtonUseThumbnailUrls?this.setState({showAnnotationThumbnail:!this.state.showAnnotationThumbnail}):m.revealAnnotationInPreview(e.activity_key),y.logAnnotationEvent(D.CLIENT_ANNOTATION_BUTTON_CLICKED,e.activity_key)},isPendingComment:function(){return this.props.comment_activity.is_pending},isFailedPendingComment:function(){return this.isPendingComment()&&"FAILED"===this.props.comment_activity.status},onUpdateResolve:function(t){return m.setCommentResolved({commentActivityKey:this.props.comment_activity.activity_key,resolved:t})},onDeleteComment:function(t){var e;return e=this.props.shouldUseSimpleModals?"simple":"default",t.preventDefault(),B.show({title_text:q("Delete comment?"),body_html:q("Are you sure you want to delete this comment?"),cancel_text:q("Cancel"),confirm_text:q("Delete"),style:e,confirm_callback:function(t){return function(){return m.deleteComment({commentActivityKey:t.props.comment_activity.activity_key})}}(this)})},_isCommentForOldRevision:function(){var t,e;return e=null!=(t=this.props.comment_activity.comment.comment_metadata)?t.revision:void 0,null!=e&&!g.isRevisionEqual(e,this.props.fileActivity.latest_revision)},onReplyButtonMouseUp:function(){var t;return"function"==typeof(t=this.props).onReplyButtonMouseUp?t.onReplyButtonMouseUp():void 0},onRetryPendingComment:function(){return W(this.isPendingComment(),"Cannot retry posting non-pending comment"),m.retryPostingComment({targetActivityKey:this.props.parentActivity.activity_key,pendingCommentActivity:this.props.comment_activity})},_renderAnnotationHeader:function(){var t,e,n,o;return e=this.props.comment_activity.comment,e.hasMetadata()&&e.comment_metadata.hasAnnotationData()?(n=e.comment_metadata,t=I.createAnnotationFromDict(n.annotation),o=n.revision,F({revision:o,annotation:t,isOldRevision:this._isCommentForOldRevision(),onClick:this.onHeaderClick,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline,shouldShowResolveButton:!this.isPendingComment()&&this.props.user.is_signed_in&&!this.props.isReply,resolved:e.resolved,annotationNumber:this.props.annotationNumber,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,showAnnotationThumbnail:this.state.showAnnotationThumbnail})):void 0},renderPhoto:function(){var e,o,i;return o={dimension:32,defaultAvatar:n.createElement(d,{dimension:32,shape:"CIRCLE",initials:this.props.comment_activity.comment.commenter.initials,name:this.props.comment_activity.comment.commenter.display_name})},this.props.shouldHidePhotoAvatars||""===this.props.comment_activity.comment.commenter.photo_circle_url||(o.photoUrl=this.props.comment_activity.comment.commenter.photo_circle_url),i=this.props.comment_activity.comment.commenter.id,e=t.call(c.get_viewer().get_user_ids(!0),i)>=0?new V(o):new k(o),j.div({className:"commenter-photo"},e)},renderCommentBody:function(){var t,e;return t=this.props.comment_activity.comment.raw_comment_text,e=f.convertRawCommentTextToReactDom(t,this.props.shouldAutoLinkify,!this.props.isExpanded&&this.props.truncateLength)},renderBody:function(){var t,o,s,r,a,l,u,d,p,m;return m=c.get_viewer(),p=i.intersection(m.get_user_ids(!0),null!=(l=this.props.comment_activity.permissions)?l.user_ids_who_can_delete:void 0).length,t=(p||m.can_moderate_comments)&&!this.props.isOffline&&!this.isPendingComment(),a=S.IS_COMBINED_COMMENTS_ENABLED,o=this.props.comment_activity.comment,r=o.hasMetadata()&&o.comment_metadata.hasAnnotationData(),d=!this.isPendingComment()&&this.props.user.is_signed_in&&!this.props.isReply&&(!r||this.props.isInAnnotationBubble),s=e({"comment-body":!0,"has-annotation":r}),j.div({className:s},j.div({className:"comment-top-bar"},j.div({className:"commenter-name"},o.commenter.display_name),a?j.div({className:"comment-when"},H({when_mses:o.when_mses})):void 0,d?U({resolved:o.resolved,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline}):void 0),o.hasMetadata()&&o.comment_metadata.hasStickerData()?function(t){return h.isLiveSticker(t)?n.createElement(w,{stickerId:t}):j.img({className:"comment-sticker-body",src:h.getStickerImageUrl(t)})}(o.comment_metadata.getStickerId()):j.span({},j.div({className:"comment-text"},this.renderCommentBody())),this.isFailedPendingComment()?j.div({className:"comment-bottom-bar"},j.div({className:"pending-comment--failed"},j.span({className:"pending-comment__warning"},q("Unable to post comment.")),j.a({className:"pending-comment__retry",onClick:this.onRetryPendingComment},q("Retry")))):this.props.isExpanded?!a||t?j.div({className:"comment-bottom-bar"},a?void 0:H({when_mses:o.when_mses}),t?j.span({className:"delete"},a?void 0:j.div({className:"second-bottom-dot"}," · "),j.div({className:"delete-icon",onMouseDown:function(t){return function(e){return t.onDeleteComment(e)}}(this)},q("Delete"))):void 0):void 0:this.props.shouldShowReplyButton?(u=e({"reply-button":!0}),j.div({className:"comment-bottom-bar"},j.a({className:u,onMouseUp:this.onReplyButtonMouseUp},q("Reply")))):void 0)},render:function(){var t;return t=e({comment:!0,resolved:this.props.comment_activity.comment.resolved,"comment--old-revision":this._isCommentForOldRevision(),"comment--reply":this.props.isReply,"comment--pending":this.isPendingComment(),"comment--highlighting":this.state.highlighting,expanded:this.props.isExpanded}),j.div({className:"comment-activity","data-comment-activity-key":this.props.comment_activity.activity_key},this._renderAnnotationHeader(),j.div({className:t},this.renderPhoto(),this.renderBody()))}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/comment_input",["jquery","external/classnames","external/react","external/react-dom","external/underscore","modules/constants/comments_panel","modules/constants/legacy","modules/core/browser","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/activity/activity_user","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/viewer_avatar","modules/clean/comments/action_creators","modules/clean/comments/constants","modules/clean/comments/logging","modules/clean/components/title_bubble","modules/clean/contacts/types","modules/clean/contacts/util","modules/clean/file_activity/models/file_activity","modules/clean/keycode","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/mentions_controller","modules/clean/react/bubble_dropdown","modules/clean/react/button","modules/clean/react/file_comments/logger","modules/clean/react/file_comments/stickers","modules/clean/react/sprite","modules/clean/storage","modules/clean/viewer"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f,v,y,g,b,C,w,T,S,A,E,N,I,x,P,k,M){var R,O,D,L,U,B,F,H,V,q,W,j,K,z,G,Y;return K=u._,Y=u.ungettext,R=p.ActivityUser,U=v.FileActivityLogEventType,L=v.FileActivityLogClientOriginType,D=w.FileActivity,W=x.Stickers,F=k.LocalStorage,H=4e3,G=o.DOM,q=o.createFactory(o.addons.CSSTransitionGroup),V=o.createFactory(A),O=o.createFactory(h),B=o.createFactory(m),j=o.createFactory(_),z=o.createFactory(N.button),o.createClass({displayName:"CommentInput",mixins:[o.addons.PureRenderMixin],propTypes:{activity:o.PropTypes.instanceOf(D),usersToNotify:o.PropTypes.arrayOf(o.PropTypes.instanceOf(R)).isRequired,metadata:o.PropTypes.object,onAddComment:o.PropTypes.func,onCancelComment:o.PropTypes.func,resizeCallback:o.PropTypes.func,positionDropdownCallback:o.PropTypes.func,onFocus:o.PropTypes.func,onBlur:o.PropTypes.func,user:o.PropTypes.instanceOf(R).isRequired,onShowNewComment:o.PropTypes.func,enableNoNotifyHint:o.PropTypes.bool,showNewComment:o.PropTypes.bool,shouldPopupsDropdown:o.PropTypes.bool,initialText:o.PropTypes.string,shouldInitiallyFocusInput:o.PropTypes.bool,shouldAlwaysInEditMode:o.PropTypes.bool,shouldEnableStickers:o.PropTypes.bool,onAddSticker:o.PropTypes.func,contactSearchLogger:o.PropTypes.object,enableImport:o.PropTypes.bool,shouldHidePhotoAvatars:o.PropTypes.bool,isReplyInput:o.PropTypes.bool,shouldUseSimpleModals:o.PropTypes.bool,shouldEnableCancelButton:o.PropTypes.bool,isOffline:o.PropTypes.bool,shouldShowAvatar:o.PropTypes.bool,onStickerDropdownShown:o.PropTypes.func,onStickerDropdownHidden:o.PropTypes.func,onContactsSelectorPopupShown:o.PropTypes.func,onContactsSelectorSuggestionsUpdate:o.PropTypes.func,shouldDisableBubbleDropdownHideOnResize:o.PropTypes.bool,shouldDisplayRegionCreationButton:o.PropTypes.bool,onMentionedUsersChanged:o.PropTypes.func,setShouldShowNotifyHint:o.PropTypes.func,isRegionCreationEnabled:o.PropTypes.bool,onChange:o.PropTypes.func,isCommentsServerView:o.PropTypes.bool},getInitialState:function(){var t,e,n,o;return e=!0,o=this.props.shouldAlwaysInEditMode,t=null!=this.props.initialText?this.props.initialText:this._getCommentLocalStorage(null!=(n=this.props.activity)?n.activity_key:void 0),t.length>0&&(e=!1,o=!0),r.COMMENTS_COLLAPSE_INPUT||(o=!0),{inputIsEmpty:e,shouldShowPostButton:o,initialText:t,commentMetadata:null}},getDefaultProps:function(){return{onShowNewComment:e.noop,shouldAlwaysInEditMode:!1,isCommentInputDisabled:!1,enableImport:!0,shouldHidePhotoAvatars:!1,isReplyInput:!1,shouldEnableCancelButton:!1,isOffline:!1,shouldShowAvatar:!0,metadata:null,shouldDisplayRegionCreationButton:!1}},componentDidMount:function(){var t,n;return t=function(t,n){var o;return o=i.findDOMNode(n)||null,o?t.target===o||e.contains(o,t.target):!1},e(i.findDOMNode(this)).on("click.comment-input",function(e){return function(n){return t(n,e.refs.postButton)&&e.verifySubscribersBeforePost(),t(n,e.refs.showNewCommentButton)?e.props.onShowNewComment():void 0}}(this)),(null!=(n=this.state.initialText)?n.length:void 0)?this.onChange():void 0},componentWillUnmount:function(){return e(i.findDOMNode(this)).off(".comment-input")},_emailEnteredCallback:function(t){var e,n,o;return null!=(e=this.refs.mentions)&&e.addMentionIntoRangeUnicode(null!=(n=this.refs.mentions)?n.createMentionObject(t):void 0),this.setCursorToEndOfInput(),null!=(o=this.refs.mentionsHintDropdown)?o.hide():void 0},_contactHighlightedCallback:function(){var t;return null!=(t=this.refs.mentions)?t.contactHighlightedCallback():void 0},_clearContactHighlightedCallback:function(){var t;return null!=(t=this.refs.mentions)?t.clearContactHighlightedCallback():void 0},_contactsSelectorPopupShown:function(){var t,e,n;return null!=(e=this.refs.mentions)&&e.contactsSelectorPopupShown(this.refs.mentionsContactSelectorPopup),I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,null!=(n=this.props.activity)?n.activity_key:void 0,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id),"function"==typeof(t=this.props).onContactsSelectorPopupShown?t.onContactsSelectorPopupShown():void 0},_contactsSelectorPopupHidden:function(){var t;return null!=(t=this.refs.mentions)?t.contactsSelectorPopupHidden():void 0},_onContactsSelectorSuggestionsUpdate:function(){var t;return this._updateInputIsEmptyState(),"function"==typeof(t=this.props).onContactsSelectorSuggestionsUpdate?t.onContactsSelectorSuggestionsUpdate():void 0},_onAtSignKeyPress:function(){return this.props.user.is_signed_in?I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,this.props.user.id):void 0},_onNoAtSignKeyPress:function(){return I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS,this.props.user.id)},_contactPopupSelectedCallback:function(t){var e,n,o,i;return null!=(e=this.refs.mentions)&&e.addMentionIntoRangeUnicode(null!=(n=this.refs.mentions)?n.createMentionObjectFromSuggestion(t):void 0),null!=(o=this.refs.mentions)&&o.setCursorToEndOfInput(),null!=(i=this.refs.mentionsHintDropdown)&&i.hide(),c.assert(this.props.user.is_signed_in,"Contact selected from popup when user is logged out"),I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id)},_contactSelectedCallback:function(t){var e;return c.assert(this.props.user.is_signed_in,"Contact selected when user is logged out"),e=t?a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS:a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,e,this.props.user.id)},onMention:function(){var t;return this.onChange(),"function"==typeof(t=this.props).onMention?t.onMention():void 0},onChange:function(){var t,e,n,o;return o=this.refs.mentions.extractMentions(),n=o.map(function(t){return function(t){return R.fromUser({id:t.dbx_account_id||t.identifier,display_name:t.name})}}(this)),"function"==typeof(t=this.props).onMentionedUsersChanged&&t.onMentionedUsersChanged(n),"function"==typeof(e=this.props).onChange?e.onChange(this.getRawCommentInput()):void 0},onMentionsFocus:function(t){var e;return this.togglePostButton(!0),"function"==typeof(e=this.props).onFocus?e.onFocus(t):void 0},onMentionsBlur:function(t){var e;if("function"==typeof(e=this.props).onBlur&&e.onBlur(),this.refs.mentions.getEncodedMessage()){if(this.shouldSaveText())return this._storeCommentLocalStorage(this.refs.mentions.getRawMessage(),this.props.activity.activity_key)}else!this.props.shouldAlwaysInEditMode},onMentionsCancel:function(t){var e;return"function"==typeof(e=this.props).onCancelComment?e.onCancelComment():void 0},onKeyDown:function(t){return t.keyCode===T.ENTER&&(t.ctrlKey||t.metaKey)?(this.verifySubscribersBeforePost(),t.preventDefault()):this._updateInputIsEmptyState()},onKeyUp:function(t){return this._updateInputIsEmptyState(),this.onChange()},onPaste:function(t){return t.clipboardData.getData("text/plain").length>H?(d.error(K("The text you're trying to paste is too long.")),t.preventDefault()):setTimeout(function(t){return function(){return t._updateInputIsEmptyState(),t.onChange()}}(this),10)},showNoNotifyHint:function(){var t,e;return this.refreshDropdownDirection(),null!=(t=this.refs.mentionsHintDropdown)&&t.show(),null!=(e=this.refs.mentionsContactSelectorPopup)?e.showNoNotifyHint():void 0},refreshDropdownDirection:function(){var t;return"function"==typeof(t=this.props).positionDropdownCallback?t.positionDropdownCallback():void 0},togglePostButton:function(t){var e;return e=function(e){return function(){var n,o;return"function"==typeof(n=e.props).resizeCallback&&n.resizeCallback(t),"function"==typeof(o=e.props).setShouldShowNotifyHint?o.setShouldShowNotifyHint(t):void 0}}(this),this.setState({shouldShowPostButton:t},e)},shouldSaveText:function(){return!this.props.user.is_signed_in||!this.props.user.is_email_verified},setCursorToEndOfInput:function(){return this.refs.mentions.setCursorToEndOfInput()},_onSkipAddMention:function(t){var e;return null!=(e=this.refs.mentionsHintDropdown)&&e.hide(),this.postComment()},_updateInputIsEmptyState:function(){var t;return t=""===this.refs.mentions.getEncodedMessage(),this.state.inputIsEmpty!==t?this.setState({inputIsEmpty:t}):void 0},verifySubscribersBeforePost:function(t){var e,n,o,i;return this.props.user.is_signed_in&&null!=this.props.usersToNotify&&(e=function(){var t,e,n,o;for(n=this.props.usersToNotify,o=[],t=0,e=n.length;e>t;t++)i=n[t],i.id!==this.props.user.id&&o.push(i);return o}.call(this),e&&0===e.length&&0===(null!=(n=this.props.activity)&&null!=(o=n.comment_activities)?o.length:void 0)&&this.props.enableNoNotifyHint)?void this.showNoNotifyHint():this.postComment()},postComment:function(){var t,e;return(e=this.refs.mentions.getEncodedMessage())?e.length>H?void d.error(K("The comment is too long.")):(this.shouldSaveText()||(this.refs.mentions.disableMentions(),this.refs.mentions.clearTextField(),this._updateInputIsEmptyState()),"function"==typeof(t=this.props).onAddComment?t.onAddComment(e):void 0):void 0},focusInput:function(){var t;return null!=(t=this.refs.mentions)?t.focusInput():void 0},getRawCommentInput:function(){var t;return null!=(t=this.refs.mentions)?t.getRawMessage():void 0},getPlaceholderText:function(){return K(this.props.isReplyInput?"Reply":"Write a comment")},_usersToNotifyToContacts:function(t){var e,n,o,i;for(e=[],n=0,o=t.length;o>n;n++)i=t[n],i.id!==this.props.user.id&&e.push(C.activityUserToContact(i,Number.MAX_VALUE));return e},_onCancelMouseUp:function(){var t;return"function"==typeof(t=this.props).onCancelComment?t.onCancelComment():void 0},_onRegionCreationClick:function(){var t,e;return e=!this.props.isRegionCreationEnabled,t=e?U.CLIENT_ANNOTATION_MODE_ENABLED:U.CLIENT_ANNOTATION_MODE_DISABLED,y.logEvent(t,L.ANNOTATION_MODE_BUTTON_IN_COMMENTS_PANE),f.setRegionCreationEnabled(e)},_postSticker:function(t){var e,n;return"function"==typeof(e=this.props).onAddSticker&&e.onAddSticker(t),null!=(n=this.refs.stickerDropdown)?n.hide():void 0},_clearCommentLocalStorage:function(t){return F.set("tmp-file-comment",null)},_getCommentLocalStorage:function(t){var n,o;return o=F.get("tmp-file-comment"),n="",o&&o.activity_key===t&&((new Date).getTime()-o.time<3e5&&(n=o.text),this._clearCommentLocalStorage()),e("<div/>").html(n).text()},_storeCommentLocalStorage:function(t,n){var o;return o=e("<div/>").text(t).html(),F.set("tmp-file-comment",{activity_key:n,text:o,time:(new Date).getTime()})},_renderShowNewComment:function(){var t,e;return e=[],this.props.showNewComment&&(t=G.a({className:"show-new-comment-button",ref:"showNewCommentButton"},G.span({className:"show-new-comment-icon",key:key}),G.span({className:"show-new-comment-text"},K("New Comment"))),e=G.div({className:"comment-show-new-comment"},t)),q({transitionName:"comment-show-new-comment",component:"div"},e)},_renderCommentBox:function(){var t,e,o,i,s;return e=null!=this.props.usersToNotify?this.props.usersToNotify:[],s=this.props.user.is_signed_in&&this.state.shouldShowPostButton,i=this.props.shouldEnableStickers&&this.state.shouldShowPostButton,o=V({ref:"mentions",placeholder_text:this.getPlaceholderText(),initialText:this.state.initialText,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,shouldPopupsDropdown:this.props.shouldPopupsDropdown,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldAlwaysInEditMode:this.props.shouldAlwaysInEditMode,showPlaceholderText:this.state.inputIsEmpty,showMentionsHelper:s,enableNoAtMentions:r.ALLOW_NO_AT_MENTIONS&&this.props.user.is_signed_in,onFocus:this.onMentionsFocus,onBlur:this.onMentionsBlur,onCancel:this.onMentionsCancel,position_contacts_callback:this.props.positionDropdownCallback,resizeCallback:this.props.resizeCallback,onKeyUp:this.onKeyUp,onKeyDown:this.onKeyDown,onPaste:this.onPaste,onMention:this.onMention,contactsSelectorPopupShown:this._contactsSelectorPopupShown,onContactsSelectorSuggestionsUpdate:this._onContactsSelectorSuggestionsUpdate,onAtSignKeyPress:this._onAtSignKeyPress,onNoAtSignKeyPress:this._onNoAtSignKeyPress,contactSelectedCallback:this._contactSelectedCallback,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(e),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),t=n({"comment-box":!0,"input-collapsed":!this.state.shouldShowPostButton}),G.div({className:t},this._renderCommenterPhoto(),o,G.div({className:"post-area",ref:"postArea"},G.div({className:"comment-input-buttons"},this.props.shouldDisplayRegionCreationButton?this._renderRegionCreationButton():void 0,i?this._renderStickerButton():void 0,s?this._renderMentionsHelper():void 0),this.state.shouldShowPostButton?this._renderButtonsContainer():void 0))},_renderRegionCreationButton:function(){var t,e,i;return this.props.isRegionCreationEnabled?(i=K("Done commenting"),e="ic_comment_area_blue"):(i=K("Comment on specific areas"),e="ic_comment_area_dark"),t=n({"region-creation-button":!0,"comment-input-button":!0,"sprite-button":!0,"region-creation-enabled":this.props.isRegionCreationEnabled}),G.div({className:t,onClick:this._onRegionCreationClick},o.createElement(g,{text:i,direction:"south"},G.div({className:"region-creation-image"},o.createElement(P,{group:"web",name:e,alt:i}))))},_getArrowPosition:function(){var t,e;return t=this.props.shouldPopupsDropdown?"top":"bottom",e=this.props.isCommentsServerView?"left":"right",t+"-"+e},_renderStickerButton:function(){var t,e,n;return t=o.createElement(g,{text:K("Add sticker"),direction:"south"},G.div({className:"comment-sticker-add"},o.createElement(P,{group:"web",name:"ic_sticker",alt:K("Add sticker")}))),e=this.props.isCommentsServerView?-38:1,n=this.props.shouldPopupsDropdown?4:-11,G.div({className:"sticker-button comment-input-button sprite-button",onMouseDown:this.refreshDropdownDirection},o.createElement(E,{targetButton:t,ref:"stickerDropdown",arrow_position:this._getArrowPosition(),
vertical_displacement:n,extra_css_class:"stickers-bubble-dropdown",horizontal_displacement:e,anchor_bottom:!this.props.shouldPopupsDropdown,bubbleDropdownShown:this.props.onStickerDropdownShown,bubbleDropdownHidden:this.props.onStickerDropdownHidden,bubbleDropdownScrollable:!0,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},o.createElement(W,{isPopupAbove:this.props.shouldPopupsDropdown,onStickerSelected:this._postSticker})))},_renderMentionsHelper:function(){var t,e,n;return n=null!=this.props.usersToNotify?this.props.usersToNotify:[],t=G.button({className:"comment-mention-hint-add sprite-button"},o.createElement(P,{group:"web",name:"s_mention_add",alt:K("@mention someone")})),e=this.props.shouldPopupsDropdown?0:-16,G.div({className:"comment-mention-hint comment-input-button"},o.createElement(g,{direction:"south",text:K("@mention someone")},G.div({className:"comment-mention-hint-button",onMouseDown:this.refreshDropdownDirection},o.createElement(E,{targetButton:t,autofocus:!0,ref:"mentionsHintDropdown",arrow_position:this._getArrowPosition(),vertical_displacement:e,horizontal_displacement:this.props.isCommentsServerView?1:3,anchor_bottom:!this.props.shouldPopupsDropdown,extra_css_class:"mentions-helper-bubble-dropdown",bubbleDropdownHidden:this._contactsSelectorPopupHidden,bubbleDropdownShown:this._contactsSelectorPopupShown,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},o.createElement(S,{key:"mentionsContactSelectorPopup",ref:"mentionsContactSelectorPopup",shouldShowNoNotifyHint:!1,user:this.props.user,contactSearchLogger:this.props.contactSearchLogger,emailEnteredCallback:this._emailEnteredCallback,contactSelectedCallback:this._contactPopupSelectedCallback,contactHighlightedCallback:this._contactHighlightedCallback,clearContactHighlightedCallback:this._clearContactHighlightedCallback,should_dropdown:this.props.shouldPopupsDropdown,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(n),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars})))))},_renderCommenterPhoto:function(){var e,n,o,i;return e={dimension:32,defaultAvatar:new B({dimension:32,shape:"CIRCLE",initials:this.props.user.initials||"?",name:this.props.user.getDisplayIdentity()})},this.props.shouldHidePhotoAvatars||(e.photoUrl=this.props.user.photo_circle_url),o=null!=(i=this.props.user)?i.id:void 0,n=t.call(M.get_viewer().get_user_ids(!0),o)>=0?j(e):O(e),G.div({className:"commenter-photo"},this.props.shouldShowAvatar?n:void 0)},_renderCancelButton:function(){return G.a({className:"cancel-button",onMouseUp:this._onCancelMouseUp},K("Cancel"))},_renderButtonsContainer:function(){var t,e,n;return e=this.state.inputIsEmpty||this.props.isOffline,t={className:"post-button",disabled:e,ref:"postButton"},n=z(t,K("Post")),G.div({className:"button-container"},n,this.props.shouldEnableCancelButton?this._renderCancelButton():void 0)},render:function(){var t;return t=n({"comment-field":!0,"comment-field--reply":this.props.isReplyInput,"comment-field--disabled":this.props.isOffline}),G.div({className:t},this._renderShowNewComment(),this._renderCommentBox(),this.props.isCommentInputDisabled||this.props.isOffline?G.div({className:"comment-field__diabled"},""):void 0)}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/contacts_selector",["external/classnames","external/react","external/react-dom","external/typeahead.bundle","jquery","modules/clean/keycode","modules/clean/ajax","modules/clean/contacts/bloodhound_contacts","modules/clean/contacts/list","modules/clean/contacts/types","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/sprite","modules/core/i18n","modules/core/exception","modules/core/user_i18n"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f,v,y){var g,b,C,w,T,S,A;return w=m.LinkedProfileServices,S=m.ProfileServicesLinkingHandler,A=n.DOM,T=5,b=99,C=3,g=n.createClass({displayName:"ContactsSelector",propTypes:{showNullHint:n.PropTypes.bool,contactSelectedCallback:n.PropTypes.func,contactHighlightedCallback:n.PropTypes.func,contactSearchLogger:n.PropTypes.object,noAtMentionTriggerCallback:n.PropTypes.func,resultsLimit:n.PropTypes.number,matchFullQUery:n.PropTypes.bool,noMatchesText:n.PropTypes.string,user:n.PropTypes.object,showContactsInNullState:n.PropTypes.bool,x_offset:n.PropTypes.number,y_offset:n.PropTypes.number,enableImport:n.PropTypes.bool,show_contacts:n.PropTypes.bool,should_dropdown:n.PropTypes.bool,last_keydown:n.PropTypes.number,extraContacts:n.PropTypes.arrayOf(n.PropTypes.object),shouldHidePhotoAvatars:n.PropTypes.bool},getInitialState:function(){return this.contactSelectedCallback=this.props.contactSelectedCallback,null!=this.props.user&&this.props.user.is_signed_in&&this.props.enableImport&&(this.profile_services=w.get_linked_profile_services_for_user(this.props.user.id)),{suggestions:[],matches_count:0,focused_row:null,query:"",show_no_results:!1,hover_import_contact:!1,show_import_list:!1}},getDefaultProps:function(){return{contactSelectedCallback:void 0,should_dropdown:!0,show_contacts:!1,enableImport:!0,x_offset:0,y_offset:0,last_keydown:-1,showNullHint:!0,showContactsInNullState:!1,noMatchesText:f._("No matches. Keep typing an email address."),matchFullQUery:!1,extraContacts:[],shouldHidePhotoAvatars:!1}},componentWillMount:function(){return this.contacts=new l,this.contacts.setExtraContacts(this.props.extraContacts),0===this.state.query.length&&this.props.showContactsInNullState?this.get_suggestions(""):void 0},componentDidMount:function(){return this.$typeahead_container=s(o.findDOMNode(this.refs.suggestionsContainer)),this.$typeahead_suggestions=s(o.findDOMNode(this.refs.suggestionsList)),this._position_contacts_list(),this._toggle_contacts_list(),this.state.show_contacts?void 0:this._reset_import_state()},componentWillReceiveProps:function(t){return this.contacts.setExtraContacts(t.extraContacts),0===this.state.query.length&&t.showContactsInNullState!==this.props.showContactsInNullState?this.get_suggestions(""):void 0},componentDidUpdate:function(t,e){var n;return this.$typeahead_container=s(o.findDOMNode(this.refs.suggestionsContainer)),this.$typeahead_suggestions=s(o.findDOMNode(this.refs.suggestionsList)),this._position_contacts_list(),this._toggle_contacts_list(),"function"==typeof(n=this.props).contactHighlightedCallback?n.contactHighlightedCallback(this._get_suggestion_row(this.state.focused_row)):void 0},_reset_import_state:function(){return this.setState({hover_import_contact:!1,show_import_list:!1})},_append_import_to_suggestions:function(t){var e,n,o,i;for(o=h.contact_services(),e=0,n=o.length;n>e;e++)i=o[e],t.push(this._append_provider(i));return t},_append_provider:function(t){var e;return e=h.to_name(t),this.profile_services.service_is_connected(t)&&(e+=f._(" (Connected)")),{type:b,provider:t,name:e,photo_url:h.to_img(t)[0]}},_import_contacts_mouseover:function(t){return this.setState({hover_import_contact:!0})},_import_contacts_mouseleave:function(t){return this.setState({hover_import_contact:!1})},_mouse_down_import_contacts:function(t){return t.preventDefault(),this.setState({hover_import_contact:!this.state.hover_import_contact,show_import_list:!this.state.show_import_list})},_focus_suggestion_row:function(t){return null!=t&&this.state.focused_row!==t||null===t?this.setState({focused_row:t}):void 0},_focus_suggestion_row_mouseover:function(t){var e,n;return e=s(t.currentTarget),n=e.index(),n>-1?this._focus_suggestion_row(n):void 0},_get_suggestion_row:function(t){return this.$typeahead_suggestions.find(".suggestion-row.focused")},_get_suggestions_callback:function(t,e,n){var o,i,s,a,l;return this.isMounted()?(e=function(){var t,n,o;for(o=[],t=0,n=e.length;n>t;t++)s=e[t],s.type!==u.NEW_STYLE_GROUP&&o.push(s);return o}(),e=c.sortContactsByTeamFirst(e),n||(e=t.length>=T?this._getApproximateNameMatches(t,e):this._getExactFirstOrLastNameMatches(t,e)),this.matchesCountFromBloodhoundContacts=e.length,e=e.slice(0,this.props.resultsLimit),a=e.length,l=0===a&&this.props.last_keydown!==r.SPACE&&t.indexOf(" ")<0||0===a&&this.props.matchFullQUery,n||"function"==typeof(i=this.props).noAtMentionTriggerCallback&&i.noAtMentionTriggerCallback(a),this.props.enableImport&&0===a?e=this._append_import_to_suggestions(e):a>0&&this._reset_import_state(),this.props.should_dropdown?o=0:(o=e.length-1,e.reverse()),this.setState({suggestions:e,focused_row:o,show_no_results:l,matches_count:a})):void 0},_has_suggestion_row_at_index:function(t){return null!=t&&t>=0&&t<this.get_suggestions_count()},_mouse_down_select_suggestion:function(t){return t.preventDefault(),this.select_suggestion(t.currentTarget)},_position_contacts_list:function(){var t,e;return e=this.$typeahead_container.parent(),t=this.$typeahead_container.width(),t+this.props.x_offset>e.width()?this.$typeahead_container.css("left",e.width()-t):this.$typeahead_container.css("left",this.props.x_offset),this.props.should_dropdown?this.$typeahead_container.css("top",this.props.y_offset):this.$typeahead_container.css("top",this.props.y_offset-this.$typeahead_container.height()-12)},_toggle_contacts_list:function(){return this.props.show_contacts&&(this._matches_count()>0||0===this.state.query.length||this.state.show_no_results&&this.state.query.length)?this.$typeahead_container.show():this.$typeahead_container.hide()},_matches_count:function(){return this.state.matches_count},_getExactFirstOrLastNameMatches:function(e,n){var o;return function(){var i,s,r;for(r=[],i=0,s=n.length;s>i;i++)o=n[i],t.call(o.name_tokens,e)>=0&&r.push(o);return r}()},_getApproximateNameMatches:function(t,e){var n,o,i,s,r,a,l,c;for(a=[],n=0,i=e.length;i>n;n++)for(r=e[n],c=r.name_tokens,o=0,s=c.length;s>o;o++)if(l=c[o],0===l.indexOf(t)){a.push(r);break}return a},get_suggestions:function(t,e){return null==e&&(e=!0),null!=this.props.user&&this.props.user.is_signed_in?(this.contacts.get(t,function(n){return function(o){return n._get_suggestions_callback(t,o,e)}}(this)),this.setState({query:t})):void 0},get_suggestions_count:function(){return this.props.show_contacts?this.$typeahead_suggestions.children().size():0},navigate_suggestions:function(t){var e,n,o,i,s;if(e=t.keyCode||t.which||t.charCode,t.keyCode===r.ENTER||t.keyCode===r.TAB){if(t.preventDefault(),this._has_suggestion_row_at_index(this.state.focused_row))return s=this._get_suggestion_row(this.state.focused_row),this.select_suggestion(s)}else if(((o=t.keyCode)===r.UP||o===r.DOWN)&&(n=this.get_suggestions_count(),n>0))if(t.keyCode===r.UP){if(i=null!=this.state.focused_row?this.state.focused_row:n,0!==this.state.focused_row)return this._focus_suggestion_row((i-1)%n)}else if(t.keyCode===r.DOWN&&(i=null!=this.state.focused_row?this.state.focused_row:-1,this.state.focused_row!==n-1))return this._focus_suggestion_row((i+1)%n)},select_suggestion:function(t){var e,n,o;return e=s(t),e.data("type")===b?void(null!=this.props.user&&this.props.user.is_signed_in&&(n=new S,n.auth_service_with_user(String(e.data("provider")),this.props.user.id,function(t){return S.show_import_notifications(t)},"contact-importer-modal"))):(null!=this.props.contactSearchLogger&&(o={sort_variant:null,context:"mentions",search_expr:this.state.query,selected_pos:this.state.focused_row,num_query_results:this.matchesCountFromBloodhoundContacts,contact_type:e.data("type"),contact_id:e.data("identifier"),contact_name:e.data("name"),did_select_suggestion:!0},this.props.contactSearchLogger.add_record(o)),null!=this.contactSelectedCallback&&this.contactSelectedCallback(e),this.isMounted()?this.setState({focused_row:null,suggestions:[]}):void 0)},render:function(){var t,o,i,s;return o=e({"contacts-list-suggestions":!0,"animating-down":this.props.show_contacts&&!this.props.should_dropdown,"animating-up":this.props.show_contacts&&this.props.should_dropdown}),A.div({className:o,ref:"suggestionsContainer"},this.props.show_contacts&&this.props.user?this.props.user.is_signed_in?0===this.state.query.length&&this.props.showNullHint&&!this.props.showContactsInNullState?A.div({className:"suggestion-row empty-state-row"},f._("Mention someone by name or email")):this.state.query.length||0===this.state.query.length&&this.props.showContactsInNullState?(t=A.div({ref:"suggestionsList"},function(){var t,i,r,a;for(r=this.state.suggestions,a=[],t=0,i=r.length;i>t;t++)s=r[t],a.push(function(t){return function(i){var s,r,a,l,c,h,m,_;return o={"import-row":i.type===b,"suggestion-row":!0,focused:null!=t.state.focused_row&&t.state.suggestions.indexOf(i)===t.state.focused_row},a=e(o),i.type===u.EMAIL?(m=i.email,l=i.email):i.type===u.FB?(m="fb_"+i.fb_id,l="Facebook Contact"):i.type===u.NEW_STYLE_GROUP?(m=i.group_id,l="Group"):i.type===b?(m="Import-"+i.name,r=A.img({src:i.photo_url})):i.type===u.DBX_ID&&(m=i.dbx_account_id,l=f._("Dropbox User")),c=!1,null!=i.name&&i.name.length>0?_=i.name:null!=i.email&&(c=!0,_=i.email,l=null),i.type===b||null==i.photo_url&&null==_||(h=c?"@":y.getInitials(_),s={dimension:32,defaultAvatar:n.createElement(p,{dimension:32,shape:"CIRCLE",initials:h,name:_})},t.props.shouldHidePhotoAvatars||(s.photoUrl=i.photo_url),r=n.createElement(d,s)),A.div({key:m,className:a,"data-identifier":m,"data-name":_,"data-type":i.type,"data-photo-url":i.photo_url,"data-dbx-account-id":i.dbx_account_id||null,"data-provider":i.provider||null,onMouseDown:function(e){return t._mouse_down_select_suggestion(e)},onMouseEnter:function(e){return t._focus_suggestion_row_mouseover(e)}},A.div({className:"suggestion-wrapper"},r?A.div({className:"suggestion-avatar"},r):void 0,A.div({className:"suggestion-info"},null!=_?A.div({className:"suggestion-name"},_):void 0,null!=l?A.div({className:"suggestion-identifier"},l):void 0)))}}(this)(s));return a}.call(this)),this.state.show_no_results?A.div({},A.div({className:"suggestion-row empty-state-row"},A.div({className:"empty-state-row-text"},this.state.hover_import_contact||this.state.show_import_list?f._("Import Contacts"):this.props.noMatchesText),this.props.enableImport?(i={"import-contacts":!0,active:null!=this.state.show_import_list},A.a({className:e(i),onMouseDown:function(t){return function(e){return t._mouse_down_import_contacts(e)}}(this),onMouseEnter:function(t){return function(e){return t._import_contacts_mouseover(e)}}(this),onMouseLeave:function(t){return function(e){return t._import_contacts_mouseleave(e)}}(this)},n.createElement(_,{group:"web",name:"user_add"}))):void 0),this.state.show_import_list?A.div({className:e({"suggestion-row-top-divider":!0,"animating-down":this.props.should_dropdown,"animating-up":!this.props.should_dropdown})},t):void 0):this._matches_count()>0?t:void 0):void 0:A.div({className:"suggestion-row empty-state-row"},f._("Login to @mention your contacts")):void 0)}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/contacts_selector_popup",["jquery","external/react","external/react-dom","modules/core/browser","modules/core/exception","modules/core/i18n","modules/clean/contacts/types","modules/clean/keycode","modules/clean/react/activity/contacts_selector","modules/clean/validators/validators"],function(e,n,o,i,s,r,a,l,c,u){var d,p,h,m;return p=n.DOM,m=[l.UP,l.DOWN,l.ESC,l.ENTER,l.TAB],h=u.check(u.create(["EmailValidator"])),d=n.createClass({displayName:"ContactsSelectorPopup",propTypes:{showContactsInNullState:n.PropTypes.bool,shouldShowNoNotifyHint:n.PropTypes.bool,should_dropdown:n.PropTypes.bool,user:n.PropTypes.object,contactHighlightedCallback:n.PropTypes.func,contactSelectedCallback:n.PropTypes.func,contactSearchLogger:n.PropTypes.object,emailEnteredCallback:n.PropTypes.func,clearContactHighlightedCallback:n.PropTypes.func,onAddPeopleMouseUp:n.PropTypes.func,onSkipAddMention:n.PropTypes.func,enableImport:n.PropTypes.bool,extraContacts:n.PropTypes.arrayOf(n.PropTypes.object),shouldHidePhotoAvatars:n.PropTypes.bool},getInitialState:function(){return{query:"",show_contacts:!0,last_keydown:-1,shouldShowNoNotifyHint:!1}},getDefaultProps:function(){return{showContactsInNullState:!0,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1}},showNoNotifyHint:function(){var t;return this.setState({shouldShowNoNotifyHint:!0}),"function"==typeof(t=this.props).clearContactHighlightedCallback?t.clearContactHighlightedCallback():void 0},contactHighlightedCallback:function(t){var e;return s.assert(!this.state.shouldShowNoNotifyHint,"Should not have highlight callback in no notify state"),"function"==typeof(e=this.props).contactHighlightedCallback?e.contactHighlightedCallback(t):void 0},contactSelectedCallback:function(t){var e;return this._resetInput(),"function"==typeof(e=this.props).contactSelectedCallback?e.contactSelectedCallback(t):void 0},_resetInput:function(){return this.setState({query:""}),e(o.findDOMNode(this.refs.contactSelectorPopupInput)).val(""),this.refs.contactSelectorPopup.get_suggestions("")},_logEmailEntered:function(t){var e;if(null!=this.props.contactSearchLogger)return e={sort_variant:null,context:"mentions",contact_type:a.EMAIL,contact_id:t,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(e)},_onInputKeyDown:function(t){var e,n,o;if(n=t.keyCode||t.which||t.charCode,null!=i.msie&&n===l.ENTER){if(o=t.target.value,this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(t);if(h(o))return"function"==typeof(e=this.props).emailEnteredCallback&&e.emailEnteredCallback(o),this._logEmailEntered(o)}},_onInputKeyUp:function(e){var n,o,i;if(o=e.keyCode||e.which||e.charCode,i=e.target.value,null!=this.refs.contactSelectorPopup){if(!(t.call(m,o)>=0))return this.setState({query:i}),this.refs.contactSelectorPopup.get_suggestions(i);if(this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(e);if(o===l.ENTER&&h(i))return"function"==typeof(n=this.props).emailEnteredCallback&&n.emailEnteredCallback(i),this._logEmailEntered(i)}},_onAddPeopleMouseUp:function(t){var n;return this.setState({shouldShowNoNotifyHint:!1},function(t){return function(){return e(o.findDOMNode(t.refs.contactSelectorPopupInput)).focus()}}(this)),"function"==typeof(n=this.props).onAddPeopleMouseUp?n.onAddPeopleMouseUp(t):void 0},_onSkipAddMention:function(t){var e;return"function"==typeof(e=this.props).onSkipAddMention?e.onSkipAddMention(t):void 0},render:function(){var t,e,o;return p.div({className:"contacts-selector-popup"},this.state.shouldShowNoNotifyHint?p.div({className:"contacts-selector-hint"},"Your comment won't notify anyone.",p.div({}),p.a({className:"",onMouseUp:this._onAddPeopleMouseUp},"Add people"),p.span({className:"bottom-dot"}," · "),p.a({className:"just-for-me",onMouseUp:this._onSkipAddMention},"Just for me")):(e=p.div({className:"contacts-selector-popup-input-wrapper"},p.input({ref:"contactSelectorPopupInput",onKeyDown:this._onInputKeyDown,onKeyUp:this._onInputKeyUp,placeholder:"Type an email or name"})),t=this.state.query.trim().length>0||this.props.showContactsInNullState?p.hr({className:"separator"}):p.span({}),o=n.createElement(c,{ref:"contactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,contactHighlightedCallback:this.contactHighlightedCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.should_dropdown,y_offset:0,x_offset:0,user:this.props.user,last_keydown:this.state.last_keydown,showNullHint:!1,showContactsInNullState:this.props.showContactsInNullState,matchFullQUery:!0,resultsLimit:5,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),this.props.should_dropdown?[e,t,o]:[o,t,e]))}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/mentions_controller",["jquery","external/classnames","external/react","external/react-dom","external/purify","modules/core/browser","modules/core/exception","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/keycode","modules/clean/validators/validators","modules/clean/react/activity/contacts_selector"],function(e,n,o,i,s,r,a,l,c,u,d,p){var h,m,_,f,v,y,g,b,C,w,T;return h=l.ActivityUser,g=o.DOM,m=o.createFactory(p),b="\ufeff",C=new RegExp(b,"g"),v=" ",y="",_="",w=[u.UP,u.DOWN,u.ESC,u.ENTER,u.TAB],T=d.check(d.create(["EmailValidator"])),f=o.createClass({displayName:"MentionsController",propTypes:{shouldPopupsDropdown:o.PropTypes.bool,enableNoAtMentions:o.PropTypes.bool,initialText:o.PropTypes.string,user:o.PropTypes.object,position_contacts_callback:o.PropTypes.func,showMentionsHelper:o.PropTypes.bool,contactSearchLogger:o.PropTypes.object,contactsSelectorPopupShown:o.PropTypes.func,contactSelectedCallback:o.PropTypes.func,onKeyDown:o.PropTypes.func,onKeyUp:o.PropTypes.func,onAtSignKeyPress:o.PropTypes.func,onNoAtSignKeyPress:o.PropTypes.func,onBlur:o.PropTypes.func,onFocus:o.PropTypes.func,onPaste:o.PropTypes.func,onCancel:o.PropTypes.func,onMention:o.PropTypes.func,placeholder_text:o.PropTypes.string,resultsLimit:o.PropTypes.number,resizeCallback:o.PropTypes.func,shouldInitiallyFocusInput:o.PropTypes.bool,shouldAlwaysInEditMode:o.PropTypes.bool,enableImport:o.PropTypes.bool,extraContacts:o.PropTypes.arrayOf(o.PropTypes.object),shouldHidePhotoAvatars:o.PropTypes.bool,onContactsSelectorSuggestionsUpdate:o.PropTypes.func,showPlaceholderText:o.PropTypes.bool},getInitialState:function(){var t;return t=this.props.shouldAlwaysInEditMode,this.isInNoAtMentionMode=!1,this.currentCursorWordStartPosition=0,this.currentCursorWordEndPosition=0,this.props.initialText&&this.props.initialText.length>0&&(t=!0),{default_state:!0,x_offset:0,y_offset:0,in_edit_mode:t,mention_triggered:!1,search_end_position:-1,search_start_position:-1,show_contacts:!1,last_keydown:-1}},getDefaultProps:function(){return{shouldPopupsDropdown:!0,initialText:"",user:new h,resultsLimit:5,enableNoAtMentions:!1,shouldAlwaysInEditMode:!1,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,shouldEnableStickers:!1}},componentDidMount:function(){return this._componentSetup(),this.state.default_state&&this.props.initialText.length>0&&(null!=r.mozilla?setTimeout(function(t){return function(){return t._initializeInputWithText(t.props.initialText)}}(this),0):this._initializeInputWithText(this.props.initialText)),this.props.shouldInitiallyFocusInput?setTimeout(function(t){return function(){return t.focusInput()}}(this),0):void 0},componentDidUpdate:function(t,e){var n,o;return this._componentSetup(),o=this._getCaretPosition(),e.show_contacts===this.state.show_contacts||(null!=o?o.left:void 0)===this.state.x_offset&&(null!=o?o.top:void 0)===this.state.y_offset?void 0:(n={x_offset:o.left,y_offset:o.top},this.setState(n))},_resetInputToPlaceholderState:function(){return this._dangerouslySetInputHtml(""),this.setState({in_edit_mode:!1,search_end_position:-1,search_start_position:-1})},_initializeInputWithText:function(t){var e,n,o;return t=s.sanitize(t,{FORBID_ATTR:["src","href"]}),this._clearInputWithoutBlurring(),this.$text_input.focus(),n=this.$text_input.get(0),o=document.createRange(),n&&(o.setStart(n,0),e=/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/g,t=t.replace(e,function(t){return function(e,n,o){return n=n.trim(),o=o.trim(),t._mentionWrapper(n,o)}}(this)),this.unsafeInsertHtmlAtRange(t,o,!0),!this.state.in_edit_mode)?this.setState({in_edit_mode:!0}):void 0},_componentSetup:function(){return this.contacts_selector=this.refs.contactSelector,this.$mentions_input=e(i.findDOMNode(this.refs.input)),this.$text_input=e(i.findDOMNode(this.refs.textInput))},_logEmailEntered:function(t){var e;if(null!=this.props.contactSearchLogger)return e={sort_variant:null,context:"mentions",contact_type:c.EMAIL,contact_id:t,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(e)},_parseInputTextAndReplace:function(){var t,e;return t=0,e=new RegExp(/@[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/gi),this._parseInputTextWithRegex(e,function(e){return function(n,o){var i,s,a,l,c;return s=n[0],i=n.index,l=s.substring(1),T(l)&&null==r.msie?(c=document.createRange(),c.setStart(o,i),c.setEnd(o,i+s.length),a=e.createMentionObject(l,l),e._addMentionIntoInput(a,c),t++,e._logEmailEntered(l)):void 0}}(this)),t>0?this.setCursorToEndOfInput():void 0},_parseInputTextWithRegex:function(t,n){var o,i,s,a,l,c,u,d;if(i=this.$text_input.html().replace(C,""),null!=i&&""!==i){for(l=this.$text_input[0].childNodes,u=[],s=0,a=l.length;a>s;s++)o=l[s],null!=r.msie&&e(o).is("p")||o.nodeType===Node.TEXT_NODE&&""!==o.nodeValue.trim()?(d=null!=r.msie?e(o).text():o.nodeValue,u.push(function(){var e;for(e=[];null!==(c=t.exec(d));)e.push(n(c,o));return e}())):u.push(void 0);return u}},refreshDropdownDirection:function(){var t;return"function"==typeof(t=this.props).position_contacts_callback?t.position_contacts_callback():void 0},_getEndRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(_)},_getStartRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(y)},_endRangeUnicodeExists:function(){return this._getEndRangeUnicodeIndex()>=0},_startRangeUnicodeExists:function(){return this._getStartRangeUnicodeIndex()>=0},_startAndEndRangeUnicodeExistsAndValid:function(){var t,e;return e=this._getStartRangeUnicodeIndex(),t=this._getEndRangeUnicodeIndex(),e>=0&&t>0&&t>e},_clearStartToEndRangeUnicode:function(){return this._dangerouslyReplaceStartToEndRangeUnicode(""),this._clearRangeUnicode()},_dangerouslyInsertValueBeforeStartUnicode:function(t){var e,n,o,i,r;return this._getStartRangeUnicodeIndex()>=0?(r=this._getStartRangeUnicodeIndex(),n=this.$text_input.html(),e=n.substr(0,r),o=n.substr(r),t=s.sanitize(t),i=""+e+t+o,this._dangerouslySetInputHtml(i)):void 0},_dangerouslyReplaceStartToEndRangeUnicode:function(t){var e,n,o,i,r;return this._startAndEndRangeUnicodeExistsAndValid()?(r=this._getStartRangeUnicodeIndex(),n=this._getEndRangeUnicodeIndex(),i=this.$text_input.html(),o=i.substr(0,r),e=i.substr(n),t=s.sanitize(t),this._dangerouslySetInputHtml(""+o+y+t+_+e)):void 0},_clearRangeUnicode:function(){var t;return t=this.$text_input.html(),t=t.replace(/\u0091/g,""),t=t.replace(/\u0092/g,""),this.$text_input.html(t)},_dangerouslyInsertLiveTextWithRangeUnicode:function(t){var e;return null==r.msie&&this._cleanUpDelimiters(),(this._getStartRangeUnicodeIndex()<0||this._getEndRangeUnicodeIndex()<0)&&(this._clearRangeUnicode(),this._dangerouslySetInputHtml(""+this.$text_input.html()+y+_)),e=this._isSpaceBeforeStartUnicode()?"":" ",t=s.sanitize(t),this._dangerouslyReplaceStartToEndRangeUnicode(""+e+t)},_getRangeBetweenStartEndRangeUnicode:function(){var t,n,o,i,s,a,l,c,u;if(n=this.$text_input.html().replace(C,""),null!=n&&""!==n)for(l=this.$text_input[0].childNodes,i=0,s=l.length;s>i;i++)if(t=l[i],u=null!=r.msie?e(t).text():t.nodeValue,null!=u&&u.length>0&&(c=u.indexOf(y),o=u.indexOf(_),c>=0&&o>0&&o>c))return a=document.createRange(),a.setStart(t,c),a.setEnd(t,o),a},_isSpaceBeforeStartUnicode:function(){var t;return t=this._getStartRangeUnicodeIndex(),t>=0?this._isSpaceBeforeIndex(t):!1},_isSpaceBeforeIndex:function(t){var e;return e=this.$text_input.html(),t>0&&" "===e.substr(t-1,1)||t>=6&&"&nbsp;"===e.substr(t-6,6)},_dangerouslySetInputHtml:function(t){return this.$text_input.html(t)},contactsSelectorPopupHidden:function(){return this.props.showMentionsHelper&&(this._clearStartToEndRangeUnicode(),0===this.$text_input.html().trim().length&&this.state.in_edit_mode&&this._getCaretPosition().top<=0&&this._resetInputToPlaceholderState()),null!=i.findDOMNode(this.refs.textInput)?this.setCursorToEndOfInput():void 0},contactsSelectorPopupShown:function(t){var e,n,o;return this.isMounted()&&this.props.showMentionsHelper?(this.state.in_edit_mode||this._clearDefaultState(),e=null!=t&&null!=(n=t.refs)?n.contactSelectorPopupInput:void 0,null!=(o=i.findDOMNode(e))?o.focus():void 0):void 0},clearContactHighlightedCallback:function(){return this._clearStartToEndRangeUnicode()},contactHighlightedCallback:function(t){var e,n,o;return o=(null!=t?t.data("name"):void 0)||"",n=(null!=t?t.data("identifier"):void 0)||"",this._dangerouslyInsertLiveTextWithRangeUnicode("@"+o),"function"==typeof(e=this.props).onContactsSelectorSuggestionsUpdate?e.onContactsSelectorSuggestionsUpdate():void 0},_contactSelectedCallback:function(t){var e;return this._addMentionIntoInput(this.createMentionObjectFromSuggestion(t)),"function"==typeof(e=this.props).contactSelectedCallback?e.contactSelectedCallback(this.isInNoAtMentionMode):void 0},addMentionIntoRangeUnicode:function(t){var e;return this._isSpaceBeforeStartUnicode()||this._dangerouslyInsertValueBeforeStartUnicode(" "),e=this._getRangeBetweenStartEndRangeUnicode(),e?(this._addMentionIntoInput(t,e),this._clearRangeUnicode()):void 0},_noAtMentionTriggerCallback:function(t){var e;if(this.props.enableNoAtMentions){if(!this.state.show_contacts&&t>0)return this.refreshDropdownDirection(),this.setState({show_contacts:!0}),this.isInNoAtMentionMode=!0,"function"==typeof(e=this.props).onNoAtSignKeyPress?e.onNoAtSignKeyPress():void 0;if(this.isInNoAtMentionMode&&0===t)return this.setState({show_contacts:!1}),this.isInNoAtMentionMode=!1}},setCursorToEndOfInput:function(){return setTimeout(function(t){return function(){var e,n;return t.focusInput(),e=t.$text_input[0].lastChild,null!=e?(n=document.createRange(),n.selectNode(e),n=n.cloneRange(),n.setStartAfter(e),n.collapse(!1),t._selection().removeAllRanges(),t._selection().addRange(n)):void 0}}(this),10)},_getCaretPosition:function(){var t,e,n,o;return e=null!=(o=i.findDOMNode(this.refs.container))?o.getClientRects()[0]:void 0,t={left:this.state.x_offset,top:this.state.y_offset},this._selection().rangeCount>0&&(n=this._selection().getRangeAt(0).getClientRects()[0],null!=n&&null!=e&&(t.left=n.left-e.left,this.props.shouldPopupsDropdown?t.top=n.bottom-e.top:t.top=n.top-e.top)),t},unsafeInsertHtmlAtRange:function(t,n,o){var i,s,r,a;for(n.deleteContents(),a=e("<span />").html(t)[0],i=document.createDocumentFragment();r=a.firstChild;)s=i.appendChild(r);return n.insertNode(i),s&&o&&(n=n.cloneRange(),n.setStartAfter(s),n.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(n)),s},_checkEndOfLine:function(){var t,n,o,i,s;return a.assert(null!=r.mozilla,"_checkEndOfLine called from non mozilla browser"),i=this._extractCursorInfo(),n=i[0],o=i[1],s=i[2],e(n).hasClass("text-input")&&e(this.$text_input.contents()[o]).is("br")&&o>0&&(t=this.$text_input.contents()[o-1],t.nodeType===Node.TEXT_NODE&&t.nodeValue===b)?this._setCursorLocation(t,0):void 0},_selection:function(){return window.getSelection()},_setCursorLocation:function(t,n){var o;if(null!=t){if(o=document.createRange(),t.nodeType===Node.TEXT_NODE)o.setStart(t,n);else{if(!e(t).hasClass("new-mention"))return;0===n?o.setStartBefore(t):o.setStartAfter(t)}return o.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(o)}},_updateCurrentWordBoundary:function(){var t,e,n,o,i,s,r;return o=this._extractCursorInfo(),e=o[0],n=o[1],i=o[2],r=i.slice(0,n).lastIndexOf(" ")+1,t=i.slice(0,n).lastIndexOf(v)+1,t>r&&(r=t),s=i.slice(n).indexOf(" "),s=-1===s?i.length:n+s,this.currentCursorWordStartPosition=r,this.currentCursorWordEndPosition=s},_cleanMentionHighlighting:function(t){var n,o,i,s,r;for(null==t&&(t=null),o=this.$text_input.children(),null!=t&&(o=[t]),r=[],i=0,s=o.length;s>i;i++)n=o[i],r.push(e(n).removeClass("selected"));return r;
},_cleanUpNbsp:function(){var t;return t=this.$text_input.html(),t=t.replace(/\u00a0/g," "),t=t.replace(/\s{2,}/g," "),this.$text_input.html(t)},_cleanUpDelimiters:function(){var t,n,o,i,l,c,u,d,p,h;for(a.assert(null==r.msie,"_cleanUpDelimiters() called from MSIE"),c=this._extractCursorInfo(),i=c[0],l=c[1],h=c[2],u=this.$text_input.contents(),n=0,o=u.length;o>n;n++)t=u[n],t.nodeType===Node.TEXT_NODE?(t.nodeValue=t.nodeValue.replace(C,""),""===t.nodeValue&&(t!==i?t.parentNode.removeChild(t):l=0)):e(t).hasClass("new-mention")&&(p=document.createTextNode(s.sanitize(b)),t.parentNode.insertBefore(p,t),d=document.createTextNode(s.sanitize(b)),t.parentNode.insertBefore(d,t.nextSibling));return null!=i&&i.nodeType===Node.TEXT_NODE&&i.nodeValue.length<l&&(l=i.nodeValue.length),this._setCursorLocation(i,l),null==r.mozilla&&null!=i&&""===i.nodeValue?i.parentNode.removeChild(i):void 0},_checkAndMergeAdjacentNodes:function(){var t,n,o,i,s,l,c,d,p,h;return a.assert(null!=r.msie,"_checkAndMergeAdjacentNodes called from non IE browser"),d=this._extractCursorInfo(),s=d[0],l=d[1],h=d[2],!e(s).hasClass("text-input")&&!e(s).is("p")||(p=event.keyCode)!==u.BACKSPACE&&p!==u.DELETE||(t=e(s).contents()[l],(null!=t?t.nodeType:void 0)!==Node.TEXT_NODE)?void 0:(o=t.nodeValue,n=0,c=t.previousSibling,i=t.nextSibling,null!=c&&c.nodeType===Node.TEXT_NODE&&(n=c.nodeValue.length,o=c.nodeValue+o,c.parentNode.removeChild(c)),null!=i&&i.nodeType===Node.TEXT_NODE&&(o+=i.nodeValue,i.parentNode.removeChild(i)),t.nodeValue=o,this._setCursorLocation(t,n))},_isCursorAfterSpaceOrBeginningOfLine:function(t,e){var n;if(e-1>=0){if(n=t.slice(e-1,e)," "===n||""===n||" "===n)return!0}else if(0===e)return!0;return!1},_extractCursorInfo:function(){var t,e,n;return t=this._selection().focusNode,e=this._selection().focusOffset,n="",null!=t&&t.nodeType===Node.TEXT_NODE&&(n=t.nodeValue.length?t.nodeValue:""),[t,e,n]},_clearDefaultState:function(){return this.state.default_state&&this._clearInputWithoutBlurring(),this.state.in_edit_mode?void 0:this.setState({in_edit_mode:!0})},_clearInputWithoutBlurring:function(){return null!=r.msie?this.$text_input[0].innerText="":this.$text_input[0].textContent=""},clearTextField:function(){return this._clearInputWithoutBlurring(),this.setState({in_edit_mode:this.props.shouldAlwaysInEditMode}),this.$text_input.blur()},_onInputKeydownMozilla:function(t){var e,n,o,i,s,l,c,d;if(a.assert(null!=r.mozilla,"_onInputKeydownMozilla called from non mozilla browser"),this._cleanUpDelimiters(),this._checkEndOfLine(),s=this._extractCursorInfo(),n=s[0],o=s[1],d=s[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(i=n.previousSibling,e=n.nextSibling,(l=t.keyCode)===u.DELETE||l===u.RIGHT){if(d===b&&null!=e&&this._toggleMentionSelectState(e,t))return this._setCursorLocation(n,1);if(d.length!==o||null==e||e.nodeType!==Node.TEXT_NODE||e.nodeValue!==b)return this._cleanMentionHighlighting();if(null!=e.nextSibling&&this._toggleMentionSelectState(e.nextSibling,t))return this._setCursorLocation(e,1)}else if(((c=t.keyCode)===u.BACKSPACE||c===u.LEFT)&&0===o&&null!=i){if(d===b&&this._toggleMentionSelectState(i,t))return this._setCursorLocation(n,0);if(i.nodeType===Node.TEXT_NODE&&i.nodeValue===b&&null!=i.previousSibling&&this._toggleMentionSelectState(i.previousSibling,t))return this._setCursorLocation(i,0)}},_onInputKeydownMsie:function(t){var n,o,i,s,l,c,d,p,h,m,_;if(a.assert(null!=r.msie,"_onInputKeydownMsie called from non MSIE browser"),c=this._extractCursorInfo(),i=c[0],s=c[1],_=c[2],null!=i){if(e(i).hasClass("text-input")||e(i).is("p"))return n=e(i).contents(),((d=t.keyCode)===u.BACKSPACE||d===u.LEFT)&&s>0&&e(n[s-1]).hasClass("new-mention")?this._toggleMentionSelectState(n[s-1],t):(p=t.keyCode)!==u.DELETE&&p!==u.RIGHT||!e(n[s]).hasClass("new-mention")?this._cleanMentionHighlighting():this._toggleMentionSelectState(n[s],t);if(l=i.previousSibling,o=i.nextSibling,(h=t.keyCode)===u.BACKSPACE||h===u.LEFT){if(0===s&&null!=l&&e(l).hasClass("new-mention"))return this._toggleMentionSelectState(l,t)}else{if((m=t.keyCode)!==u.DELETE&&m!==u.RIGHT)return this._cleanMentionHighlighting();if(s===_.length&&null!=o&&e(o).hasClass("new-mention"))return this._toggleMentionSelectState(o,t)}}},_onInputKeydownWebkit:function(t){var e,n,o,i,s,l,c,d;if(a.assert(null!=r.webkit,"_onInputKeydownWebkit called from non webkit browser"),this._cleanUpDelimiters(),s=this._extractCursorInfo(),n=s[0],o=s[1],d=s[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(i=n.previousSibling,e=n.nextSibling,(l=t.keyCode)===u.BACKSPACE||l===u.LEFT){if(null!=i&&d===b&&this._toggleMentionSelectState(i,t)){if(t.keyCode===u.BACKSPACE)return this._setCursorLocation(n,o-1);if(t.keyCode===u.LEFT)return this._setCursorLocation(i.previousSibling,1)}}else{if((c=t.keyCode)!==u.DELETE&&c!==u.RIGHT)return this._cleanMentionHighlighting();if(o!==d.length||null==e||e.nodeType!==Node.TEXT_NODE||e.nodeValue!==b&&0!==e.nodeValue.length){if(d===b&&0===o&&null!=e&&this._toggleMentionSelectState(e,t)){if(t.keyCode===u.DELETE)return this._setCursorLocation(n,1);if(t.keyCode===u.RIGHT)return this._setCursorLocation(e,1)}}else if(null!=e.nextSibling&&this._toggleMentionSelectState(e.nextSibling,t)){if(t.keyCode===u.DELETE)return this._setCursorLocation(e,1);if(t.keyCode===u.RIGHT)return this._setCursorLocation(e.nextSibling,1)}}},_onInputKeydown:function(e){var n,o,i,s,a,l,c,d;if(s=this._normalizeKeycode(e),this.setState({default_state:!1,last_keydown:s}),s!==u.PROCESSING)if(!(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)||s!==u.BACKSPACE&&s!==u.DELETE&&s!==u.LEFT&&s!==u.RIGHT?this._cleanMentionHighlighting():null!=r.webkit?this._onInputKeydownWebkit(e):null!=r.mozilla?this._onInputKeydownMozilla(e):null!=r.msie&&this._onInputKeydownMsie(e),"function"==typeof(n=this.props).onKeyDown&&n.onKeyDown(e),c=this._extractCursorInfo(),a=c[0],l=c[1],d=c[2],this.state.show_contacts){if(t.call(w,s)>=0){if(e.preventDefault(),s===u.ESC||0===this.contacts_selector.get_suggestions_count()&&s===u.ENTER)return this.setState({show_contacts:!1})}else if(s===u.BACKSPACE&&(null!=a?a.nodeType:void 0)===Node.TEXT_NODE&&l>0&&(i=d.substr(l-1,1),"@"===i&&this._isCursorAfterSpaceOrBeginningOfLine(d,l-1)))return this.setState({show_contacts:!1})}else if(s===u.ESC)return"function"==typeof(o=this.props).onCancel?o.onCancel():void 0},_onInputKeypress:function(t){var n,o,i,s,a,l,c,d,p;return d=this._extractCursorInfo(),l=d[0],c=d[1],p=d[2],this._normalizeKeycode(t)===u.AT_SIGN&&!this.state.mention_triggered&&("function"==typeof(n=this.props).position_contacts_callback&&n.position_contacts_callback(),s=!1,l.nodeType===Node.TEXT_NODE?this._isCursorAfterSpaceOrBeginningOfLine(p,c)&&(s=!0,i=c):(e(l).hasClass("text-input")||null!=r.msie&&e(l).is("p"))&&(s=!0,i=0),s)?(a={search_start_position:i,search_end_position:i,mention_triggered:!0},this.setState(a),"function"==typeof(o=this.props).onAtSignKeyPress?o.onAtSignKeyPress():void 0):void 0},_onInputKeyup:function(e){var n,o,i,s,l,c,d,p,h,m,_,f;if(this.state.last_keydown===u.PROCESSING)return void a.assert(null!=r.webkit,"PROCESSING keycode detected in non-webkit browser");if(null!=r.msie&&this._checkAndMergeAdjacentNodes(),p=this._extractCursorInfo(),l=p[0],c=p[1],f=p[2],this.props.enableNoAtMentions&&this._updateCurrentWordBoundary(),s={},this.state.mention_triggered&&(s.mention_triggered=!1,s.show_contacts=!0,c-this.state.search_start_position>1&&(o=f.slice(this.state.search_start_position+1,c).indexOf("@"),s.show_contacts=-1===o)),!this.state.show_contacts&&!s.show_contacts||this.isInNoAtMentionMode)this.props.enableNoAtMentions&&(m=e.keyCode,t.call(w,m)>=0&&this.state.show_contacts&&this.contacts_selector.get_suggestions_count()>0?this.contacts_selector.navigate_suggestions(e):e.keyCode!==u.ESC&&this.contacts_selector.get_suggestions(f.slice(this.currentCursorWordStartPosition,this.currentCursorWordEndPosition).trim(),!1));else if(h=e.keyCode,t.call(w,h)>=0&&this.contacts_selector.get_suggestions_count()>0)this.contacts_selector.navigate_suggestions(e);else if(c<=this.state.search_start_position||l.nodeType!==Node.TEXT_NODE)s.show_contacts=!1;else if(e.keyCode===u.SPACE)if(d=this._parseMentionQuery(f,this.state.search_end_position).trim(),0!==d.length){if(T(d))return i=this.createMentionObject(d),this._addMentionIntoInput(i),void this._logEmailEntered(d);this.contacts_selector.get_suggestions(d,!0)}else this.setState({show_contacts:!1});else this.contacts_selector.get_suggestions(this._parseMentionQuery(f,c).trim(),!0);return e.keyCode!==u.ENTER&&e.keyCode!==u.TAB&&(e.keyCode!==u.SPACE||this.state.show_contacts||s.show_contacts)||this._parseInputTextAndReplace(),null==r.msie&&(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)&&this._cleanUpDelimiters(),"function"==typeof(n=this.props).onKeyUp&&n.onKeyUp(e),_=this._normalizeKeycode(e),t.call(w,_)>=0&&this.state.show_contacts?void 0:this.setState(s,function(t){return function(){var e;return"function"==typeof(e=t.props).resizeCallback?e.resizeCallback():void 0}}(this))},_normalizeKeycode:function(t){return t.keyCode||t.which||t.charCode},_onInputBlur:function(t){var e,n;return this._parseInputTextAndReplace(),"function"==typeof(e=this.props).onBlur&&e.onBlur(),n={show_contacts:!1,default_state:!1},!this.state.in_edit_mode||this.getEncodedMessage().length||this.props.shouldAlwaysInEditMode||(n.in_edit_mode=!1,n.search_end_position=-1,n.search_start_position=-1),this.setState(n)},_onInputFocus:function(t){var e,n;return t.target===this.$text_input.get(0)?("function"==typeof(e=this.props).onFocus&&e.onFocus(),n={show_contacts:!1},this.state.in_edit_mode||(n.in_edit_mode=!0,n.search_end_position=-1,n.search_start_position=-1),setTimeout(function(t){return function(){return t.isMounted()?t.setState(n):void 0}}(this),0)):void 0},_onInputMouseDown:function(t){return this.setState({default_state:!1}),this._cleanMentionHighlighting()},_onInputPaste:function(t){var e;return this.setState({default_state:!1}),"function"==typeof(e=this.props).onPaste?e.onPaste(t):void 0},createMentionObjectFromSuggestion:function(t){var e,n,o;return o=t.data("name"),n=t.data("identifier"),e=t.data("dbx-account-id"),this.createMentionObject(n,o,e)},createMentionObject:function(t,e,n){return null==e&&(e=null),null==n&&(n=null),e||(e=t),n&&(t=n),{name:e,identifier:t,dbx_account_id:n}},_toggleMentionSelectState:function(t,n){if(e(t).hasClass("new-mention")){if(e(t).hasClass("selected"))return this._cleanMentionHighlighting(t),!0;n.stopPropagation(),n.preventDefault(),e(t).addClass("selected")}return!1},_onMentionMouseDown:function(t){var e;return t.preventDefault(),t.stopPropagation(),0===t.button?(this._cleanMentionHighlighting(),this._toggleMentionSelectState(t.target,t),e=document.createRange(),e.selectNode(t.target),this._selection().removeAllRanges(),this._selection().addRange(e)):null!=r.mozilla&&2===t.button?this._setCursorLocation(t.target,1):void 0},_mentionWrapper:function(t,e,n){return null!=r.webkit?"<span class='new-mention' data-id=\""+t+'" data-name="'+e+'" data-dbx-account-id="'+n+'">'+e+"</span>":'<input type="button" class=\'new-mention\' data-id="'+t+'" data-name="'+e+'" data-dbx-account-id="'+n+'" value="'+e+'"></input>'},_parseMentionQuery:function(t,e){var n;return e>this.state.search_end_position?this.setState({search_end_position:e}):e=this.state.search_end_position,n="",e<=t.length?n=t.slice(this.state.search_start_position,e):this.state.search_start_position<=t.length&&(this.setState({search_end_position:t.length}),n=t.slice(this.state.search_start_position)),n.replace("@","")},_addMentionIntoInput:function(t,n){var o,a,l,c,u,d,p,h,m,_,f,y;return d=i.findDOMNode(this.refs.textInput),y=this._mentionWrapper(t.identifier,t.name,t.dbx_account_id),h=e(s.sanitize(y))[0],null!=r.webkit?h.setAttribute("contenteditable","false"):null!=r.mozilla&&h.setAttribute("style","margin-left:-3px; margin-right:-3px"),e(h).mousedown(function(t){return function(e){return t._onMentionMouseDown(e)}}(this)),null==n&&(p=this._extractCursorInfo(),c=p[0],u=p[1],f=p[2],n=document.createRange(),_=this.state.search_start_position,a=this.state.search_end_position,this.state.show_contacts||(this.setState({search_start_position:c.length}),this.setState({search_end_position:c.length}),_=c.length,a=c.length),this.isInNoAtMentionMode&&(_=this.currentCursorWordStartPosition,a=this.currentCursorWordEndPosition),n.setStart(c,_),n.setEnd(c,a)),h=this.unsafeInsertHtmlAtRange(h,n,!0),l=h.nextSibling,null!=l&&l.nodeType===Node.TEXT_NODE?(l.nodeValue=v+l.nodeValue,this._setCursorLocation(l,1)):(m=document.createTextNode(s.sanitize(v)),e(m).insertAfter(h),this._setCursorLocation(m,1)),"function"==typeof(o=this.props).onMention&&o.onMention(t),this.setState({show_contacts:!1})},focusInput:function(){var t;return this.setState({in_edit_mode:!0}),t=i.findDOMNode(this.refs.textInput),t.focus()},disableMentions:function(){return this.state.show_contacts?this.setState({show_contacts:!1}):void 0},mentionsEnabled:function(){return this.state.show_contacts},_encodedMention:function(t){return"@[%(identifier)s:%(name)s]".format({identifier:t.identifier,name:t.name})},extractMentions:function(){var t,n,o,i,s,r,a,l;for(r=this.$text_input.find(".new-mention"),a=[],n=0,i=r.length;i>n;n++)s=r[n],o=e(s).data("id"),l=e(s).data("name"),t=e(s).data("dbx-account-id"),a.push(this.createMentionObject(o,l,t));return a},_encodeHtml:function(t){var n,o,i,s,r,a,l,c,u;if(i="",s=!1,t=t.replace(C,""),null!=t&&""!==t)for(c=e.parseHTML(t),r=0,a=c.length;a>r;r++)n=c[r],n.nodeType===Node.TEXT_NODE&&""!==n.nodeValue?(s=!0,i+=n.nodeValue):n instanceof HTMLParagraphElement?(s=!0,i=i+this._encodeHtml(e(n).html())+"\n"):e(n).hasClass("new-mention")?(s=!0,o=e(n).data(),l=this.createMentionObject(o.id,o.name),i+=this._encodedMention(l)):e(n).is("br")?i+="\n":e(n).is("div")?(u=e(n).text(),s=s||u.length>0,i=i+"\n"+u):(u=e(n).text(),s=s||u.length>0,i+=u);return i!==this.props.placeholder_text&&s?i:""},getRawMessage:function(){return this.$text_input.html()},getEncodedMessage:function(){var t;return t=this.$text_input.html(),this._encodeHtml(t)},render:function(){var t,e,o,i,s,a,l,c;return e={"text-input":!0,"edit-mode":this.state.in_edit_mode},s=n(e),o=!0,null!=r.webkit&&(o="plaintext-only"),t={ref:"textInput","aria-label":this.props.placeholder_text,"aria-multiline":!0,className:s,contentEditable:o,defaultValue:this.props.initialText,onKeyPress:this._onInputKeypress,onKeyDown:this._onInputKeydown,onKeyUp:this._onInputKeyup,onFocus:this._onInputFocus,onBlur:this._onInputBlur,onPaste:this._onInputPaste,onMouseDown:this._onInputMouseDown,role:"textbox"},i=g.div({className:"mention-text-input-wrapper"},g.div({className:"placeholder-text","aria-hidden":!0},this.props.showPlaceholderText?this.props.placeholder_text:void 0),g.div(t)),c=m({ref:"contactSelector",contactSelectedCallback:this._contactSelectedCallback,noAtMentionTriggerCallback:this._noAtMentionTriggerCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.shouldPopupsDropdown,y_offset:this.state.y_offset,x_offset:this.state.x_offset,user:this.props.user,last_keydown:this.state.last_keydown,resultsLimit:this.props.resultsLimit,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),a=n({"mentions-container":!0}),l=n({"mentions-input":!0,"animating-highlight":this.props.shouldInitiallyFocusInput&&!this.props.shouldAlwaysInEditMode}),g.div({className:a,ref:"container"},g.div({className:l,ref:"input"},i),c)}})})}.call(this),function(){define("modules/clean/react/activity/resolve_button",["external/classnames","external/react","modules/core/i18n","modules/core/notify","modules/clean/components/title_bubble","modules/clean/react/sprite"],function(t,e,n,o,i,s){var r,a,l;return a=n._,l=e.DOM,r=e.createClass({displayName:"ResolveButton",propTypes:{resolved:e.PropTypes.bool.isRequired,onUpdateResolve:e.PropTypes.func.isRequired,isOffline:e.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1}},_updateResolved:function(t){var e;return t.stopPropagation(),this.props.isOffline?(e=a(this.props.resolved?"Cannot unresolve comments while offline":"Cannot resolve comments while offline"),o.error(e)):this.props.onUpdateResolve(!this.props.resolved)},render:function(){var n,o;return n=a(this.props.resolved?"Unresolve":"Resolve"),o=t({"resolve-conversation-checkmark":!0,resolved:this.props.resolved}),e.createElement(i,{className:o,text:n,direction:"south"},l.button({className:"resolve-button","aria-pressed":this.props.resolved,onClick:this._updateResolved},l.div({className:"resolved-icon"},this.props.resolved?e.createElement(s,{group:"web",name:"s_greencheck",alt:a("Resolve")}):e.createElement(s,{group:"web",name:"s_greycheck",alt:a("Resolve")}))))}})})}.call(this),function(){define("modules/clean/react/activity/time_counter",["external/react","modules/clean/datetime"],function(t,e){var n,o;return o=t.DOM,n=t.createClass({displayName:"TimeCounter",render:function(){var t;return t=e.ago(new Date(this.props.when_mses)),o.div({className:"activity-time-ago"},t)},updateLoop:function(){},componentDidMount:function(){return this.updateLoop()},getUpdateInterval:function(){return 5e3}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify",["external/react","modules/core/i18n","modules/clean/react/tooltip"],function(t,e,n){var o,i,s,r,a;return s=e._,a=e.ungettext,r=t.DOM,o=t.createFactory(n.Tooltip),i=t.createClass({displayName:"UsersToNotify",propTypes:{usersToNotify:t.PropTypes.array.isRequired,user:t.PropTypes.object.isRequired,shouldPopupsDropdown:t.PropTypes.bool},render:function(){var t,e,i,l,c,u,d,p;return t=null==this.props.usersToNotify?[]:this.props.user.is_signed_in?function(){var t,e,n,o;for(n=this.props.usersToNotify,o=[],t=0,e=n.length;e>t;t++)p=n[t],p.id!==this.props.user.id&&o.push(p);return o}.call(this):function(){var t,e,n,o;for(n=this.props.usersToNotify,o=[],t=0,e=n.length;e>t;t++)p=n[t],p.id!==this.props.user.id&&o.push(p);return o}.call(this),e=t.length,e>0?(u=r.div({className:"notification-names-container"},function(){var e,n,o;for(o=[],e=0,n=t.length;n>e;e++)p=t[e],o.push(function(t){return function(t){return r.div({key:t.id},t.getDisplayIdentity())}}(this)(p));return o}.call(this)),l=1===e?s('<span class="blue">%(name)s</span> will be notified.').format({name:t[0].getDisplayIdentity()}):2===e?s('<span class="blue">%(name)s and %(name2)s</span> will be notified.').format({name:t[0].getDisplayIdentity(),name2:t[1].getDisplayIdentity()}):a('<span class="blue">%(name)s and %(num)s other person</span> will be notified.','<span class="blue">%(name)s and %(num)s others</span> will be notified.',e-1).format({name:t[0].getDisplayIdentity(),num:e-1}),i=r.div({dangerouslySetInnerHTML:{__html:l},className:"comment-box-text"}),d=this.props.shouldPopupsDropdown?n.TooltipPosition.BOTTOM:n.TooltipPosition.TOP,e>2?o({position:d,tooltip_contents:u,tooltip_classname:"notification-names-tooltip"},i):i):(c=s("@Mention to notify someone."),r.div({className:"comment-box-text"},c))}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify_facepile",["external/react","modules/core/i18n","modules/clean/react/tooltip","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar"],function(t,e,n,o,i){var s,r,a,l,c,u,d;return c=e._,d=e.ungettext,r=n.Tooltip,a=n.TooltipPosition,u=t.DOM,s=6,l=t.createClass({propTypes:{usersToNotify:t.PropTypes.array.isRequired,user:t.PropTypes.object.isRequired},render:function(){var e,n,l,c,d,p,h,m,_,f,v;for(l=function(){var t,e,n,o;for(n=this.props.usersToNotify,o=[],t=0,e=n.length;e>t;t++)v=n[t],o.push(v);return o}.call(this),e=[],_=[],c=function(t){return function(t){return s>d?e.push(t):_.push(t)}}(this),d=p=0,h=l.length;h>p;d=++p)v=l[d],c(v);return u.div({className:"notify-facepile-container"},function(){var s,l,c;for(c=[],s=0,l=e.length;l>s;s++)v=e[s],n=u.div({},v.display_name),c.push(u.div({className:"notify-facepile-photo",key:v.id},t.createElement(r,{position:a.BOTTOM,tooltip_contents:n,tooltip_classname:"notification-names-tooltip"},t.createElement(i,{alt:v.display_name,dimension:32,photoUrl:v.photo_circle_url,defaultAvatar:t.createElement(o,{alt:v.display_name,dimension:32,shape:"CIRCLE",initials:v.initials}),key:v.id}))));return c}(),l.length>s?(f=u.div({},function(){var t,e,n;for(n=[],t=0,e=_.length;e>t;t++)m=_[t],n.push(u.div({},m.get_display_identity()));return n}()),t.createElement(r,{position:a.BOTTOM,tooltip_contents:f,tooltip_classname:"notification-names-tooltip"},u.div({className:"notify-facepile-more"},"+"+(l.length-s)))):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/annotation_bubble",["external/classnames","external/react","modules/clean/comments/action_creators","modules/clean/comments/annotation_utils","modules/clean/comments/components/ui_constants","modules/clean/react/file_comments/conversation_or_input_card","modules/clean/react/sprite","modules/constants/comments_panel","modules/core/i18n"],function(t,e,n,o,i,s,r,a,l){var c,u,d,p,h;return u=i.DEFAULT_ANNOTATION_COMMENT_INPUT_MAX_HEIGHT,d=s.InputCard,p=l._,h=e.DOM,c=e.createClass({displayName:"AnnotationBubble",mixins:[e.addons.PureRenderMixin],propTypes:{user:e.PropTypes.object,activity:e.PropTypes.object,x:e.PropTypes.number,y:e.PropTypes.number,showBubble:e.PropTypes.bool,in_blank_state:e.PropTypes.bool,annotation:e.PropTypes.object,position:e.PropTypes.string,maxHeight:e.PropTypes.number,shouldShowExpandBubble:e.PropTypes.bool,isMouseOnAnnotation:e.PropTypes.bool,commentText:e.PropTypes.string},getInitialState:function(){return{showExpandBubble:this.props.shouldShowExpandBubble}},getDefaultProps:function(){return{position:"top",maxHeight:u}},componentWillReceiveProps:function(t){if(this.props.shouldShowExpandBubble)if(t.commentText||this.props.showBubble!==!1||t.showBubble!==!0||this.setState({showExpandBubble:!0}),this.props.isMouseOnAnnotation){if(!t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseLeave()}else if(t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseEnter()},componentWillUnmount:function(){return clearTimeout(this.hideBubbleTimeout)},onInputFocus:function(t){return{}},onInputBlur:function(t){return{}},onMention:function(){return n.setMentionedContact(!0)},onAddComment:function(t){return n.addInlineAnnotation({text:t})},onAddSticker:function(t){return n.addInlineAnnotation({stickerId:t})},onCancelComment:function(){return n.cancelAnnotationComment()},_getCommentInputRef:function(){var t;return null!=(t=this.refs.commentInputCard)?t.refs.commentInput:void 0},_focusOnCommentInput:function(){var t;return null!=(t=this._getCommentInputRef())?t.focusInput():void 0},_getRawCommentInput:function(){var t;return(null!=(t=this._getCommentInputRef())?t.getRawCommentInput():void 0)||""},_saveDraft:function(){var t,e;return t=this._getRawCommentInput(),t.length>0&&t!==(null!=(e=this._getCommentInputRef())?e.getPlaceholderText():void 0)?n.updateAnnotationText(t):n.updateAnnotationText(null)},_onAnnotationExpandBubbleClick:function(){return this.setState({showExpandBubble:!1})},_onAnnotationExpandBubbleMouseEnter:function(){return clearTimeout(this.hideBubbleTimeout)},_onAnnotationExpandBubbleMouseLeave:function(){return this._setHideCommentTimeOut()},_setHideCommentTimeOut:function(){return clearTimeout(this.hideBubbleTimeout),this.hideBubbleTimeout=setTimeout(this._maybeHideComment,3e3)},_maybeHideComment:function(){return this.state.showExpandBubble&&!this.props.isMouseOnAnnotation?this.onCancelComment():void 0},_renderCommentInput:function(){var t,n,o;return t={maxHeight:this.props.maxHeight},n={ref:"commentInput",activity:this.props.activity,metadata:this.props.annotation,usersToNotify:this.props.activity.users_to_notify,targetActivity:this.props.activity,user:this.props.user,initialText:this.props.commentText,enableNoNotifyHint:!1,commentMetadataAllowed:!0,shouldPopupsDropdown:!1,shouldAlwaysInEditMode:!0,shouldEnableCancelButton:!1,shouldInitiallyFocusInput:!0,shouldEnableStickers:a.ALLOW_STICKERS,onAddComment:this.onAddComment,onAddSticker:this.onAddSticker,onCancelComment:this.onCancelComment,onFocus:this.onInputFocus,onBlur:this.onInputBlur,onMention:this.onMention,onChange:this._saveDraft},h.div({className:"annotation-bubble__field",style:t},e.createElement(d,{ref:"commentInputCard",shouldInitiallyShowNotifyHint:this.props.shouldShowExpandBubble,initialUsersToNotify:null!=(o=this.props.activity)?o.users_to_notify:void 0,commentProps:n}))},_renderExpandBubble:function(){return h.div({className:"expand-bubble-icon",onClick:this._onAnnotationExpandBubbleClick,onMouseEnter:this._onAnnotationExpandBubbleMouseEnter,onMouseLeave:this._onAnnotationExpandBubbleMouseLeave},e.createElement(r,{group:"web",name:"ic_comment_text",alt:p("Comment on text")}))},render:function(){var e,n,i,s,r,a,l,c,u,d;return u=this.props.x||0,d=this.props.y||0,i=this.props.position,n=this.props.position.indexOf("bottom")>=0?"bottom":"top",this.state.showExpandBubble&&(c=o.getExpandBubblePosition(this.props.position,this.props.x,this.props.y),s=c[0],r=c[1],u=r.x,d=r.y,i=s),a={left:u},a[""+n]=d,e=a,h.div({className:"annotation-bubble-container"},h.div({className:t((l={"annotation-bubble":!0,"annotation-bubble--hidden":!this.props.showBubble,"bubble-dropdown":!0,"expand-bubble":this.state.showExpandBubble},l[""+i]=!0,l)),style:e},this.state.showExpandBubble?this._renderExpandBubble():this._renderCommentInput(),h.div({className:"bubble-arrow-border"}),h.div({className:"bubble-arrow"})))}})})}.call(this),function(){define("modules/clean/react/file_comments/annotation_comments_list_ui_bubble",["jquery","external/classnames","external/react","external/react-dom","modules/clean/activity/activity_user","modules/clean/datetime","modules/clean/keycode","modules/clean/react/file_comments/conversation_or_input_card","modules/clean/comments/action_creators","modules/clean/comments/components/ui_constants","modules/clean/comments/lib/click_outside"],function(t,e,n,o,i,s,r,a,l,c,u){var d,p,h,m,_,f;return d=i.ActivityUser,m=a.ConversationCard,_=c.DEFAULT_ANNOTATION_COMMENT_INPUT_MAX_HEIGHT,h=u.ClickOutside,f=n.DOM,p=n.createClass({displayName:"AnnotationCommentsListUIBubble",mixins:[n.addons.PureRenderMixin],propTypes:{user:n.PropTypes.object,activity:n.PropTypes.object,x:n.PropTypes.number.isRequired,y:n.PropTypes.number.isRequired,annotation:n.PropTypes.object,commentActivity:n.PropTypes.object,position:n.PropTypes.string,maxHeight:n.PropTypes.number,replyText:n.PropTypes.string,onMouseEnter:n.PropTypes.func,onMouseLeave:n.PropTypes.func,onConversationExpand:n.PropTypes.func},getDefaultProps:function(){return{maxHeight:_}},getInitialState:function(){return{button_disabled:!0,show_post_button:!1,initial_text:""}},onConversationExpand:function(){var t;return this._scrollToBottom(),"function"==typeof(t=this.props).onConversationExpand?t.onConversationExpand():void 0},onReplyInputBlur:function(){return l.updateAnnotationReplyFocused(!1)},onReplyInputFocus:function(){return l.updateAnnotationReplyFocused(!0)},_handleOutsideClick:function(t){return l.hideAnnotationConversation()},onCancelComment:function(){return l.cancelAnnotationComment()},onAddReply:function(t,e){return l.addReply({targetActivityKey:e.activity_key,body:{text:t}})},_getReplyCommentInput:function(){var t,e;return null!=(t=this.refs.conversationCard)&&null!=(e=t.refs.threadedCommentActivityUI)?e.refs.commentInput:void 0},_getRawReplyInput:function(){var t;return(null!=(t=this._getReplyCommentInput())?t.getRawCommentInput():void 0)||""},_saveReplyDraft:function(){var t,e,n;return t=this._getRawReplyInput(),n=t.length>0&&t!==(null!=(e=this._getReplyCommentInput())?e.getPlaceholderText():void 0)?t:null,l.updateAnnotationReplyText({activityKey:this.props.commentActivity.activity_key,text:n})},_getRevisionDateTime:function(){var t;return t=this._getRevision(),null==t.when||isNaN(new Date(null!=t.when))?void 0:""+s.ago(new Date(1e3*t.when))},_getRevision:function(){return this.props.commentActivity.comment.comment_metadata.revision},_isOnOldRevision:function(){return!1},_scrollToBottom:function(){var e;return e=o.findDOMNode(this.refs.annotationBubbleField),t(e).animate({scrollTop:e.scrollHeight},{duration:300})},_renderConversation:function(){var t,e;return e={ref:"threadedCommentActivityUI",key:"annotation_bubble_threaded_"+this.props.commentActivity.activity_key,activity:this.props.activity,commentActivity:this.props.commentActivity,user:this.props.user,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldAutoLinkify:!0,onReplyInputFocus:this.onReplyInputFocus,onReplyInputBlur:this.onReplyInputBlur,replyText:this.props.replyText,onCommentExpanded:this.onConversationExpand,isInAnnotationBubble:!0,onCancelComment:this.onCancelComment,onInputChange:this._saveReplyDraft,onAddComment:this.onAddReply},n.createElement(m,{ref:"conversationCard",shouldInitiallyShowNotifyHint:!1,initialUsersToNotify:null!=(t=this.props.commentActivity)?t.users_to_notify:void 0,commentProps:e})},_renderComments:function(){var t,n;return n={"comments-holder":!0},t={maxHeight:this.props.maxHeight},f.div({className:"annotation-bubble__field",ref:"annotationBubbleField",style:t},this._isOnOldRevision()?f.div({className:"annotation-bubble__field__old-revision"},"On older revision, updated "+this._getRevisionDateTime()):void 0,f.div({className:e(n)},f.div({className:"comment-list"},this._renderConversation())))},render:function(){var t,o,i,s;return s=!0,i=s?25:0,o={"annotation-bubble-container":!0,"annotation-bubble-invisible-border":s},t={left:this.props.x-i},this.props.position.indexOf("bottom")>=0?t.bottom=this.props.y-i:t.top=this.props.y-i,n.createElement(h,{onClickOutside:this._handleOutsideClick},f.div({onMouseOver:this.onMouseOver,onMouseLeave:this.props.onMouseLeave,onMouseEnter:this.props.onMouseEnter,className:e(o),style:t},f.div({className:"annotation-bubble bubble-dropdown "+this.props.position},this._renderComments(),f.div({className:"bubble-arrow-border"}),f.div({className:"bubble-arrow"}))))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_card",["external/react","modules/clean/activity/activity_user","modules/clean/react/activity/users_to_notify","modules/core/i18n"],function(t,e,n,o){var i,s,r,a;return i=e.ActivityUser,r=o._,a=t.DOM,s=t.createClass({displayName:"CommentCard",propTypes:{user:t.PropTypes.object,usersToNotify:t.PropTypes.arrayOf(t.PropTypes.instanceOf(i)),shouldShowNotifyHint:t.PropTypes.bool,isOffline:t.PropTypes.bool,shouldPopupsDropdown:t.PropTypes.bool},renderNotifyHint:function(){return this.props.isOffline?a.div({className:"comment-box-text"},r("Posting will be re-enabled when you are online")):a.div({ref:"usersToNotify",className:"tooltip-container"},t.createElement(n,{usersToNotify:this.props.usersToNotify,user:this.props.user,shouldPopupsDropdown:this.props.shouldPopupsDropdown}))},render:function(){return a.div({className:"comment-card-w-hint"},a.div({className:"comment-card"},this.props.children),this.props.shouldShowNotifyHint?this.renderNotifyHint():void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_header",["jquery","external/react","modules/core/i18n","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/users_to_notify_facepile","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger"],function(t,e,n,o,i,s,r){var a,l,c;return l=n._,c=e.DOM,a=e.createClass({displayName:"CommentListHeader",mixins:[e.addons.PureRenderMixin],propTypes:{activity:e.PropTypes.object,user:e.PropTypes.object,commentListOptions:e.PropTypes.node},_contactsSelectorPopupShown:function(){return setTimeout(function(e){return function(){return t(".contacts-selector-popup input").trigger("focus");
}}(this),300)},render:function(){return c.div({className:"comment-list-header-container"},c.div({className:"comment-list-header"},c.div({className:"comment-list-header-inner"},c.span({className:"title"},l("Comments")),c.span({className:"options"}),this.props.commentListOptions)))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_options",["jquery","external/classnames","external/react","modules/core/i18n","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger","modules/clean/react/sprite_div","modules/clean/comments/action_creators","modules/clean/comments/events","modules/clean/comments/utils","modules/constants/legacy"],function(t,e,n,o,i,s,r,a,l,c,u){var d,p,h,m,_,f;return _=o._,h=l.CommentsEvents,f=n.DOM,d=n.createFactory(i),m=n.createFactory(r),p=n.createClass({displayName:"CommentListOptions",mixins:[n.addons.PureRenderMixin],propTypes:{activity:n.PropTypes.object,show_resolved:n.PropTypes.bool.isRequired,num_resolved:n.PropTypes.number.isRequired,is_subscribed:n.PropTypes.bool.isRequired,feedback_off:n.PropTypes.bool.isRequired,activity_context:n.PropTypes.number.isRequired,shouldShowDisableButton:n.PropTypes.bool.isRequired,shouldShowHideButton:n.PropTypes.bool.isRequired,user:n.PropTypes.object,isOffline:n.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1,num_resolved:0}},_hide_comments:function(t){return this.refs.dropdown.hide(),null!=this.props.activity&&s.log_event(u.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_COMMENTS_HIDDEN,this.props.activity.activity_key,null,null,this.props.user.id,this.props.activity_context),a.hideComments(),h.emit("hide-comments-pane")},_toggle_show_resolved:function(){return 0===this.props.num_resolved||this.props.feedback_off?void 0:(this.refs.dropdown.hide(),this.props.show_resolved?a.hideResolvedComments():a.showResolvedComments())},_isSubscribeDisabled:function(){return this.props.feedback_off||this.props.isOffline},_toggle_subscribe:function(){return this._isSubscribeDisabled()?void 0:(this.refs.dropdown.hide(),a.setCommentSubscribed({subscribed:!this.props.is_subscribed}))},_isFeedbackSettingDisabled:function(){return this.props.isOffline},_turn_off_feedback:function(){return this._isFeedbackSettingDisabled()?void 0:(this.refs.dropdown.hide(),a.setCommentsEnabled({enabled:!1}))},render:function(){var t,n,o,i,s,r,a,l,c,u,p;return i=[],this.props.shouldShowHideButton&&(o=f.a({key:"hide",className:"comments-header-menu-option hide",onMouseUp:this._hide_comments},m({group:"web",name:"s_hide",text:_("Hide comments")})),i.push(o)),a=_(this.props.show_resolved?"Hide resolved comments":"Show resolved comments"),s=e({"comments-header-menu-option":!0,"toggle-resolved":!0,disabled:0===this.props.num_resolved||this.props.feedback_off}),r=f.a({key:"resolved",className:s,onMouseUp:this._toggle_show_resolved},m({group:"web",name:"s_resolve",text:a})),i.push(r),this.props.is_subscribed?(p=_("Unsubscribe from notifications"),c="s_notifications_off"):(p=_("Subscribe to notifications"),c="s_notifications_on"),l=e({"comments-header-menu-option":!0,"toggle-subscribe":!0,disabled:this._isSubscribeDisabled()}),u=f.a({key:"subscribe",className:l,onMouseUp:this._toggle_subscribe},m({group:"web",name:c,text:p})),i.push(u),this.props.shouldShowDisableButton&&(t=e({"comments-header-menu-option":!0,"toggle-feedback-setting":!0,disabled:this._isFeedbackSettingDisabled()}),n=f.a({key:"toggle-feedback-setting",className:t,onMouseUp:this._turn_off_feedback},m({group:"web",name:"s_disable",text:_("Disable comments")})),i.push(n)),f.span({className:"options"},d({ref:"dropdown",targetButton:f.button({className:"button-as-link"},_("Options")),arrow_position:"top-right",vertical_displacement:8,extra_css_class:"comments-header-bubble-dropdown"},i))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_ui",["jquery","external/react","external/react-dom","external/underscore","external/classnames","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/annotations/annotation","modules/clean/components/loading_indicator","modules/clean/comments/events","modules/clean/comments/store","modules/clean/gandalf_util","modules/clean/previews/util","modules/clean/react/button","modules/clean/react/file_comments/comment_list_header","modules/clean/react/file_comments/comment_list_options","modules/clean/react/file_comments/conversation_or_input_card","modules/clean/react/file_comments/comment_tutorial","modules/clean/react/image","modules/clean/react_format","modules/clean/react/sprite","modules/clean/static_urls","modules/clean/comments/action_creators","modules/clean/comments/collection_utils","modules/clean/comments/components/ui_constants","modules/constants/comments_panel"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f,v,y,g,b,C,w,T,S,A){var E,N,I,x,P,k,M,R,O,D,L,U,B,F,H,V,q,W,j,K,z,G,Y,$,X,Q,J,Z;return $=s._,Z=s.ungettext,N=r.ActivityUser,I=a.Annotation,D=c.CommentsEvents,q=p.PermissionHelper,L=f.ConversationCard,H=f.InputCard,Q=g.reactFormat,J=C.static_url,Y=S.TUTORIAL_INITIATOR,G=S.TUTORIAL_CREATE_ANNOTATION,X=e.DOM,W=e.addons.CSSTransitionGroup,x=e.createFactory(h.button),k=e.createFactory(m),M=e.createFactory(_),O=e.createFactory(v),F=e.createFactory(y),W=e.createFactory(W),z=e.createFactory(b),j=300,K=500,P=".comments-holder",E=100,B=90,U=70,V=2,R=e.createClass({displayName:"CommentListUI",mixins:[e.addons.PureRenderMixin],propTypes:{context:e.PropTypes.number.isRequired,activity:e.PropTypes.object,showLoadingSpinner:e.PropTypes.bool,contactSearchLogger:e.PropTypes.object,user:e.PropTypes.object,shouldInitiallyFocusInput:e.PropTypes.bool,showBottomBar:e.PropTypes.bool,showResolvedComments:e.PropTypes.bool,isUserSubscribed:e.PropTypes.bool,shouldShowHideButton:e.PropTypes.bool,shouldAutoLinkify:e.PropTypes.bool,enableImport:e.PropTypes.bool,shouldUseSimpleModals:e.PropTypes.bool,shouldHidePhotoAvatars:e.PropTypes.bool,isOffline:e.PropTypes.bool,shouldAnnotationButtonUseThumbnailUrls:e.PropTypes.bool,initialCommentsCount:e.PropTypes.number,shouldDisplayRegionCreationButton:e.PropTypes.bool,isRegionCreationEnabled:e.PropTypes.bool,showTutorial:e.PropTypes.bool,currentTutorialStep:e.PropTypes.string,isCommentsServerView:e.PropTypes.bool},getInitialState:function(){return{shouldPopupsDropdown:!0,showBottomBar:!1,showNewCommentPill:!1,numFileLevelCommentsShown:0,uncollapsed:!1,commentListHeight:0}},getDefaultProps:function(){return{shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1}},componentWillUnmount:function(){return t(window).unbind("resize.bottom_bar")},componentDidMount:function(){return t(window).bind("resize.bottom_bar",this.checkScroll),this.checkScroll()},componentWillReceiveProps:function(t){var e,n;return e=this.props.activity,n=t.activity,e!==n&&!this.isScrolledToBottom()&&null!=e&&null!=n&&o.some(n.comment_activities.slice(e.comment_activities.length),function(e){return e.comment.commenter.id!==t.user.id})?this.setState({showNewCommentPill:!0}):void 0},componentWillUpdate:function(t){return this.shouldScrollToBottom=this.isScrolledToBottom()},componentDidUpdate:function(t,e){var n,o;if(this._isActivityFetchDone())return null==t.activity&&(null!=(n=this.props.activity)&&null!=(o=n.comment_activities)?o.length:void 0)>0&&this.animateScrollToBottom(K),this.shouldScrollToBottom&&this.scrollToBottom(),this.checkScroll(),this.updateListHeight()},onNewCommentPillClick:function(){return this.animateScrollToBottom(j),this.setState({showNewCommentPill:!1})},onAddReply:function(t,e){return w.addReply({targetActivityKey:e.activity_key,body:{text:t}})},onAddFileComment:function(t){return w.addFileComment({text:t})},onAddSticker:function(t){return w.addFileComment({stickerId:t})},isScrolledToBottom:function(){var e;if(!A.IS_COMBINED_COMMENTS_ENABLED)return e=t(n.findDOMNode(this.refs.commentList)),e[0].scrollHeight-e.scrollTop()-4<=e.outerHeight()},onCommentListClick:function(){D.emit("collapse-all-conversations")},onCommentExpanded:function(t,e){return this.scrollCommentIntoView(t,e),w.setExpandedComment(!0)},onScroll:function(){return this.checkScroll()},checkScroll:function(){var t;if(!A.IS_COMBINED_COMMENTS_ENABLED)return t=this.isScrolledToBottom(),this.setState({showBottomBar:!t,showNewCommentPill:!t&&this.state.showNewCommentPill})},updateListHeight:function(){var e;return null!=this.refs.commentList&&(e=t(n.findDOMNode(this.refs.commentList)).outerHeight(),this.state.commentListHeight!==e)?this.setState({commentListHeight:e}):void 0},turnOnFeedback:function(){return w.setCommentsEnabled({enabled:!0})},_isActivityFetchDone:function(){return null!=this.props.activity},forceBlur:function(){return t(document.activeElement).blur()},animateScrollToBottom:function(e){var o;return null==e&&(e=600),A.IS_COMBINED_COMMENTS_ENABLED?void 0:(o=n.findDOMNode(this.refs.commentList),t(o).animate({scrollTop:o.scrollHeight},{duration:e}))},scrollToBottom:function(){var t;if(!A.IS_COMBINED_COMMENTS_ENABLED)return t=n.findDOMNode(this.refs.commentList),t.scrollTop=t.scrollHeight},scrollCommentIntoView:function(e,o){var i,s;return i=n.findDOMNode(this.refs.commentList),s=e+o-i.offsetTop-t(i).outerHeight(),s>t(i).scrollTop()?t(i).animate({scrollTop:s},{duration:300}):void 0},animateScrollIntoView:function(e){var o,i,s,r,a;return s=e.node,r=null!=(a=e.padTop)?a:0,o=t(n.findDOMNode(this.refs.commentList)),i=t(s),o.animate({scrollTop:o.scrollTop()+i.offset().top-o.offset().top-r},{duration:500})},positionDropdownCallback:function(){var e,o,i,s;if(!A.IS_COMBINED_COMMENTS_ENABLED)return s=t(n.findDOMNode(this.refs.commentList)).outerHeight(),o=0,null!=this.refs.commentListHeader&&(o=t(n.findDOMNode(this.refs.commentListHeader)).outerHeight()),i=t(n.findDOMNode(this.refs.commentInputCard)).outerHeight(),e=s+o+i,this.setState({shouldPopupsDropdown:Boolean(e/2>s)})},renderLoadingSpinner:function(){var t;return X.div({className:"comments-loading"},t=e.createElement(l,{style:l.LoadingIndicatorStyle.BLUE_SPINNER}),null!=this.props.initialCommentsCount&&this.props.initialCommentsCount>0?X.div({className:"comments-loading__count",ref:"commentsLoadingCount"},Z("Loading %(count)s comment","Loading %(count)s comments",this.props.initialCommentsCount).format({count:this.props.initialCommentsCount})):void 0)},renderBlankState:function(){return this.props.showTutorial?this.renderTutorialBlankState():this.renderDefaultBlankState()},renderDefaultBlankState:function(){return X.div({className:"blank-state u-pad-horizontal-m u-pad-bottom-m"},X.div({className:"blank-state-illustration"},F({width:108,height:72,src:J("/static/images/commenting/comments_null_state-vflRF2RXk.png"),srcHiRes:J("/static/images/commenting/comments_null_state@2x-vflUmaRRX.png")})),X.div({className:"blank-state-text u-pad-vertical-xs"},Q($("Post a comment to start a discussion. <blue>@Mention</blue> someone to notify them."),{blue:X.span({className:"blue"})})))},renderTutorialBlankState:function(){return X.div({ref:"tutorialBlankSlate",className:"blank-state u-pad-horizontal-m u-pad-bottom-m"},X.div({className:"blank-state-illustration"},F({width:140,height:105,src:J("/static/images/commenting/onboarding_step2-vflQHsmaO.png"),srcHiRes:J("/static/images/commenting/onboarding_step2@2x-vflEm4vmD.png")})),X.div({className:"blank-state-text blank-state-large-text blank-state-light-text u-pad-vertical-xs"},$("Comment on specific areas")),X.div({className:"blank-state-text blank-state-medium-text blank-state-light-text u-pad-vertical-xs"},$("See something that needs work? Leave a comment on the file.")),X.div({},x({className:"blank-state__button",importance:"primary",onClick:this.onTutorialBlankSlateClick},$("Show me how"))))},onTutorialBlankSlateClick:function(){w.setCurrentTutorialStep(G)},renderDisabledCommentState:function(){return X.div({className:"blank-state"},X.div({className:"blank-state-icon"},z({group:"web",name:"s_comments_locked"})),X.div({className:"blank-state-text"},$("Comments are off for this file.")),X.div({className:"blank-state-button"},x({importance:"secondary",disabled:!this.props.activity.can_edit_feedback,onMouseUp:this.turnOnFeedback},$("Enable comments"))))},renderCommentCard:function(t,n){var i,s;return i={activity:this.props.activity,onCancelComment:this.forceBlur,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,isOffline:this.props.isOffline},null!=t?e.createElement(L,{key:"threaded_"+t.activity_key,shouldInitiallyShowNotifyHint:!1,initialUsersToNotify:t.users_to_notify,commentProps:o.extend(i,this.getConversationSpecificProps(t,n))}):u.isCommentingEnabled()?e.createElement(H,{ref:"commentInputCard",shouldInitiallyShowNotifyHint:!A.COMMENTS_COLLAPSE_INPUT,initialUsersToNotify:null!=(s=this.props.activity)?s.users_to_notify:void 0,commentProps:o.extend(i,this.getInputSpecificProps())}):null},getInputSpecificProps:function(){return{shouldPopupsDropdown:this.state.shouldPopupsDropdown,showNewComment:this.state.showNewCommentPill,commentMetadataAllowed:A.ALLOW_STICKERS,shouldEnableStickers:A.ALLOW_STICKERS,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldAlwaysInEditMode:!1,shouldDisplayRegionCreationButton:this.props.shouldDisplayRegionCreationButton,isRegionCreationEnabled:this.props.isRegionCreationEnabled,isCommentsServerView:this.props.isCommentsServerView,enableNoNotifyHint:!0,onAddComment:this.onAddFileComment,onAddSticker:this.onAddSticker,positionDropdownCallback:this.positionDropdownCallback,onShowNewComment:this.onNewCommentPillClick}},getConversationSpecificProps:function(t,e){return{commentActivity:t,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,annotationNumber:e,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldAutoLinkify:this.props.shouldAutoLinkify,isCommentsServerView:this.props.isCommentsServerView,onAddComment:this.onAddReply,onCommentExpanded:this.onCommentExpanded,scrollIntoView:this.animateScrollIntoView}},renderCommentGroup:function(t,e){return X.div({className:"comment-list__group"},X.div({className:"time"},t),e)},renderAnnotationGroup:function(t,e){return X.div({className:"comment-list__group"},t?X.div({className:"time"},"Page "+t):void 0,e)},renderCommentList:function(t){return this._isActivityFetchDone()?this._isActivityFetchDone()&&this.props.activity.feedback_off?this.renderDisabledCommentState():t.length>0?t:this._isActivityFetchDone()?this.renderBlankState():void 0:this.props.showLoadingSpinner?this.renderLoadingSpinner():this.renderBlankState()},renderCommentListOptions:function(t){var e,n;return n=this._isActivityFetchDone()&&this.props.activity.feedback_off,e=this._isActivityFetchDone()&&this.props.activity.can_edit_feedback,M({num_resolved:t,show_resolved:this.props.showResolvedComments,is_subscribed:this.props.isUserSubscribed,shouldShowHideButton:this.props.shouldShowHideButton,shouldShowDisableButton:!n&&e,feedback_off:n,activity_context:this.props.context,activity:this.props.activity,user:this.props.user,isOffline:this.props.isOffline})},renderTutorial:function(){return O({currentTutorialStep:this.props.currentTutorialStep})},hasComments:function(){return null!=this.props.initialCommentsCount&&this.props.initialCommentsCount>0||this._isActivityFetchDone()&&this.props.activity.comment_activities.length>0},_collapseComments:function(t,e,n,i){var s,r,a,l,c,u,d;for(l=o.findLastIndex(e,function(t){return t.shouldHighlightAsUnread()}),c=n,a=n*E,r=i*E,s=B+U+r,a+=s;c>V&&a>this.state.commentListHeight&&c-1>l;)c--,a=c*E,a+=s;return n>c&&(u=t.length-c,t=t.slice(0,c),d=X.a({className:"comments-collapse-toggle",onClick:function(t){return function(){return t.setState({uncollapsed:!0})}}(this)},$("Show %(count)s more").format({count:u})),t.push(d)),t},render:function(){var t,e,n,o,s,r,a,l,c,u,p,h,m,_,f,v,y,g,b,C,w,S,E,N,I,x,P,M,R,O,D,L,U,B,F;if(h=[],a=[],M=0,P=0,x=0,this._isActivityFetchDone()){for(e=T.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!0,includeDocLevel:!1,includeResolved:!0}),r={},g=b=0,S=e.length;S>b;g=++b)n=e[g],t=n.activity_key,r[t]=g+1;if(y=T.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!A.IS_COMBINED_COMMENTS_ENABLED,includeDocLevel:!0,includeResolved:this.props.showResolvedComments,sortBy:A.IS_COMBINED_COMMENTS_ENABLED?T.sortByReplyTime:void 0}),M=T.getNumResolved(this.props.activity.comment_activities),P=y.length,A.IS_COMBINED_COMMENTS_ENABLED)for(h=y.map(this.renderCommentCard),v=T.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!0,includeDocLevel:!1,includeResolved:this.props.showResolvedComments,sortBy:T.sortByTime}),x=v.length,!this.state.uncollapsed&&P>0&&x>0&&(h=this._collapseComments(h,y,P,x)),U=T.groupAnnotationActivitiesByPage(v),R=U[0],o=U[1],w=0,N=R.length;N>w;w++)D=R[w],m=o[D].map(function(t){return function(e){return t.renderCommentCard(e,r[e.activity_key])}}(this)),a.push(this.renderAnnotationGroup(D,m));else for(L=T.groupCommentActivitiesByTime(y),O=L[0],l=L[1],C=0,E=O.length;E>C;C++)B=O[C],m=l[B].map(function(t){return function(e){return t.renderCommentCard(e,r[e.activity_key])}}(this)),h.push(this.renderCommentGroup(B,m))}return p=i({"comment-list":!0,scrolled:this.state.showBottomBar}),_=i({"comments-holder":!0,"comments-activity-loaded":this._isActivityFetchDone(),"comments-holder-responsive":"ON"===d.getGandalfRule("comments_responsive_width")}),A.IS_COMBINED_COMMENTS_ENABLED?(c=this.renderCommentCard(),I=[],P>0&&(f=X.div({className:"file-level-comments-list"},h),I.push(f)),P>0&&x>0&&I.push(X.hr({className:"c-rule u-mar-vertical-xs",style:{width:"100%"}})),x>0&&(s=X.div({className:"annotation-comments-list"},a),I.push(s)),u=[c,this.renderCommentList(I)]):u=this.renderCommentList(h),F=i({"comment-tutorial":!0,"comment-tutorial--is-dev":A.ARE_DEV_TOOLS_SHOWN}),X.div({className:_,ref:"commentsHolder"},this.props.isCommentsServerView||!q.is_commenting_integrated()?k({ref:"commentListHeader",activity:this.props.activity,user:this.props.user,commentListOptions:this.renderCommentListOptions(M)}):void 0,X.div({className:p,ref:"commentList",onScroll:this.onScroll,onClick:this.onCommentListClick},u),A.IS_COMBINED_COMMENTS_ENABLED?void 0:X.div({className:"legacy-file-comment-input",ref:"commentInputCard"},this.renderCommentCard()),this.props.showTutorial&&(this.hasComments()||this.props.currentTutorialStep!==Y)?X.div({className:F},this.renderTutorial()):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_tutorial",["external/react","external/classnames","modules/core/i18n","modules/clean/comments/constants","modules/clean/comments/action_creators","modules/clean/comments/store","modules/clean/comments/flux","modules/clean/comments/components/ui_constants","modules/clean/comments/logging","modules/clean/react/button","modules/clean/react/sprite","modules/clean/react_format","modules/clean/react/image","modules/clean/static_urls","modules/clean/css"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m){var _,f,v,y,g,b,C,w,T,S,A,E,N,I,x,P,k,M;return I=n._,y=o.FileActivityLogEventType,v=o.FileActivityLogClientOriginType,T=a.TUTORIAL_INITIATOR,E=a.TUTORIAL_REPLY,N=a.TUTORIAL_REPLY_SUCCESS,S=a.TUTORIAL_MENTION,A=a.TUTORIAL_MENTION_SUCCESS,C=a.TUTORIAL_CREATE_ANNOTATION,w=a.TUTORIAL_CREATE_ANNOTATION_SUCCESS,k=d.reactFormat,M=h.static_url,P=t.DOM,x=t.createElement,_=t.createFactory(c.button),b=t.createFactory(u),g=t.createFactory(p),f=t.createClass({displayName:"CommentTutorial",propTypes:{currentTutorialStep:t.PropTypes.string},getDefaultProps:function(){return{currentTutorialStep:T}},componentDidMount:function(){return m.require_css("/static/css/sprites/emoji_sprites-vflYtQIlq.css")},_logTutorial:function(t){return l.logEvent(t,v.COMMENTS_TUTORIAL)},_onShowMeHow:function(){return i.setCurrentTutorialStep(C)},_onClose:function(){return this._logTutorial(y.TUTORIAL_CLOSE),i.markCommentsTutorialAsDone(),i.setShowTutorial(!1)},_onDone:function(){return this._logTutorial(y.TUTORIAL_DONE),i.setShowTutorial(!1)},_onNext:function(){var t;return this._logTutorial(y.TUTORIAL_NEXT),this.props.currentTutorialStep===S?i.setShowTutorial(!1):(t=function(){switch(this.props.currentTutorialStep){case C:return E;case w:return E;case E:return S;case N:return S}}.call(this),i.setCurrentTutorialStep(t))},_renderCurrentStep:function(){switch(this.props.currentTutorialStep){case C:return this._logTutorial(y.TUTORIAL_CREATE_ANNOTATION),this._renderCreateAnnotationStep();case w:return this._logTutorial(y.TUTORIAL_CREATE_ANNOTATION_SUCCESS),this._renderCreateAnnotationSuccessStep();case E:return this._logTutorial(y.TUTORIAL_REPLY),this._renderReplyStep();case N:return this._logTutorial(y.TUTORIAL_REPLY_SUCCESS),this._renderReplySuccessStep();case S:return this._logTutorial(y.TUTORIAL_MENTION),i.markCommentsTutorialAsDone(),this._renderMentionStep();case A:return this._logTutorial(y.TUTORIAL_MENTION_SUCCESS),this._renderMentionSuccessStep();default:return this._renderInitiatorStep()}},_renderInitiatorStep:function(){return P.div({className:"comment-tutorial__step"},P.div({className:"comment-tutorial__text"},P.p({className:"comment-tutorial__text comment-tutorial__text--bold"},I("Comment on specific areas")),P.p({},I("See something that needs work? Leave a comment on the file."))),_({className:"comment-tutorial__button",importance:"secondary",onClick:this._onShowMeHow},I("Show me how")))},_renderCreateAnnotationStep:function(){return P.div({className:"comment-tutorial__step"},P.div({className:"comment-tutorial__text"},k(I("First, click the comment <CommentSprite/> button up above, then click anywhere on the file."),{CommentSprite:x(u,{group:"web",name:"ic_comment_area_dark",className:"comment-tutorial__sprite"})})),g({width:250,height:150,src:M("/static/images/commenting/onboarding_animation_step1-vflStlhr4.gif"),srcHiRes:M("/static/images/commenting/onboarding_animation_step1@2x-vfls5nQtW.gif")}))},_renderCreateAnnotationSuccessStep:function(){return P.div({className:"comment-tutorial__step"},this._renderSuccessIcon(),P.div({className:"comment-tutorial__text"},P.p({className:"comment-tutorial__text comment-tutorial__text--bold"},I("Sweet!")),P.p({},I("Comments are an easy way to leave notes for others."))))},_renderReplyStep:function(){return P.div({className:"comment-tutorial__step"},P.div({className:"comment-tutorial__text"},I("Click any comment to review or reply to it.")),g({width:250,height:150,src:M("/static/images/commenting/onboarding_animation_step2-vfl96uLLF.gif"),srcHiRes:M("/static/images/commenting/onboarding_animation_step2@2x-vfl8g0EZh.gif")}))},_renderReplySuccessStep:function(){return P.div({className:"comment-tutorial__step"},this._renderSuccessIcon(),P.div({className:"comment-tutorial__text"},P.p({className:"comment-tutorial__text comment-tutorial__text--bold"},I("Just like that!")),P.p({},k(I("You can even reply with emojis <Emoji/>"),{Emoji:x(u,{group:"emoji",name:"1F604",className:"comment-tutorial__sprite"})}))))},_renderMentionStep:function(){return P.div({className:"comment-tutorial__step"},P.div({className:"comment-tutorial__text"},I("To notify someone, create a comment and type “@” followed by their email address.")),g({width:250,height:150,src:M("/static/images/commenting/onboarding_animation_step3-vfl2mhKA1.gif"),srcHiRes:M("/static/images/commenting/onboarding_animation_step3@2x-vflJYSw1X.gif")}))},_renderMentionSuccessStep:function(){return P.div({className:"comment-tutorial__step"},this._renderSuccessIcon(),P.div({className:"comment-tutorial__text"},P.p({className:"comment-tutorial__text comment-tutorial__text--bold"},I("You’re a natural!")),P.p({},I("@mentions lets you notify others without having to send out a separate email."))))},_renderSuccessIcon:function(){return g({width:38,height:40,src:M("/static/images/commenting/tutorial_success-vflO6ncSG.png"),srcHiRes:M("/static/images/commenting/tutorial_success@2x-vflchqv1n.png")})},_getCurrentStepText:function(){switch(this.props.currentTutorialStep){case C:return I("Step 1/3");case w:return I("Step 1/3");case E:return I("Step 2/3");case N:return I("Step 2/3");case S:return I("Step 3/3");case A:return I("Step 3/3")}},_renderHeader:function(){return P.div({className:"comment-tutorial__toolbar clearfix"},P.div({className:"comment-tutorial__counter"},this._getCurrentStepText()),P.a({className:"comment-tutorial__close",onClick:this._onClose},b({alt:I("Close"),group:"web",name:"tutorial_close"})))},_renderFooter:function(){return null!=this.props.currentTutorialStep&&this.props.currentTutorialStep!==T?P.div({className:"comment-tutorial__footer clearfix"},this.props.currentTutorialStep===A?P.a({ref:"done",className:"comment-tutorial__done",onClick:this._onDone},I("Done")):P.a({ref:"next",className:"comment-tutorial__next",onClick:this._onNext},I("Next"))):void 0},render:function(){var t,n;return t={"comment-tutorial__steps":!0},t["comment-tutorial__steps-"+this.props.currentTutorialStep]=!0,n=t,P.div({className:"comment-tutorial__container"},this._renderHeader(),P.div({className:e(n),ref:this.props.currentTutorialStep},this._renderCurrentStep()),this._renderFooter())}})})}.call(this),function(){define("modules/clean/react/file_comments/conversation_or_input_card",["external/react","external/underscore","modules/clean/activity/activity_user","modules/clean/react/activity/comment_input","modules/clean/react/file_comments/comment_card","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/constants/comments_panel"],function(t,e,n,o,i,s,r){var a,l,c,u,d;return a=n.ActivityUser,d=function(t,n){var o,i,s,r;return i=e.indexBy(t,"id"),s=e.indexBy(n,"id"),r=e.extend({},i,s),o=e.values(r)},u={getInitialState:function(){return{mentionedUsers:[],shouldShowNotifyHint:this.props.shouldInitiallyShowNotifyHint}},getDefaultProps:function(){return{initialUsersToNotify:[]}},onMentionedUsersChanged:function(t){return this.setState({mentionedUsers:t})},getUsersToNotify:function(){return d(this.props.initialUsersToNotify,this.state.mentionedUsers)},clearMentionedUsers:function(){return this.isMounted()?this.setState({mentionedUsers:[]}):void 0},setShouldShowNotifyHint:function(t){return this.setState({shouldShowNotifyHint:t})}},l=t.createClass({displayName:"ConversationCard",mixins:[t.addons.PureRenderMixin,u],propTypes:{shouldInitiallyShowNotifyHint:t.PropTypes.bool,initialUsersToNotify:t.PropTypes.arrayOf(t.PropTypes.instanceOf(a)),commentProps:t.PropTypes.object},onAddComment:function(t,e){var n;return this.clearMentionedUsers(),"function"==typeof(n=this.props.commentProps).onAddComment?n.onAddComment(t,e):void 0},renderCommentThread:function(){return t.createElement(s,e.extend({},this.props.commentProps,{onMentionedUsersChanged:this.onMentionedUsersChanged,setShouldShowNotifyHint:this.setShouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),onAddComment:this.onAddComment}))},render:function(){return t.createElement(i,{shouldInitiallyShowNotifyHint:this.props.shouldInitiallyShowNotifyHint,user:this.props.commentProps.user,isOffline:this.props.commentProps.isOffline,shouldShowNotifyHint:this.state.shouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),shouldPopupsDropdown:!1},this.renderCommentThread())}}),c=t.createClass({displayName:"InputCard",mixins:[t.addons.PureRenderMixin,u],propTypes:{shouldInitiallyShowNotifyHint:t.PropTypes.bool,initialUsersToNotify:t.PropTypes.arrayOf(t.PropTypes.instanceOf(a)),commentProps:t.PropTypes.object},onAddComment:function(t){var e;return this.clearMentionedUsers(),"function"==typeof(e=this.props.commentProps).onAddComment?e.onAddComment(t):void 0},renderCommentInput:function(){return t.createElement(o,e.extend({},this.props.commentProps,{ref:"commentInput",onMentionedUsersChanged:this.onMentionedUsersChanged,setShouldShowNotifyHint:this.setShouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),onAddComment:this.onAddComment}))},render:function(){return t.createElement(i,{shouldInitiallyShowNotifyHint:this.props.shouldInitiallyShowNotifyHint,initialUsersToNotify:this.props.initialUsersToNotify,user:this.props.commentProps.user,isOffline:this.props.commentProps.isOffline,shouldShowNotifyHint:this.state.shouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),shouldPopupsDropdown:r.IS_COMBINED_COMMENTS_ENABLED},this.renderCommentInput())}}),{ConversationCard:l,InputCard:c}})}.call(this),function(){define("modules/clean/react/file_comments/file_comments_pane",["jquery","external/underscore","external/classnames","external/react","modules/constants/comments_panel","modules/core/i18n","modules/core/notify","modules/clean/analytics","modules/clean/file_activity/api","modules/clean/gandalf_util","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/react/file_comments/comment_list_ui","modules/clean/react/file_comments/onboarding","modules/clean/react/file_viewer/actions","modules/clean/comments/action_creators","modules/clean/comments/events","modules/clean/comments/utils","modules/clean/comments/store","modules/clean/file_activity/models/file_activity"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f,v,y,g){var b,C,w,T,S,A,E,N,I,x,P,k;return P=s._,T=a.ContactSearchLogger,I=u.SimpleModal,E=u.Modal,w=f.CommentsEvents,S=g.FileActivity,k=o.DOM,b=o.createFactory(p),x=o.createFactory(d),C=o.createFactory(h),N=1e3,A=o.createClass({displayName:"FileCommentsPane",mixins:[o.addons.PureRenderMixin],propTypes:{showButtonColor:o.PropTypes.string.isRequired,activity:o.PropTypes.instanceOf(S),context:o.PropTypes.number,contextData:o.PropTypes.string,showResolvedComments:o.PropTypes.bool,isPreviewReady:o.PropTypes.bool,showLoadingSpinner:o.PropTypes.bool,isCommentsHidden:o.PropTypes.bool,feedbackId:o.PropTypes.string.isRequired,userId:o.PropTypes.number,showDisabledCommentBar:o.PropTypes.bool,previewSelector:o.PropTypes.string,shouldInitiallyFocusInput:o.PropTypes.bool,canCollapse:o.PropTypes.bool,shouldAutoLinkify:o.PropTypes.bool,enableImport:o.PropTypes.bool,shouldUseSimpleModals:o.PropTypes.bool,shouldHidePhotoAvatars:o.PropTypes.bool,oref:o.PropTypes.string,shouldCheckOffline:o.PropTypes.bool,shouldShowOnboarding:o.PropTypes.bool,onOnboardingModalOpen:o.PropTypes.func,shouldAnnotationButtonUseThumbnailUrls:o.PropTypes.bool,initialCommentsCount:o.PropTypes.number,shouldTrackCollapsedState:o.PropTypes.bool,isUserSubscribed:o.PropTypes.bool,isRegionCreationEnabled:o.PropTypes.bool,showTutorial:o.PropTypes.bool,currentTutorialStep:o.PropTypes.string,isCommentsServerView:o.PropTypes.bool},getInitialState:function(){return{icon:"s_comments_locked",isOffline:!1,height:0}},getDefaultProps:function(){return{canCollapse:!0,shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,file:null,shouldCheckOffline:!1,shouldShowOnboarding:!1,shouldAnnotationButtonUseThumbnailUrls:i.ALLOW_ANNOTATION_THUMBNAILS}},componentWillMount:function(){return this.isAnnotationGhostEnabled=i.ALLOW_ANNOTATION_GHOST},componentDidMount:function(){return this._refreshWidth(),this.contactSearchLogger=new T,this.props.shouldCheckOffline?(this._checkAndSetIsOffline(),this.offlineInterval=setInterval(this._checkAndSetIsOffline,N)):void 0},maybeShowOnboardingModal:function(){var t;return this.props.shouldShowOnboarding?(t=C({onOpen:this.props.onOnboardingModalOpen}),E.showInstance(t)):void 0},fitToHeight:function(t){return this.state.height!==t?this.setState({height:t}):void 0},_isPreviewAndCommentsReady:function(){return this.state.enabled&&null!=this._getActivity()&&this.previewIsReady&&!this.state.isFetchingActivity},_fileHasReplies:function(){var t,e,n,o;if(null!=this._getActivity())for(o=this._getActivity().comment_activities,e=0,n=o.length;n>e;e++)if(t=o[e],t.comment_activities.length>0)return!0;return!1},_checkAndSetIsOffline:function(){return this.setState({isOffline:!navigator.onLine});
},_getActivity:function(){return this.props.activity},_showResolvedComments:function(){return this.props.showResolvedComments},showFeedbackModal:function(e){var n;return null!=e&&e.preventDefault(),n='<div class="text-input comment-feedback-input"> <div class="text-input-wrapper"> <textarea id="comments-feedback-input" placeholder="Let us know how we can improve commenting in Dropbox." ></textarea> </div> </div>',I.show({title_text:P("Help us improve comments"),body_html:n,cancel_text:P("Cancel"),confirm_text:P("Submit Feedback"),confirm_callback:function(e){return function(){var n,o,i;return n=t("#comments-feedback-input").val(),i=function(){return r.success(P("Thank you! Your feedback will help improve Dropbox."))},o=function(){return function(){return r.error(P("There was an error submitting your feedback."))}},l.submitProductFeedback({actorId:e.props.userId,feedbackText:n,context:e.props.context,contextData:e.props.contextData,oref:e.props.oref}).then(i,o)}}(this)})},getActivityUser:function(){return v.getActivityUser(this.props.userId)},setLockedIcon:function(){return this.setState({icon:"s_comments_locked"})},setUnlockedIcon:function(){return this.setState({icon:"s_comments_unlocked"})},show:function(){return _.showComments(),w.emit("show-comments-pane")},_refreshWidth:function(){return t(".video-js").length?t(".video-js").css("width","100%"):void 0},render:function(){var t,e,o,s,r,a,l;return o=!this.props.isCommentsHidden,t=n({"file-feedback":!0,"preview-ready":this.props.isPreviewReady,hidden:!this.state.enabled}),l=this.getActivityUser(),a=l.is_signed_in&&i.ALLOW_WEB_FEEDBACK,r=i.ALLOW_VIEW_ANNOTATE_MODES&&this.props.isPreviewReady,e=0!==this.state.height?{height:this.state.height}:{},o||!this.props.canCollapse?k.div({id:this.props.feedbackId,ref:"fileCommentsPane",className:t,tabIndex:"-1",style:e},k.div({className:"comments-and-feedback"},this.state.isOffline?k.div({className:"comments-offline-banner"},k.div({className:"comments-offline-banner-inner"},P("No Internet Connection"))):void 0,b({ref:"commentListUI",showLoadingSpinner:this.props.showLoadingSpinner,context:this.props.context,activity:this._getActivity(),user:l,contactSearchLogger:this.contactSearchLogger,initialCommentsCount:this.props.initialCommentsCount,isUserSubscribed:this.props.isUserSubscribed,shouldAutoLinkify:this.props.shouldAutoLinkify,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,showResolvedComments:this._showResolvedComments(),enableImport:this.props.enableImport,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isOffline:this.state.isOffline,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldShowHideButton:Boolean(this.props.canCollapse&&this.props.shouldTrackCollapsedState),shouldDisplayRegionCreationButton:r,isRegionCreationEnabled:this.props.isRegionCreationEnabled,showTutorial:this.props.showTutorial&&this.props.isPreviewReady,currentTutorialStep:this.props.currentTutorialStep,isCommentsServerView:this.props.isCommentsServerView}),a?k.div({className:"comments-feedback-link"},k.div({className:"comments-feedback-link-inner"},k.a({onMouseUp:this.showFeedbackModal},P("Help us improve comments")))):void 0)):this.props.shouldTrackCollapsedState||o?o?(null!=(s=this._getActivity())?s.can_edit_feedback:void 0)?k.div({id:this.props.feedbackId,className:"hidden-comments",style:e,onMouseOver:this.setUnlockedIcon,onMouseOut:this.setLockedIcon},k.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.turnOnComments},k.div({className:"show-button-sprite"},x({group:"web",name:this.state.icon,alt:P("Show comments")})))):k.div({id:this.props.feedbackId,className:"hidden"}):k.div({id:this.props.feedbackId,className:"hidden-comments",style:e},k.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.show},k.div({className:"show-button-sprite"},x({group:"web",name:"s_show_comments_grey",alt:P("Show comments")})))):k.div({id:this.props.feedbackId,className:"hidden"})}}),{FileCommentsPaneClass:A}})}.call(this),define("modules/clean/react/file_comments/live_sticker",["require","exports","external/react","external/react-dom","external/classnames","modules/clean/sticker_util","modules/clean/event_handler","modules/clean/comments/lib/animation"],function(t,e,n,o,i,s,r,a){"use strict";return n.createClass({displayName:"LiveSticker",mixins:[n.addons.PureRenderMixin,r.EventHandlerMixin],propTypes:{stickerId:n.PropTypes.number.isRequired,size:n.PropTypes.oneOf(["small","normal"]),skipInitial:n.PropTypes.bool},getInitialState:function(){return{previewReady:!1,staticReady:!1,spritesReady:!1,mouseOver:!1,initial:!1,intro:!1,loop:!1,outro:!1}},componentDidMount:function(){var t=o.findDOMNode(this.refs.sticker);this.events.on(t,a.ANIMATION_ITERATION_EVENT,this.onAnimationIteration,this),this.events.on(t,a.ANIMATION_END_EVENT,this.onAnimationEnd,this),this.events.on(t,"mouseenter touchstart",this.onMouseEnter,this),this.events.on(t,"mouseleave touchend",this.onMouseLeave,this)},onPreviewLoad:function(){this.setState({previewReady:!0,initial:!this.props.skipInitial&&this.state.spritesReady})},onStaticLoad:function(){this.setState({staticReady:!0})},onSpritesLoad:function(){this.setState({spritesReady:!0,initial:!this.props.skipInitial&&this.state.previewReady})},onAnimationIteration:function(){this.setState({initial:this.state.initial&&!this.state.mouseOver,intro:this.state.loop&&!this.state.mouseOver,loop:this.state.mouseOver,outro:!1})},onAnimationEnd:function(){this.setState({initial:!1,intro:this.state.outro&&!this.state.mouseOver,loop:this.state.mouseOver,outro:!1})},onMouseEnter:function(){this.state.mouseOver||this.setState({mouseOver:!0,outro:!(this.state.loop||this.state.intro||this.state.initial)})},onMouseLeave:function(){this.state.mouseOver&&this.setState({mouseOver:!1})},render:function(){var t=this.props,e=t.stickerId,o=t.size,r=this.state,a=r.previewReady,l=r.spritesReady,c=r.initial,u=r.intro,d=r.loop,p=r.outro,h="live-sticker-"+e,m=null,_=i((f={"live-sticker":!0,"live-sticker-ready":a&&l,"live-sticker-initial":c,"live-sticker-intro":u,"live-sticker-loop":d,"live-sticker-outro":p,"live-sticker-size-small":"small"===o},f["live-sticker-"+e]=!0,f));return a&&l||(m=n.createElement("img",{className:"live-sticker-preview",onLoad:this.onPreviewLoad,src:s.getStickerImageUrl(e,"preview"),alt:h})),n.createElement("span",{ref:"sticker",className:_,"data-sticker-id":e},n.createElement("img",{className:"live-sticker-sprites",onLoad:this.onSpritesLoad,src:s.getStickerImageUrl(e,"sprites"),alt:""}),n.createElement("span",{className:"live-sticker-sprites-overlay"}),n.createElement("img",{className:"live-sticker-static",onLoad:this.onStaticLoad,src:s.getStickerImageUrl(e,"png"),srcSet:s.getStickerImageUrl(e,"png@2x")+" 2x",alt:h}),m);var f}})}),function(){define("modules/clean/react/file_comments/stickers",["jquery","external/react","external/react-dom","external/classnames","external/underscore","modules/clean/react/file_comments/live_sticker","modules/clean/sticker_util"],function(t,e,n,o,i,s,r){var a,l,c,u,d;return d=e.DOM,a=e.createClass({displayName:"StickerOption",mixins:[e.addons.PureRenderMixin],propTypes:{value:e.PropTypes.shape({id:e.PropTypes.number.isRequired,live_sticker:e.PropTypes.bool}).isRequired,onClick:e.PropTypes.func},onClick:function(t){var e;return t.preventDefault(),"function"==typeof(e=this.props).onClick?e.onClick(this.props.value.id):void 0},render:function(){var t,n,o;return o=this.props.value,t=o.id,n=o.live_sticker,d.a({onClick:this.onClick,"data-sticker-id":t},n?e.createElement(s,{size:"small",skipInitial:!0,stickerId:t}):d.img({src:r.getStickerImageUrl(t)}))}}),l=e.createFactory(e.createClass({displayName:"StickerSet",mixins:[e.addons.PureRenderMixin],propTypes:{onStickerClick:e.PropTypes.func,isSelected:e.PropTypes.bool,data:e.PropTypes.object},render:function(){var t;return t=o({"sticker-set":!0,"is-selected":this.props.isSelected}),d.div({className:t},this.props.data.stickers.map(function(t){return function(n){return e.createElement(a,{value:n,onClick:t.props.onStickerClick})}}(this)))}})),c=e.createFactory(e.createClass({displayName:"StickerTab",mixins:[e.addons.PureRenderMixin],propTypes:{data:e.PropTypes.object,onChangeSelection:e.PropTypes.func,isSelected:e.PropTypes.bool},_onStickerTabClick:function(t){return t.preventDefault(),this.props.onChangeSelection(this.props.data.id)},render:function(){var t;return t=o({"sticker-nav-item":!0,"is-selected":this.props.isSelected}),d.a({className:t,onClick:this._onStickerTabClick},d.img({src:r.getStickerSetImageUrl(this.props.data.id)}))}})),u=e.createClass({displayName:"Stickers",mixins:[e.addons.PureRenderMixin],SCROLL_DISTANCE:200,propTypes:{onStickerSelected:e.PropTypes.func,isPopupAbove:e.PropTypes.bool},getInitialState:function(){var t;return t=r.getStickers(),{stickerSets:t,selected:t[0].id,scrollOffset:0}},_onChangeSelection:function(t){return this.setState({selected:t})},_onStickerSelected:function(t){return this.props.onStickerSelected(t)},_getMaxScroll:function(){var e,o,i,s,r,a;for(a=0,r=n.findDOMNode(this).getElementsByClassName("sticker-nav-item"),i=0,s=r.length;s>i;i++)e=r[i],a+=t(e).outerWidth(!0);return o=60,n.findDOMNode(this.refs.tabs).offsetWidth-a-o},_onLeftArrowPress:function(t){return t.preventDefault(),this.setState({scrollOffset:Math.min(0,this.state.scrollOffset+this.SCROLL_DISTANCE)})},_onRightArrowPress:function(t){return t.preventDefault(),this.setState({scrollOffset:Math.max(this._getMaxScroll(),this.state.scrollOffset-this.SCROLL_DISTANCE)})},_renderTabs:function(t){var e;return e=o({"sticker-nav":!0,"show-left":this.state.scrollOffset<0,"show-right":!this.isMounted()||this.state.scrollOffset!==this._getMaxScroll(),"on-top":this.props.isPopupAbove,"on-bottom":!this.props.isPopupAbove}),d.div({className:e,ref:"tabs"},d.a({href:"#left",onClick:this._onLeftArrowPress,className:"arrow left"}),d.div({className:"sticker-nav-inner",ref:"tabScroller",style:{marginLeft:this.state.scrollOffset}},t),d.a({href:"#right",onClick:this._onRightArrowPress,className:"arrow right"}))},render:function(){var t,e,n,o,i,s;for(s=[],i=[],o=r.getStickers(),t=0,n=o.length;n>t;t++)e=o[t],s.push(new c({data:e,isSelected:e.id===this.state.selected,onChangeSelection:this._onChangeSelection})),i.push(new l({data:e,count:e.stickers.length,isSelected:e.id===this.state.selected,onStickerClick:this._onStickerSelected}));return d.div({className:"sticker-container",refs:"stickerContainer"},d.div({className:"sticker-menu"},this.props.isPopupAbove?this._renderTabs(s):void 0,d.div({className:"sticker-sets-scrollable"},i),this.props.isPopupAbove?void 0:this._renderTabs(s)))}}),{Stickers:u}})}.call(this),function(){define("modules/clean/react/file_comments/switch_revision_ui",["external/react","modules/clean/datetime","modules/core/i18n"],function(t,e,n){var o,i;return o=n._,i=t.DOM,t.createClass({displayName:"SwitchRevisionUI",mixins:[t.addons.PureRenderMixin],propTypes:{revision:t.PropTypes.object.isRequired,onSwitchToLatestRevision:t.PropTypes.func.isRequired},render:function(){var t,n,s,r;return n=this.props,s=n.revision,t=n.onSwitchToLatestRevision,r=new Date(1e3*s.when),i.div({className:"switch-revision-ui"},i.div({className:"switch-revision-bar"},i.div({className:"switch-revision-bar__title"},i.span({},"Viewing old revision"),isNaN(r)?void 0:i.span({className:"switch-revision-bar__title__date"},""+e.ago(r))),i.div({className:"switch-revision-bar__actions"},i.a({className:"button-elm button-tertiary",onClick:t},o("Switch back to latest revision")))))}})})}.call(this),function(){define("modules/clean/react/file_comments/threaded_comment_activity_ui",["jquery","external/classnames","external/react","external/react-dom","external/underscore","modules/core/i18n","modules/clean/components/loading_indicator","modules/clean/datetime","modules/clean/event_handler","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/react/sprite","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/comments/action_creators","modules/clean/comments/events","modules/clean/comments/lib/animation","modules/clean/comments/models/comment_activity","modules/clean/file_activity/models/file_activity","modules/constants/comments_panel"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f,v,y,g){var b,C,w,T,S,A,E,N,I,x,P;return P=s.ungettext,A=l.EventHandlerMixin,S=_.CommentsEventsMixin,b=f.ANIMATION_END_EVENT,C=v.CommentActivity,E=y.FileActivity,x=n.DOM,w=n.createFactory(p),T=n.createFactory(h),N=47,I=n.createClass({displayName:"ThreadedCommentActivityUI",mixins:[n.addons.PureRenderMixin,A,S],propTypes:{context:n.PropTypes.number,commentActivity:n.PropTypes.instanceOf(C).isRequired,user:n.PropTypes.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:n.PropTypes.bool,shouldAutoLinkify:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,activity:n.PropTypes.instanceOf(E).isRequired,replyText:n.PropTypes.string,showResolvedComments:n.PropTypes.bool,contactSearchLogger:n.PropTypes.object,onReplyInputFocus:n.PropTypes.func,onReplyInputBlur:n.PropTypes.func,enableImport:n.PropTypes.bool,showNewComment:n.PropTypes.bool,checkScroll:n.PropTypes.func,onShowNewComment:n.PropTypes.func,onCommentExpanded:n.PropTypes.func,onCancelComment:n.PropTypes.func,annotationNumber:n.PropTypes.number,isInAnnotationBubble:n.PropTypes.bool,scrollIntoView:n.PropTypes.func,setShouldShowNotifyHint:n.PropTypes.func,onMentionedUsersChanged:n.PropTypes.func,onAddComment:n.PropTypes.func,onInputChange:n.PropTypes.func,isCommentsServerView:n.PropTypes.bool},getInitialState:function(){return{isExpanded:!1,highlighting:!1}},getDefaultProps:function(){return{shouldAnnotationButtonUseThumbnailUrls:!1}},componentDidMount:function(){return this.props.isInAnnotationBubble?void 0:(this.events.on(o.findDOMNode(this),b,this.onAnimationEnd,this),this.onCommentsEvent("reveal-comment-in-pane",this.onRevealComment),this.onCommentsEvent("collapse-all-conversations",this.onCollapseConversation))},componentDidUpdate:function(t,e){var n,i,s;return this.state.isExpanded&&!e.isExpanded&&null!=this.props.onCommentExpanded&&(s=o.findDOMNode(this).offsetTop,i=o.findDOMNode(this).clientHeight+N,this.props.onCommentExpanded(s,i)),this.state.isExpanded!==e.isExpanded&&"function"==typeof(n=this.props).setShouldShowNotifyHint?n.setShouldShowNotifyHint(this.state.isExpanded):void 0},onRevealComment:function(t){var e,n,o;return e=t.activityKey,o=t.expandConversation,n=this.props.commentActivity,n.activity_key===e?this.revealConversation(o):i.findWhere(n.comment_activities,{activity_key:e})?this.revealReply(e,o):void 0},revealConversation:function(t){var e,n;return n={highlighting:!0},t&&(n.isExpanded=!0),this.setState(n),"function"==typeof(e=this.props).scrollIntoView?e.scrollIntoView({node:o.findDOMNode(this),padTop:10}):void 0},revealReply:function(t,e){return this.setState({isExpanded:!0},function(e){return function(){var n;if(e.isMounted())return n=e.refs["child-"+t],null!=n?n.reveal():void 0}}(this))},onAnimationEnd:function(){return this.setState({highlighting:!1})},onCollapseConversation:function(){return this.setState({isExpanded:!1})},onAddComment:function(t){var e;return"function"==typeof(e=this.props).onAddComment?e.onAddComment(t,this.props.commentActivity):void 0},onAddSticker:function(t){return m.addReply({targetActivityKey:this.props.commentActivity.activity_key,body:{stickerId:t}})},resizeCallback:function(t){var e,n;return null==t&&(t=!1),this.forceUpdate(),t&&null!=this.props.onCommentExpanded?(n=o.findDOMNode(this).offsetTop,e=o.findDOMNode(this).clientHeight+N,this.props.onCommentExpanded(n,e)):void 0},onClick:function(t){if(t.preventDefault(),t.stopPropagation(),this.state.isExpanded){if(this._shouldClickCollapseThread(t))return this.setState({isExpanded:!1})}else if(this._shouldClickExpandThread(t))return this.setState({isExpanded:!0}),m.markConversationSeen(this.props.commentActivity.activity_key)},_shouldClickExpandThread:function(e){var n;return n=t(e.target),0===n.parents(".threaded-comment-header").length},_shouldClickCollapseThread:function(e){var n;return n=t(e.target),0!==n.closest(".threaded-comment-header").length&&0===n.closest(".annotation-thumbnail-page").length&&0===n.closest(".annotation-thumbnail-label-text").length},hasReplies:function(){return this.repliesCount()>0},repliesCount:function(){return this.props.commentActivity.comment_activities.length},renderCommentActivityUI:function(t,e,n,o){return null==n&&(n=!1),null==o&&(o=!1),w({key:"comment_"+e.activity_key,ref:"child-"+e.activity_key,parentActivity:t,fileActivity:this.props.activity,comment_activity:e,user:this.props.user,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,annotationNumber:this.props.annotationNumber,shouldShowReplyButton:o,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldAutoLinkify:this.props.shouldAutoLinkify,isReply:n,isExpanded:this.state.isExpanded,truncateLength:100,isInAnnotationBubble:this.props.isInAnnotationBubble,scrollIntoView:this.props.scrollIntoView})},render:function(){var t,n,o,i,s,r,a;if(n=[],this.hasReplies())for(a=this.props.commentActivity.comment_activities,i=o=0,r=a.length;r>o;i=++o)t=a[i],t.comment.resolved&&!this.props.showResolvedComments||(s=i===this.repliesCount()-1,n.push(this.renderCommentActivityUI(this.props.commentActivity,t,!0,s)));return x.div({className:e({"threaded-comment-list":!0,"threaded-comment-list--unread":this.props.commentActivity.shouldHighlightAsUnread(),"threaded-comment-list--highlighting":this.state.highlighting}),"data-comment-activity-key":this.props.commentActivity.activity_key,onClick:this.onClick,onMouseLeave:this._onMouseLeave},x.div({},this.renderCommentActivityUI(this.props.activity,this.props.commentActivity,!1,!(this.hasReplies()||this.props.commentActivity.is_pending))),this.hasReplies()?x.div({},this.repliesCount()>1&&!this.state.isExpanded?x.div({},x.a({className:"replies-count-button"},P("%(num)s more reply","%(num)s more replies",this.repliesCount()-1).format({num:this.repliesCount()-1})),x.div({},n[n.length-1])):n):void 0,this.state.isExpanded&&!this.props.commentActivity.is_pending?T({ref:"commentInput",activity:this.props.activity,user:this.props.user,usersToNotify:this.props.commentActivity.users_to_notify,onAddComment:this.onAddComment,onCancelComment:this.props.onCancelComment,contactSearchLogger:this.props.contactSearchLogger,onAddSticker:this.onAddSticker,resizeCallback:this.resizeCallback,popupsShouldDropdown:this.state.popupsShouldDropdown,onFocus:this.props.onReplyInputFocus,onBlur:this.props.onReplyInputBlur,onShowNewComment:this.props.onShowNewComment,showNewComment:this.props.showNewComment,onChange:this.props.onInputChange,initialText:this.props.replyText,commentMetadataAllowed:g.ALLOW_STICKERS,shouldEnableStickers:g.ALLOW_STICKERS,shouldInitiallyFocusInput:!0,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isReplyInput:!0,shouldShowAvatar:!0,shouldAlwaysInEditMode:!0,onMentionedUsersChanged:this.props.onMentionedUsersChanged,isCommentsServerView:this.props.isCommentsServerView}):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/threaded_comment_header",["external/classnames","external/react","external/underscore","jquery","modules/clean/datetime","modules/clean/annotations/annotation","modules/clean/react/activity/resolve_button","modules/clean/react/activity/annotation_button","modules/constants/comments_panel","modules/core/i18n"],function(t,e,n,o,i,s,r,a,l,c){var u,d,p,h,m,_,f,v,y;return u=s.Annotation,m=s.AnnotationTypes,d=s.AnnotationSubtypes,h=a.AnnotationThumbnailClass,v=c._,_=e.createFactory(r),p=e.createFactory(h),y=e.DOM,f=e.createClass({displayName:"ThreadedCommentHeader",mixins:[e.addons.PureRenderMixin],propTypes:{annotation:e.PropTypes.object,revision:e.PropTypes.object,isOldRevision:e.PropTypes.bool,onClick:e.PropTypes.func,isHeader:e.PropTypes.bool,onUpdateResolve:e.PropTypes.func,isOffline:e.PropTypes.bool,shouldShowResolveButton:e.PropTypes.bool,resolved:e.PropTypes.bool,annotationNumber:e.PropTypes.number,shouldAnnotationButtonUseThumbnailUrls:e.PropTypes.bool,showAnnotationThumbnail:e.PropTypes.bool},_getPrimaryText:function(t){return v(this.props.shouldAnnotationButtonUseThumbnailUrls?t.type===m.HIGHLIGHT?this.props.showAnnotationThumbnail?"Close text annotation":"View text annotation":this.props.showAnnotationThumbnail?"Close thumbnail":"View thumbnail":"View on file")},_renderAnnotationNumber:function(){var e;return e={"annotation-number":!0,"annotation-number--resolved":this.props.resolved,"annotation-number--old-revision":this.props.isOldRevision},y.div({className:t(e)},this.props.annotationNumber)},_renderAnnotationThumbnail:function(){return p({annotation:this.props.annotation,thumbnailUrl:this.props.annotation.thumbnail_url})},render:function(){var e;return e={"annotation-thumbnail-label":!0,"is-on-old-revision":this.props.isOldRevision},y.div({},y.div({className:"threaded-comment-header comment-annotation",onClick:this.props.onClick},y.div({className:"comment-annotation-button"},this._renderAnnotationNumber(),y.div({className:t(e)},y.a({className:"annotation-thumbnail-label-text"},this._getPrimaryText(this.props.annotation)),this.props.isOldRevision?y.div({className:"older-revision"},v("Older revision")):void 0),this.props.shouldShowResolveButton?_({resolved:this.props.resolved,onUpdateResolve:this.props.onUpdateResolve,isOffline:this.props.isOffline}):void 0)),this.props.showAnnotationThumbnail?this.props.annotation.type===m.HIGHLIGHT?y.div({className:"comment-annotation-highlight"},this.props.annotation.text_highlight.text):y.div({className:"comment-annotation-thumbnail"},this._renderAnnotationThumbnail()):void 0)}})})}.call(this),function(){define("modules/clean/sticker_util",["external/underscore","modules/constants/stickers"],function(t,e){var n;return new(n=function(){function n(){}return n.prototype.isLiveSticker=function(n){var o;return this.stickerById||(this.stickerById=t.indexBy(e.stickers,"id")),(null!=(o=this.stickerById[n])?o.live_sticker:void 0)===!0},n.prototype.getStickerImageUrl=function(t,n){return null==n&&(n="png"),e.sticker_img_url+"/"+t+"?type="+n},n.prototype.getStickerSetImageUrl=function(t){return e.sticker_set_img_url+"/"+t},n.prototype.getStickers=function(){var t,n,o,i,s,r,a,l,c,u,d;if(!this.stickers){for(this.stickers=e.sets,a=this.stickers,t=0,i=a.length;i>t;t++)u=a[t],u.stickers=[];for(l=e.stickers,n=0,s=l.length;s>n;n++)for(d=l[n],c=this.stickers,o=0,r=c.length;r>o;o++)if(u=c[o],d.set_id===u.id){u.stickers.push(d);break}}return this.stickers},n}())})}.call(this),function(){define("modules/clean/string",[],function(){var t,e,n;return e=function(t){return t.slice(0,1).toUpperCase().concat(t.slice(1).toLowerCase())},n=function(t,n){return null==n&&(n=" "),t.split(n).map(e).join(n)},t=function(t){return t=t.replace(/(\-\w)/g,function(t){return t[1].toUpperCase()}),t.slice(0,1).toUpperCase()+t.slice(1)},{toTitleCase:e,toWordTitleCase:n,lispToPascalCase:t}})}.call(this),function(){define("modules/clean/trash/trash_modal",["external/react","external/underscore","modules/core/browser","modules/core/notify","modules/core/i18n","modules/core/uri","modules/clean/components/loading_indicator","modules/clean/em_string","modules/clean/events/rollback","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/ajax"],function(t,e,n,o,i,s,r,a,l,c,u,d){var p,h,m,_,f,v,y,g,b,C;return y=i._,C=i.ungettext,m=c.SimpleModal,h=c.Modal,g=t.DOM,b=t.PropTypes,_=t.createClass({displayName:"SingleModalItem",propTypes:{icon:b.string.isRequired,name:b.string.isRequired,size:b.string.isRequired},render:function(){return g.div({className:"modal-item-row"},g.div({className:"modal-item-icon lfloat"},t.createElement(u,{group:"web",name:this.props.icon})),g.div({className:"modal-item-name lfloat"},this.props.name),g.div({className:"modal-item-size rfloat"},this.props.size))}}),f=t.createClass({displayName:"SingleModalView",propTypes:{icon:b.string.isRequired,text:b.string.isRequired,src_path:b.string.isRequired,size:b.string.isRequired,deletionString:b.string},getDefaultProps:function(){return{deletionString:""}},_formatIconSource:function(t){return"/static/images/icons128/%(icon)s.png".format({icon:t.slice(0,-8)})},render:function(){var t,e;return t=this._formatIconSource(this.props.icon),e=34,g.div({id:"modal-single-container"},g.div({},g.img({id:"modal-single-icon",src:t,alt:""}),g.div({id:"modal-single-name",ref:"single_name"},a.em_snippet(this.props.text,e)),g.div({id:"modal-single-path",ref:"single_path"},a.em_snippet(this.props.src_path,e,0)),g.div({id:"modal-single-size",ref:"single_size"},this.props.size),g.div({id:"modal-single-time",ref:"single_time"},this.props.deletionString)))}}),p=t.createClass({displayName:"GroupModalView",propTypes:{items:b.array.isRequired,src_path:b.string.isRequired,deletionString:b.string.isRequired},_tableHeader:function(){return g.div({id:"modal-table-header"},g.div({id:"modal-path",className:"lfloat",ref:"header_path"},a.em_snippet(this.props.src_path,13,0)),g.div({id:"modal-timestamp",className:"rfloat",ref:"header_timestamp"},this.props.deletionString))},_showEmptyState:function(){return g.div({id:"modal-empty-state",ref:"empty-state"},g.h3({},y("This folder is empty")))},_tableContents:function(){return 0===this.props.items.length?this._showEmptyState():1===this.props.items.length?this._showSingleItemView(this.props.items[0]):this._showListView()},_showSingleItemView:function(e){return t.createElement(f,{icon:e.icon,text:e.name,src_path:e.src_path,size:e.size})},_showListView:function(){var t;return g.div({},function(){var e,n,o,i;for(o=this.props.items,i=[],e=0,n=o.length;n>e;e++)t=o[e],i.push(this._createSingleModalItem(t));return i}.call(this))},_createSingleModalItem:function(e){return t.createElement(_,{icon:e.icon,name:a.em_snippet(e.name,35),size:e.size})},render:function(){return g.div({},this._tableHeader(),g.div({id:"modal-table-contents"},this._tableContents()))}}),v=t.createClass({displayName:"TrashModal",propTypes:{event_data:b.shape({text:b.string.isRequired,src_path:b.string.isRequired,timestamp:b.string.isRequired,deletor:b.string,user_id:b.number.isRequired,ns_id:b.number.isRequired,cs_id:b.number.isRequired,sjids:b.arrayOf(b.number),file_count:b.number,can_rollback:b.bool.isRequired,can_purge:b.bool}),restore_callback:b.func,purge_callback:b.func,type:b.oneOf(["single","group"]).isRequired,with_mixed_cs:b.bool.isRequired},getDefaultProps:function(){return{restore_callback:e.noop,purge_callback:e.noop,type:"group"}},getInitialState:function(){return{items:[],inFlight:!0,error:!1}},componentWillMount:function(){return this._fetchEventDetails()},componentWillUnmount:function(){var t;return null!=(t=this.ajaxRequest)?t.abort():void 0},_fetchEventDetails:function(){var t,n,o,i;return n=function(t){return function(e){var n,o,i,s;return i=JSON.parse(e),"group"===t.props.type&&(i=i.filter(function(e){var n;return n=e.src_path,!(n===t.props.event_data.src_path&&e.name===t.props.event_data.text)}),n=t.props.event_data.file_count,n>100&&(t.props.event_data.can_rollback?(o=t.props.event_data.file_count-100,s=C("And %(num)d more file.","And %(num)d more files.",o).format({num:o})):s=y("To view or restore all %(file_count)d files, visit Event Details page.").format({file_count:n}),i.push({icon:"",name:s,size:""}))),t.setState({inFlight:!1,items:i})}}(this),t=function(t){return function(e){return t._userAborted(e)?void 0:t.setState({inFlight:!1,error:!0})}}(this),this.props.with_mixed_cs?(i={user_id:this.props.event_data.user_id,ns_id:this.props.event_data.ns_id,sjids:e(this.props.event_data.sjids).join(","),page:0},this.ajaxRequest=new d.WebRequest({url:"/trash_details/ajax",type:"POST",data:i,success:n,error:t})):(o={user_id:this.props.event_data.user_id,ns_id:this.props.event_data.ns_id,changeset_id:this.props.event_data.cs_id,page:0},this.ajaxRequest=new d.WebRequest({url:"/event_details/ajax",type:"POST",data:o,success:n,error:t}))},_userAborted:function(t){return!t.getAllResponseHeaders()},_gotoEventDetails:function(){var t,e,o,i;return e=this.props.event_data,i=e.user_id,t=e.cs_id,o=e.ns_id,n.redirect(s({path:"/event_details/"+i+"/"+o+"/"+t+"/0"}))},restoreFiles:function(){var t,e,n;return n=this.props.event_data.user_id,e=this.props.event_data.ns_id,t=this.props.event_data.cs_id,this.props.with_mixed_cs?l.rollback(n,e,t,!0,this.props.restore_callback,this.props.event_data.sjids,this.props.with_mixed_cs):l.rollback(n,e,t,!0,this.props.restore_callback)},purgeFiles:function(){var t,e,n,i;return i=this.props.event_data.user_id,e=this.props.event_data.ns_id,t=this.props.event_data.cs_id,n={},n[e]=this.props.event_data.sjids,d.WebProgressRequest({url:"/cmd/purge_sjids",data:{ns_to_sjids:JSON.stringify(n)},subject_user:i,html_in_error_msg:!0,progress_text:y("Deleting files permanently..."),success:function(t){return function(){return o.success(y("Finished deleting files.")),t.props.purge_callback()}}(this)})},_confirmPurge:function(){var t,n;return t=this.props.event_data.file_count,n=C("Permanently delete %(num)d file?","Permanently delete %(num)d files?",t).format({num:t}),m.show({title_text:n,body_html:y("Are you sure you want to delete <strong>%(filename)s</strong> from your Dropbox permanently?").format({filename:e.escape(this.props.event_data.text)}),confirm_text:y("Delete permanently"),confirm_callback:this.purgeFiles,cancel_text:y("Cancel")})},_getDeletionTimeString:function(){var t,e;return e={timestamp:this.props.event_data.timestamp},this.props.event_data.deletor?(t="single"===this.props.type?25:15,e.deletor=a.em_snippet(this.props.event_data.deletor,t),y("%(deletor)s deleted %(timestamp)s").format(e)):y("You deleted %(timestamp)s").format(e)},_renderError:function(){return g.div({id:"modal-error-state"},g.h3({},y("Oops! An error occurred. Please try again later!")))},_showLoader:function(){return g.div({id:"modal-loading",ref:"loading"},t.createElement(r,{style:r.LoadingIndicatorStyle.BLUE_SPINNER}))},_renderSingleModal:function(){return t.createElement(f,{icon:this.state.items[0].icon,text:this.props.event_data.text,src_path:this.props.event_data.src_path,size:this.state.items[0].size,deletionString:this._getDeletionTimeString()})},_renderGroupModal:function(){return t.createElement(p,{items:this.state.items,src_path:this.props.event_data.src_path,deletionString:this._getDeletionTimeString()})},render:function(){var e,n,o,i,s,r,l;return this.props.event_data.can_rollback?(r=y("group"===this.props.type?"Restore all files":"Restore"),s="primary",n=this.restoreFiles):(r=y("Go to Event Details"),s="secondary",n=this._gotoEventDetails),l=g.div({ref:"content"},g.div({id:"modal-table-container"},this.state.inFlight?this._showLoader():this.state.error?this._renderError():"single"===this.props.type?this._renderSingleModal():this._renderGroupModal())),this.props.with_mixed_cs&&this.props.event_data.can_rollback&&this.props.event_data.can_purge?(o=y("Delete permanently"),i="secondary",e=this._confirmPurge,t.createElement(h,{title:a.em_snippet(y(this.props.event_data.text),30),buttonComponent:g.div({className:"db-modal-buttons"},g.button({className:"dbmodal-button button-secondary",style:{color:"red","border-color":"red","background-color":"white"},onClick:e},o),g.button({className:"dbmodal-button button-primary",onClick:n},r)),setMaxHeight:!0},l)):t.createElement(h,{title:a.em_snippet(y(this.props.event_data.text),30),acceptButtonText:r,dismissButtonText:y("Cancel"),acceptButtonImportance:s,onAccept:n,setMaxHeight:!0},l)}}),{TrashModal:v,SingleModalItem:_,SingleModalView:f,GroupModalView:p}})}.call(this),function(){define("modules/constants/stickers",[],function(){
return window.StickerConstants})}.call(this),function(){var t=[].slice;define("modules/dirty/react/file_comments/file_viewer_feedback_ui",["jquery","external/react","external/react-dom","modules/constants/python","modules/clean/activity/constants","modules/clean/previews/preview_actions_helper","modules/clean/viewer","modules/core/notify","modules/clean/comments/components/file_comments_pane_container","modules/clean/comments/events","require"],function(e,n,o,i,s,r,a,l,c,u,d){var p,h,m,_,f,v;return p=s.ActivityContext,_=r.LegacyFileViewerActions,h=u.CommentsEventsMixin,f=n.DOM,v=a.get_viewer(),m=n.createClass({displayName:"FileViewerFeedbackUI",mixins:[h],propTypes:{shouldShowOnboarding:n.PropTypes.bool},getDefaultProps:function(){return{shouldShowOnboarding:!1}},getInitialState:function(){return this.setCommentsVisibility(!0),{shouldShowOnboarding:this.props.shouldShowOnboarding}},componentDidMount:function(){var t;return this.onCommentsEvent("show-comments-pane",this.setShown),this.onCommentsEvent("hide-comments-pane",this.setHidden),this.onCommentsEvent("switch-revision",this.fluxSwitchRevision),e("#file-viewer").on("db:filepreview:open db:filepreview:fileinfo",function(t){return function(n,o,i,s,r,a,l,c){return e("#file-viewer").addClass("comments"),clearTimeout(t.feedbackLoadTimer),t.feedbackLoadTimer=setTimeout(function(){return t._setFile(o,i,s,!1,c,r,l)},10)}}(this)),e("#file-viewer").trigger("db:commenting:init"),e("#file-viewer").on("db:filepreview:prev db:filepreview:next",function(t){return function(e,n,o,i,s){return clearTimeout(t.feedbackLoadTimer),t.feedbackLoadTimer=setTimeout(function(){return t._setFile(n,o,i,!1,s)},250)}}(this)),e("#file-viewer").on("db:filepreview:close",function(t){return function(e){return t.setState({activityContext:null,activityContextData:null})}}(this)),t=function(t){return function(){return e("#file-viewer").addClass("comments"),t.autoResize()}}(this),e("#file-viewer").on("preview_failed",t),e(window).resize(this.autoResize)},componentDidUpdate:function(t,e){return e.isHidden!==this.state.isHidden?this.autoResize():void 0},fluxSwitchRevision:function(t){var e,n;return n=t.revision,e=t.commentActivity,this._switchPreview(n.preview_link,null,!0)},setShown:function(){return this.setState({isHidden:!1})},setHidden:function(){return this.setState({isHidden:!0})},_getContextAndContextDataFromFile:function(t,e){var n,o;return e===i.FileViewTargetType.SHARED_LINK?(n=p.SHARED_LINK_VIEW,o=t.href):e===i.FileViewTargetType.SHARED_CONTENT_LINK?(n=p.SHARED_CONTENT_LINK_VIEW,o=t.href):(n=p.BROWSE_FILE_VIEWER,o=t.fq_path),[n,o]},_setFile:function(t,e,n,o,s,r,a){var l,c,u,d;return null==o&&(o=!1),null==s&&(s=[]),null==r&&(r=!1),null==a&&(a=i.OREF_CONSTANTS.BROWSE_UNKNOWN),d=this._getContextAndContextDataFromFile(t,e),l=d[0],c=d[1],l===p.SHARED_LINK_VIEW&&(n=v.work_user||v.personal_user?(v.work_user||v.personal_user).id:void 0),u={activityContext:l,activityContextData:c,file:t,key:t.ns_id+"_"+t.sjid,viewingUserId:n,shouldInitiallyFocusInput:r,oref:a},this.setState(u,this.autoResize)},_switchPreview:function(){var e;return e=1<=arguments.length?t.call(arguments,0):[],d(["dropbox"],function(t){var n;return n=t.FileViewer,n.switch_preview.apply(n,e)},function(t){return l.error(l.DEFAULT_ERROR)})},getFileCommentsPaneElement:function(){var t;return null!=(t=this.refs.fluxContainer)?t.refs.fileCommentsPane:void 0},render:function(){return f.div({},n.createElement(c,{ref:"fluxContainer",actorId:this.state.viewingUserId,context:this.state.activityContext,contextData:this.state.activityContextData,currentFile:this.state.file,oref:this.state.oref,previewSelector:"#file-viewer-container .preview .preview-content-container",shouldInitiallyFocusInput:this.state.shouldInitiallyFocusInput,shouldTrackCollapsedState:!0,visible:!0}))},setCommentsVisibility:function(t){return this._commentsVisible=t},autoResize:function(){return this.autoResizeWidth(),this.autoResizeHeight()},autoResizeWidth:function(){return this.setPreviewWidth(e(o.findDOMNode(this.getFileCommentsPaneElement())).width())},autoResizeHeight:function(){var t,n;return t=e("#file-viewer").hasClass("no-preview")?e(window).height():e("#file-viewer-container").height()-e("#file-viewer-container .title-bar").height(),null!=(n=this.getFileCommentsPaneElement())?n.fitToHeight(t):void 0},setPreviewWidth:function(t){var n,o,i,s,r,a;return n=e("#file-viewer"),o=n.find("#file-viewer-container"),s=o.find(".preview"),0!==s.length?(n.hasClass("no-preview")?(a=o.width()-t,r=t?(e(window).width()-t)/2+"px":e(window).width()/2+"px"):n.hasClass("doc-preview")||n.hasClass("html-preview")||n.hasClass("htmlified-preview")||n.hasClass("adobecs-preview")||n.hasClass("linkfile-preview")||n.hasClass("photo-preview")||n.hasClass("video-preview")?(a=_.isFullscreen()?window.innerWidth:o.width()-t,r="0"):(a=o.width()-t,r="50%"),s.width()!==a&&(s.width(a),i=o.find(".loading"),null!=i&&i.width(a)),s.css("left")!==r?o.css("left",r):void 0):void 0}}),{FileViewerFeedbackUI:m}})}.call(this),function(){define("modules/dirty/react/previews/preview_toolbar",["jquery","external/underscore","external/react","modules/core/notify","modules/clean/filepath","modules/clean/previews/preview_actions_helper","modules/clean/react/previews/preview_toolbar","modules/core/exception"],function(t,e,n,o,i,s,r,a){var l,c,u,d,p,h,m,_,f;return c=s.LegacyFileViewerActions,l=s.LegacyFilePreviewActions,h=r.ReactPreviewToolbarClass,d=r.PreviewToolbarDocType,_=a.assert,p=n.createFactory(h),f=function(t){return require(["dropbox"],t,function(){return o.error(o.DEFAULT_ERROR)})},m={FILE_VIEWER:"FILE_VIEWER",FILE_PREVIEW:"FILE_PREVIEW"},u=n.createClass({displayName:"PreviewToolbar",propTypes:{"viewer-type":n.PropTypes.oneOf(e.values(m)).isRequired},getInitialState:function(){var t;return this.props["viewer-type"]===m.FILE_VIEWER?t=c:this.props["viewer-type"]===m.FILE_PREVIEW&&(t=l),{actions:t,fileDocPreviewStatus:null,fileExtension:null,fileHref:null,filePreviewType:null,pdfLink:null}},componentDidMount:function(){return this._listenForFileEvents()},componentDidUpdate:function(){var e,n,o,i;return this.props["viewer-type"]===m.FILE_VIEWER&&(e=t("#file-viewer"),1===e.length&&(e.on("db:filepreview:open",null!=(n=this.refs.reactPreviewToolbar)?n.onPreviewOpen:void 0),e.on("db:filepreview:close",null!=(o=this.refs.reactPreviewToolbar)?o.onPreviewClose:void 0))),null!=(i=this.refs.reactPreviewToolbar)?i.onPreviewOpen():void 0},componentWillUnmount:function(){var e,n,o,i;if(this.props["viewer-type"]===m.FILE_VIEWER){if(e=t("#file-viewer"),1===e.length)return e.off("db:filepreview:open",null!=(n=this.refs.reactPreviewToolbar)?n.onPreviewOpen:void 0),e.off("db:filepreview:close",null!=(o=this.refs.reactPreviewToolbar)?o.onPreviewClose:void 0)}else if(this.props["viewer-type"]===m.FILE_PREVIEW)return null!=(i=this.refs.reactPreviewToolbar)?i.onPreviewClose:void 0},_listenForFileEvents:function(){return this.props["viewer-type"]===m.FILE_VIEWER?t("#file-viewer").on("db:filepreview:open",function(t){return function(e,n){return null!=n.fq_path?t.setState({fileDocPreviewStatus:n.doc_preview_status,fileExtension:i.file_extension_for_logging(n.fq_path),fileHref:n.href,filePreviewType:n.preview_type}):void 0}}(this)):this.props["viewer-type"]===m.FILE_PREVIEW?this.state.actions.getEmbedContainer().on("previewrendered",function(t){return function(){return f(function(e){var n,o;return n=e.FilePreview,o=e.SharingModel,t.setState({pdfLink:n.pdfLink,fileExtension:i.file_extension_for_logging(o.filename)})})}}(this)):void 0},_onAfterFileViewerExit:function(){return f(function(t){var e;return e=t.FileViewer,e.hide()})},render:function(){var t;return this.state.fileExtension?(t=null,this.props["viewer-type"]===m.FILE_VIEWER&&(t=this._onAfterFileViewerExit),n.DOM.div({className:"preview-toolbar-container"},p({ref:"reactPreviewToolbar",actions:this.state.actions,fileExtension:this.state.fileExtension,afterFileViewerExit:t,pdfLink:this.state.pdfLink,fileDocPreviewStatus:this.state.fileDocPreviewStatus,fileHref:this.state.fileHref,filePreviewType:this.state.filePreviewType}))):null}}),{PreviewToolbar:u,ViewerTypes:m}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/dirty/trash/trash",["jquery","dropbox","external/react","external/underscore","modules/core/i18n","modules/core/controller_helpers","modules/core/dom","modules/core/notify","modules/clean/ajax","modules/clean/analytics","modules/clean/trash/trash_modal","modules/clean/em_string","modules/clean/events/rollback","modules/clean/history","modules/clean/multiaccount_login","modules/clean/react/modal"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,_,f){var v,y,g,b,C,w,T,S,A,E,N,I,x,P;return A=n.Util,y=n.DateUtil,S=n.ULSelectMenu,v=n.DBCalendar,I=s._,N=c.WebRequest,E=u.WebMiscActivityLogger,T=d.TrashModal,b=f.Modal,x=o.DOM,P=864e5,C=function(){function t(t){this.ns_id=t,this.earliest=Number.MAX_VALUE,this.events=[],this.seen={},this.done=!1}return t}(),g=function(){function t(t){var n,o,i;this.on_change=t,e(document.body).on("click",function(t){return function(e){return t.hide_calendar(e)}}(this)),i=e("<div/>",{id:"cal_container"}),e(i).bind("click",function(t){return t.preventDefault()}),e(document.body).append(i),this.calendar=new v("cal_container",{onDateChange:function(t){return function(e){return t.on_change(e)}}(this),disable_future:!0}),e(i).css("position","fixed"),o=e("#cal_date"),n=e("#cal_container"),a.clone_position(n,o,{setWidth:!1,setHeight:!1,offsetTop:o.height(),offsetLeft:o.width()-n.children().first()[0].offsetWidth}),this.hide_calendar()}return t.prototype.show_calendar=function(t){return this.shown?(e("#cal_container").hide(),void(this.shown=!1)):(e("#cal_container").show(),this.shown=!0)},t.prototype.hide_calendar=function(t){return t&&e(t.target).closest("#cal_date").length>0?void 0:(e("#cal_container").hide(),this.shown=!1,!0)},t}(),w={latest:Number.MAX_VALUE,now:Number(new Date),timestamp:A.start_of_day(new Date(Number(new Date)+P)),event_data_map:{},with_mixed_cs:!1,change_date:function(t){return this.timestamp=Number(t)+P,(this.timestamp<this.earliest()||this.timestamp>this.latest)&&(this.latest=this.timestamp,this._init_state()),e("#cur_date_text").text(y.localize(t)),this.get_more(!0)},update_calendar_first_day:function(){var t;return t=this.date_picker.calendar,t.options.first_day=A.start_of_day(new Date(i(this.valid_nss()).map(function(t){return function(e){return t.first_event_map[e.ns_id]}}(this)).min())),t.selected_date<t.options.first_day&&(t.selected_date=A.start_of_day(new Date(Number(t.options.first_day)+P)),this.change_date(t.selected_date)),t.render()},is_scrolled_down:function(){var t,n,o;return o=a.scroll_offsets().top,n=a.viewport_dimensions().height,t=e("#trash").height(),o+n+50>=t},valid_roles:function(){return i(this.roles).filter(function(t){return function(e){return e.role===t.role}}(this))},valid_nss:function(){return this.ns?[this.ns]:i(this.valid_roles()).map(function(t){return t.ns_ids}).flatten().map(function(t){return function(e){return t.namespaces[e]}}(this)).uniq()},earliest:function(){return i(this.valid_nss()).map(function(t){return t.earliest}).max()},showFullState:function(){return e("#trash-table").empty(),e("#trash-container").show(),e("#trash-empty-state").hide(),e(".empty-explanation").hide()},showEmptyState:function(){return e("#trash-container").hide(),e("#trash-empty-state").show(),e(".empty-explanation").show(),e("#dfb-banner").hide()},set_url:function(){var t,e,n;return n=new Date(this.timestamp-P),e=this.now-this.timestamp>0,t={},t.role=this.role,this.ns&&(t.ns=this.ns.ns_id),e&&(t.date=n.getDate()+"-"+(n.getMonth()+1)+"-"+n.getFullYear()),m.push_state("/deleted_files",t)},_init_state:function(){var t,e,n,o,s,r,a,l;for(this.namespaces={},r=i(this.roles).values(),t=0,n=r.length;n>t;t++)for(l=r[t],a=l.ns_ids,e=0,o=a.length;o>e;e++)s=a[e],this.namespaces[s]=new C(s);return this.ns?this.ns=this.namespaces[this.ns.ns_id]:void 0},rollback_callback:function(t,e){return E.log("trash-restore",{source:t,with_mixed_cs:e})},purge_callback:function(t,e,n){return E.log("trash-purge",{source:e,with_mixed_cs:n}),this._remove_row_by_pkey(t)},_remove_row_by_pkey:function(t){var n,o,i;return n=this.event_data_map[t],i=this.namespaces[n.ns_id],delete i.seen[t],o=i.events.findIndex(function(e){return e.pkey===t}),this.namespaces[n.ns_id].events.splice(o,1),delete this.event_data_map[t],e("[data-pkey='"+t+"']").remove()},launch_modal:function(t){var n,i,s,r;return s="tr",this.isPagelet&&(s="li"),n=e(t.target).closest(s),r=n.hasClass("group-item")?"group":"single",i=n.data("pkey"),b.showInstance(o.createElement(T,{event_data:this.event_data_map[i],restore_callback:function(t){return function(){return t.rollback_callback("modal",t.with_mixed_cs)}}(this),purge_callback:function(t){return function(){return t.purge_callback(i,"modal",t.with_mixed_cs)}}(this),type:r,with_mixed_cs:this.with_mixed_cs})),E.log("trash-modal-launch",{type:r})},init:function(t,n,o,i,s){var l,c,u,d;return null==o&&(o=null),null==i&&(i=!1),null==s&&(s=!1),this.pageInitiated=!0,this.isPagelet=s,d=m.deconstruct_url(),this.first_event_map=t,this.roles=n,this.with_mixed_cs=i,this.role_picker=r.get_controller(e("#role-selector")),1===this.roles.length?this.role=this.roles[0].role:d.qargs.role?(this.role=d.qargs.role,this.role_picker.set_state(this.role)):o&&(this.role=o),this.date_picker=new g(function(t){return function(e){return t.change_date(e),t.set_url()}}(this)),this._init_state(),e("#cur_date").on("click",function(t){return function(e){return t.date_picker.show_calendar(e),E.log("trash-option-click",{button:"calendar"}),!1}}(this)),this.isPagelet||(this.role_picker.on_state_change=function(t){return function(){return E.log("trash-option-click",{button:"namespace"}),t.role=t.role_picker.get_state(),t.ns&&!t.valid_roles().some(function(e){return e.ns_ids.contains(t.ns.ns_id)})&&(t.ns=null,S.set_selected_by_value(e("#namespace-list")[0],"false")),t.showFullState(),e("#dfb-banner, #empty-upgrade-text").hide(),t.set_url(),t.get_more(!0)}}(this)),_.set_during_login_callback(function(t,e){return window.location.reload()}),u=e("#namespace-list-container")[0],u&&u.observe("db:change",function(t){return function(e){return t.ns=t.namespaces[JSON.parse(e.memo)],t.set_url(),t.get_more(!0)}}(this)),e(window).on("scroll",function(t){return function(){return document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-a.viewport_dimensions().height-10),t.get_more()}}(this)),d.qargs.ns&&(S.set_selected_by_value(e("#namespace-list")[0],d.qargs.ns),this.ns=this.namespaces[d.qargs.ns]),d.qargs.date&&(c=d.qargs.date.split("-").map(Number),l=new Date(c[2],c[1]-1,c[0]),this.date_picker.calendar.selected_date=l,this.change_date(l)),this.update_calendar_first_day(),this.get_more()},get_more:function(t){var n,o,s,r,a;if(!this.request_in_flight)return i(this.valid_nss()).all(function(t){return t.done})?void this.render():t||this.is_scrolled_down()?(this.request_in_flight=!0,this.render(),r=function(t){return function(){return i(t.valid_nss()).map(function(t){return t.ns_id}).join(",")}}(this),s=Math.min(this.earliest(),this.timestamp/1e3,Math.floor(this.now/1e3)),a={page_size:25,ns_ids:r(),timestamp:s,is_pagelet_str:this.isPagelet},n=Number(new Date),o=this.with_mixed_cs?"/deleted_files_with_mixed_cs/ajax":"/deleted_files/ajax",N({url:o,data:a,subject_user:this.valid_roles()[0].user_id,success:function(t){return function(o){var s,a,l,c,u,d,p,m,_,f,v,y,g,b,C,w,T,S;for(E.log("trash-ajax-timer",{time:Number(new Date)-n}),l=JSON.parse(o),t.request_in_flight=!1,y=!1,w=l.events,d=0,_=w.length;_>d;d++)c=w[d],C=c.pkey+" "+(c.html.textContext||c.html.innerText),g=t.namespaces[c.ns_id],g.seen[C]||(y=!0,u={ns_id:c.ns_id,id:c.id},s=e(c.html),u.text=s.find(".deletion-text").text(),u.src_path=s.find(".deletion-path").text(),u.timestamp=s.find(".timestamp").text(),u.deletor=s.find(".deletor-name").text(),a=s.find("button.action-button"),u.user_id=a.data("user-id"),u.cs_id=a.data("cs-id"),u.file_count=a.data("file-count"),u.can_rollback="True"===a.data("can-rollback"),t.with_mixed_cs&&(u.sjids=a.data("sjids"),u.can_purge=a.data("can-purge")===!0),t.event_data_map[c.pkey]=u,c.html=e(c.html)[0],g.events.push(c),g.seen[C]=!0,g.earliest=c.timestamp);if(t.render(),y){for(T=l.ns_ids,p=0,f=T.length;f>p;p++)b=T[p],t.namespaces[b].earliest=i(l.events).map(function(t){return t.timestamp}).min();t.get_more()}else if(i(l.ns_ids).join(",")===!r())t.get_more();else for(S=l.ns_ids,m=0,v=S.length;v>m;m++)b=S[m],t.namespaces[b].done=!0;return t.with_mixed_cs===!1?h.configureAllLinks("#trash-table",".action-button","events",t.with_mixed_cs,function(){return t.rollback_callback("main_page")}):void 0}}(this),error:function(t){return function(e,n,o){return t.request_in_flight=!1,"abort"!==n?l.error(I("We had problems loading your deleted files; please try again later.")):void 0}}(this)})):void this.render()},render:function(){var n,o,s,r,a,l,c,u,d,h,m,_,f,v,y,g,b,C,w,T,S,A;if(this.update_calendar_first_day(),s=i(this.valid_nss()).map(function(t){return t.events}).flatten(),r=this.earliest(),w=i(s).sortBy(function(t){return-t.timestamp}),a=i(w).filter(function(t){return function(e){return e.timestamp>=r&&e.timestamp<t.timestamp/1e3&&(t.ns===!0||!e.is_dup)}}(this)),T=function(t){return function(){return t.valid_roles().some(function(t){return t.is_team_or_pro})?e("#dfb-banner, #empty-upgrade-text").hide():e("#dfb-banner, #empty-upgrade-text").show()}}(this),a.length)for(this.showFullState(),l=0,d=a.length;d>l;l++)b=a[l],n=e(b.html),o=function(t,e,o){var i;return i=n.find(t).text(),n.find(t).text(p.em_snippet(i,e,o))},o(".deletor-name",12),o(".deletion-path",34,0),o(".deletion-text",34),f=n.data("pkey"),this.event_data_map[f].src_path||(m="Dropbox",this.event_data_map[f].src_path=m,n.find(".deletion-path").text(m)),(n.hasClass("group-item")||n.hasClass("single-item"))&&n.on("click",this.launch_modal.bind(this)),e("#trash-table").append(n);else this.request_in_flight||this.showEmptyState();for(T(),this.request_in_flight?e("#more-loading").show():(e("#more-loading").hide(),this.pageInitiated&&(this.pageInitiated=!1,E.log("trash-first-load",{time:Number(new Date)-this.now}))),v=e("#namespace-list > li"),u=0,h=v.length;h>u;u++)c=v[u],S=e(c).data("value"),g=t.call(i(this.valid_roles()).map(function(t){return t.ns_ids}).flatten(),S)>=0,_=S===!1,A=_||g,e(c).css("display",A?"":"none");return C=t.call(function(){var t,e,n,o;for(n=this.valid_roles(),o=[],t=0,e=n.length;e>t;t++)y=n[t],o.push(y.ns_ids.length>1);return o}.call(this),!0)>=0,this.request_in_flight?void 0:C?(e("#namespace-list-container").css("visibility","visible"),e("#namespace-list-container").show()):e("#namespace-list-container").hide()}}})}.call(this);
//# sourceMappingURL=pkg-ac.min.js-vflqY91LJ.map